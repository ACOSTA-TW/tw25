<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>THE WAY - Gestão Completa</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Fontes Google -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- Ícones Phosphor -->
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  <!-- Chart.js para Gráficos -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- jsPDF para exportar PDFs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
  <style>
    :root {
      --color-primary: #C8B89C; /* Bege Principal */
      --color-primary-dark: #B5A589;
      --color-secondary: #212529; /* Preto */
      --color-background: #F8F7F4; /* Bege muito claro / Fundo */
      --color-surface: #FFFFFF; /* Branco */
      --color-text-primary: #212529; /* Preto */
      --color-text-secondary: #6B7280; /* Cinza para texto secundário */
      --color-border: #E5E7EB;
      --color-danger: #EF4444;
      --color-success: #10B981;
      --color-warning: #F59E0B;
      --color-accent: #CAD2D8; /* Cinza Azulado Claro */
    }
    body {
      margin: 0;
      background: var(--color-background);
      font-family: 'Poppins', Arial, sans-serif;
      color: var(--color-text-primary);
      font-size: 15px;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    .sidebar {
      position: fixed; left: 0; top: 0; bottom: 0;
      width: 250px; background: var(--color-surface); color: var(--color-text-primary);
      padding: 1.5em; box-shadow: 2px 0 25px #0000000a;
      display: flex; flex-direction: column; z-index: 100;
      box-sizing: border-box;
      border-right: 1px solid var(--color-border);
    }
    .sidebar .logo-box { text-align: center; margin: 1.5em 0 2.5em;}
    .logo {
      font-size: 1.8em;
      font-weight: 700;
      color: var(--color-primary);
    }
    .sidebar nav {
      flex: 1 1 auto; display: flex; flex-direction: column;
      gap: .7em; margin-top: .5em;
    }
    .sidebar nav button {
      background: none; border: none; color: var(--color-text-secondary);
      font-size: 1em; font-weight: 500; text-align: left;
      padding: .9em 1.2em; border-radius: 8px; cursor: pointer;
      transition: background .2s, color .2s, transform .2s;
      letter-spacing: .02em;
      display: flex; align-items: center; gap: .8em;
    }
    .sidebar nav button i { font-size: 1.4em; }
    .sidebar nav button.active,
    .sidebar nav button:hover {
      background: var(--color-primary);
      color: var(--color-surface);
      transform: translateX(5px);
    }
    .logout-btn {
      background: var(--color-danger); color: var(--color-surface);
      border: none; border-radius: 8px;
      padding: .8em 1.7em; font-weight: 600;
      margin: 1.5em 0 .5em 0; display: block;
      cursor: pointer; font-size: 1em;
      transition: background .16s;
      width: 100%;
    }
    .logout-btn:hover { background: #D93737; }
    .main-container { margin-left: 250px; padding: 2.5em; }
    .main-content { display: none; }
    .main-content.active { display: block; animation: fadeIn .5s; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    
    .section-header {
        display: flex; justify-content: space-between; align-items: center;
        margin-bottom: 2em; flex-wrap: wrap; gap: 1em;
    }
    .section-header h2 {
        margin: 0; font-size: 2em; font-weight: 700; display: flex; align-items: center; gap: .5em;
    }
    .header-actions { display: flex; gap: 1em; align-items: center; }
    .search-bar, .filter-bar select, .filter-bar input, .filter-bar .btn-secondary {
        padding: .8em 1.2em; border-radius: 8px; border: 1.5px solid var(--color-border);
        font-size: 1em; background: var(--color-surface);
        transition: border-color .2s, box-shadow .2s;
    }
     .search-bar, .filter-bar select, .filter-bar input {
        width: 250px;
     }
    .search-bar:focus, .filter-bar select:focus, .filter-bar input:focus {
        outline: none;
        border-color: var(--color-primary);
        box-shadow: 0 0 0 3px rgba(200, 184, 156, 0.2);
    }
    .btn-primary {
        background: var(--color-primary); color: var(--color-surface);
        border: none; padding: .9em 1.6em; border-radius: 8px;
        font-weight: 600; font-size: 1em; cursor: pointer;
        transition: background .2s, transform .2s; display: flex; align-items: center; gap: .5em;
        box-shadow: 0 4px 12px rgba(200, 184, 156, 0.3);
    }
    .btn-primary:hover { background: var(--color-primary-dark); transform: translateY(-2px); }
    
    /* Table Styles */
    .table-container {
        background: var(--color-surface); border-radius: 12px;
        padding: 1em; box-shadow: 0 4px 25px #0000000a;
        overflow-x: auto;
    }
    .data-table { width: 100%; border-collapse: collapse; }
    .data-table th, .data-table td {
        padding: 1.1em 1.2em; text-align: left;
        border-bottom: 1px solid var(--color-border); vertical-align: middle;
    }
    .data-table th {
        font-weight: 600; font-size: .8em; color: var(--color-text-secondary);
        text-transform: uppercase; letter-spacing: .08em;
    }
    .data-table td { font-size: .95em; }
    .data-table tbody tr:hover { background-color: #F9FAFB; }
    .data-table tbody tr:last-child td { border-bottom: none; }
    .actions-cell { white-space: nowrap; text-align: right; }
    .actions-cell button {
      background: none; border: none; cursor: pointer;
      padding: .5em; color: var(--color-text-secondary); transition: color .2s, transform .2s;
    }
    .actions-cell button:hover { color: var(--color-primary); transform: scale(1.1); }
    .actions-cell button.btn-danger:hover { color: var(--color-danger); }
    .actions-cell i { font-size: 1.4em; }

    /* Modal Styles */
    .modal-overlay {
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(17, 24, 39, 0.6); display: none;
        align-items: center; justify-content: center;
        z-index: 1000; padding: 1em; backdrop-filter: blur(4px);
    }
    .modal-overlay.active { display: flex; animation: fadeIn .3s; }
    .modal-box {
        background: var(--color-surface); padding: 2.5em;
        border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        width: 100%; max-width: 800px;
        max-height: 90vh; overflow-y: auto;
        transform: scale(0.95); opacity: 0;
        transition: transform .3s ease, opacity .3s ease;
    }
    .modal-overlay.active .modal-box { transform: scale(1); opacity: 1; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5em; }
    .modal-header h3 { margin: 0; font-size: 1.6em; font-weight: 600; }
    .modal-header .close-btn { background: #F3F4F6; border: none; font-size: 1.5em; cursor: pointer; color: var(--color-text-secondary); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: background .2s, color .2s; }
    .modal-header .close-btn:hover { background: #E5E7EB; color: var(--color-text-primary); }
    .modal-body .row {display:flex; flex-wrap: wrap; gap:1.5em;}
    .modal-body .col {flex:1; min-width: 250px;}
    .modal-body label {font-weight:600;display:block;margin-bottom:.5em; font-size: .9em;}
    .modal-body input, .modal-body select, .modal-body textarea {
      width: 100%; padding: .9em 1em; border-radius: 8px;
      border: 1.5px solid var(--color-border); font-size: 1em;
      margin-bottom: 1.2em; background: var(--color-background);
      color: var(--color-text-primary); transition: border .16s, box-shadow .16s;
      box-sizing: border-box;
    }
    .modal-body input:focus, .modal-body select:focus, .modal-body textarea:focus {
        outline: none;
        border-color: var(--color-primary);
        box-shadow: 0 0 0 3px rgba(200, 184, 156, 0.2);
    }
    .modal-footer { margin-top: 2em; display: flex; justify-content: flex-end; gap: 1em; }
    .modal-footer button { padding: .9em 2.2em; }
    .modal-footer .btn-secondary, .btn-secondary { background: var(--color-border); color: var(--color-text-primary); box-shadow: none; }
    .modal-footer .btn-secondary:hover, .btn-secondary:hover { background: #D1D5DB; }
    
    /* Dashboard & Reports Styles */
    .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1.5em; margin-bottom: 2em; }
    .kpi-card { background: var(--color-surface); border-radius: 12px; padding: 1.5em; box-shadow: 0 4px 25px #0000000a; transition: transform .2s, box-shadow .2s; }
    .kpi-card:hover { transform: translateY(-5px); box-shadow: 0 8px 30px #0000000f; }
    .kpi-card .title { font-size: .9em; color: var(--color-text-secondary); margin-bottom: .5em; font-weight: 500;}
    .kpi-card .value { font-size: 2.4em; font-weight: 700; }
    .kpi-card .subtitle { font-size: .8em; color: var(--color-success); }
    .dashboard-grid, .reports-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5em; margin-bottom: 2em; }
    .chart-container, .tasks-container, .report-widget, .document-tracking-container, .renewals-container { background: var(--color-surface); border-radius: 12px; padding: 1.5em; box-shadow: 0 4px 25px #0000000a; }
    
    /* Login Styles */
    #login-container {
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: var(--color-background);
        display: flex; align-items: center; justify-content: center; z-index: 2000;
    }
    #login-section {
        background: var(--color-surface); padding: 3em; border-radius: 15px;
        box-shadow: 0 10px 40px #0000001a; width: 100%; max-width: 400px; text-align: center;
    }
    #login-section h2 { font-size: 2em; margin-bottom: 1.5em; }
    #login-section label { display: none; }
    #login-section input {
        width: 100%; padding: 1em; margin-bottom: 1em; box-sizing: border-box;
        border-radius: 8px; border: 1.5px solid var(--color-border); font-size: 1em;
    }
    
    /* Toast Notification Styles */
    #toast-container {
        position: fixed;
        bottom: 2em;
        right: 2em;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        gap: 1em;
    }
    .toast {
        padding: 1em 1.5em;
        border-radius: 8px;
        color: #fff;
        font-weight: 500;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        opacity: 0;
        transform: translateX(100%);
        transition: opacity .4s ease, transform .4s ease;
    }
    .toast.show {
        opacity: 1;
        transform: translateX(0);
    }
    .toast.success { background-color: var(--color-success); }
    .toast.error { background-color: var(--color-danger); }
    .toast.info { background-color: var(--color-secondary); }

    /* Outros estilos específicos... */
    #detailsModalBody .details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2em; }
    #detailsModalBody h4 { margin-top: 1.5em; margin-bottom: .5em; border-bottom: 1px solid var(--color-border); padding-bottom: .5em; }
    #interactionHistory, #contractInteractionHistory, #partnerInteractionHistory { max-height: 200px; overflow-y: auto; border: 1px solid var(--color-border); border-radius: 8px; padding: 1em; background: #F9FAFB; }
    .interaction-item { border-bottom: 1px solid var(--color-border); padding: .8em 0; }
    .interaction-item:last-child { border-bottom: none; }
    .interaction-item .date { font-size: .8em; color: var(--color-text-secondary); margin-bottom: .3em; }
    #documentList { list-style: none; padding: 0; margin-top: 1em; max-height: 200px; overflow-y: auto; }
    #documentList li, #movimentosList li { display: flex; justify-content: space-between; align-items: center; padding: .7em .5em; border-radius: 6px; transition: background-color .2s; }
    #documentList li:hover, #movimentosList li:hover { background-color: var(--color-background); }
    #documentList a, #movimentosList a { text-decoration: none; color: var(--color-primary); font-weight: 500; display: flex; align-items: center; gap: .5em;}
    .tabs { display: flex; border-bottom: 2px solid var(--color-border); margin-bottom: 1.5em; }
    .tabs button { background: none; border: none; padding: 1em 1.5em; cursor: pointer; font-size: 1em; font-weight: 600; color: var(--color-text-secondary); border-bottom: 3px solid transparent; margin-bottom: -2px; }
    .tabs button.active { color: var(--color-primary); border-bottom-color: var(--color-primary); }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .service-details, .credit-type-details { display: none; margin-top: 1.5em; border-top: 1px solid var(--color-border); padding-top: 1.5em; }
    .tasks-list .task-item, .renewals-list .renewal-item { display: flex; justify-content: space-between; align-items: center; padding: .8em 0; border-bottom: 1px solid var(--color-border); }
    .tasks-list .task-item:hover, .renewals-list .renewal-item:hover { background-color: var(--color-background); }
    .tasks-list .task-item:last-child, .renewals-list .renewal-item:last-child { border-bottom: none; }
    .task-item .title, .renewal-item .title { font-weight: 600; }
    .task-item .deadline, .renewal-item .deadline { font-size: .9em; color: var(--color-danger); }
    .task-item .urgency-indicator { font-size: 1.5em; color: var(--color-warning); }
    .filter-bar { display: flex; flex-wrap: wrap; gap: 1.5em; margin-bottom: 1.5em; background: var(--color-surface); padding: 1.5em; border-radius: 12px; align-items: flex-end; }
    .filter-bar > div { display: flex; flex-direction: column; gap: .5em; }
    .filter-bar label { font-size: .85em; font-weight: 500; color: var(--color-text-secondary); }
    .doc-tracking-item summary { font-weight: 600; cursor: pointer; padding: .8em; border-radius: 8px; transition: background-color .2s; display: flex; justify-content: space-between; }
    .doc-tracking-item summary:hover { background-color: var(--color-background); }
    .doc-tracking-item[open] summary { background-color: var(--color-background); }
    .doc-tracking-body { padding: 1em; display: grid; grid-template-columns: 1fr 1fr; gap: 1.5em; }
    .doc-tracking-body h5 { margin: 0 0 .5em 0; font-size: .9em; display: flex; align-items: center; gap: .5em; }
    .doc-tracking-body input[type="date"] { padding: .5em; font-size: .9em; margin-bottom: 1em; }
    .doc-tracking-body .checklist { font-size: .9em; display: flex; flex-direction: column; gap: .5em; }
    .doc-tracking-body .checklist label { font-weight: 400; }
    #milestonesList .milestone-item { display: flex; align-items: center; gap: .8em; padding: .5em 0;}
    #milestonesList .milestone-item label { margin-bottom: 0; font-weight: 500; }
    #milestonesList .milestone-item.completed label { text-decoration: line-through; color: var(--color-text-secondary); }
    #upload-form { margin-top: 1em; display: flex; gap: 1em; }
    #upload-form input[type="file"] { flex-grow: 1; }
    #upload-progress { width: 100%; margin-top: .5em; display: none; }
    
    /* Estilos para Relatórios */
    .report-card {
        background: var(--color-surface);
        border-radius: 12px;
        padding: 2em;
        margin-bottom: 1.5em;
        box-shadow: 0 4px 25px #0000000a;
    }
    .report-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5em;
        border-bottom: 1px solid var(--color-border);
        padding-bottom: 1em;
    }
    .report-card-header h4 {
        margin: 0;
        font-size: 1.4em;
    }
    .report-card-body {
        min-height: 100px;
    }
    #freelancer-search-container {
        display: none;
        margin-top: 1em;
    }

    @media(max-width:1200px){
        .dashboard-grid, .reports-grid { grid-template-columns: 1fr; }
    }
    @media(max-width:900px){
      .main-container {margin-left:0; padding: 1em; padding-bottom: 80px;}
      #detailsModalBody .details-grid { grid-template-columns: 1fr; }
      .doc-tracking-body { grid-template-columns: 1fr; }
      .sidebar {
          position: fixed; bottom: 0; top: auto; width: 100%; height: auto;
          flex-direction:row; align-items:center; gap: .5em;
          flex-wrap: nowrap; overflow-x: auto; padding: .5em;
          border-top: 1px solid var(--color-border); background: var(--color-surface);
      }
      .sidebar .logo-box { display: none; }
      .sidebar nav{ flex-direction:row; justify-content: space-around; width: 100%;}
      .sidebar nav button { flex-direction: column; gap: .2em; font-size: .8em; padding: .5em; flex: 1; justify-content: center;}
      .sidebar nav button span { font-size: .9em; }
      .sidebar nav button i { font-size: 1.5em; }
      .logout-btn { display: none; }
    }
  </style>
</head>
<body>

  <!-- ECRÃ DE LOGIN -->
  <div id="login-container">
    <div id="login-section">
      <div class="logo">THE WAY</div>
      <form id="loginForm">
        <label for="email">Email</label>
        <input class="input" type="email" id="email" required placeholder="Email" />
        <label for="password">Password</label>
        <input class="input" type="password" id="password" required minlength="6" placeholder="Password" />
        <button type="submit" class="btn-primary" style="width: 100%; margin-top: 1em;">Entrar</button>
      </form>
      <div id="loginError" style="color: var(--color-danger); margin-top:1em; text-align: center; font-weight: 500;"></div>
    </div>
  </div>

  <!-- ESTRUTURA PRINCIPAL (escondida até ao login) -->
  <div id="app-container" style="display: none;">
    <div class="sidebar">
      <div class="logo-box">
        <div class="logo">THE WAY</div>
      </div>
      <nav>
        <button id="nav-dashboard" onclick="showSection('dashboard')"><i class="ph-fill ph-squares-four"></i> <span>Dashboard</span></button>
        <button id="nav-clientes" onclick="showSection('clientes')"><i class="ph-fill ph-users"></i> <span>Clientes</span></button>
        <button id="nav-contratos" onclick="showSection('contratos')"><i class="ph-fill ph-file-text"></i> <span>Contratos</span></button>
        <button id="nav-parceiros" onclick="showSection('parceiros')"><i class="ph-fill ph-handshake"></i> <span>Parceiros</span></button>
        <button id="nav-tarefas" onclick="showSection('tarefas')"><i class="ph-fill ph-list-checks"></i> <span>Tarefas</span></button>
        <button id="nav-comercial" onclick="showSection('comercial')"><i class="ph-fill ph-briefcase"></i> <span>Equipa</span></button>
        <button id="nav-financeira" onclick="showSection('financeira')"><i class="ph-fill ph-bank"></i> <span>Financeiro</span></button>
        <button id="nav-relatorios" onclick="showSection('relatorios')"><i class="ph-fill ph-chart-bar"></i> <span>Relatórios</span></button>
      </nav>
      <button id="logoutBtn" class="logout-btn">Terminar Sessão</button>
    </div>

    <div class="main-container">
       <!-- Dashboard -->
      <div id="dashboard-section" class="main-content">
          <div class="section-header">
              <h2>Dashboard</h2>
              <div id="dashboard-update-time"></div>
          </div>
          <div class="kpi-grid">
              <div class="kpi-card">
                  <div class="title">Volume Total Crédito</div>
                  <div class="value" id="kpi-credit-volume">€0</div>
                  <div class="subtitle" id="kpi-credit-subtitle">+0% vs mês anterior</div>
              </div>
              <div class="kpi-card">
                  <div class="title">Comissões a Receber (Mês)</div>
                  <div class="value" id="kpi-monthly-commissions">€0</div>
                  <div class="subtitle">Baseado em renovações</div>
              </div>
              <div class="kpi-card">
                  <div class="title">Prémio Comercial (Mês)</div>
                  <div class="value" id="kpi-monthly-premium">€0</div>
                  <div class="subtitle">Total de prémios de seguros</div>
              </div>
              <div class="kpi-card">
                  <div class="title">Pendentes Ativos</div>
                  <div class="value" id="kpi-pending-tasks">0</div>
                  <div class="subtitle" style="color: var(--color-danger)">Requer atenção imediata</div>
              </div>
          </div>

          <div class="document-tracking-container" style="margin-bottom: 2em;">
              <h4>Controlo de Documentos de Crédito</h4>
              <div id="documentTrackingList"></div>
          </div>

          <div class="dashboard-grid">
              <div class="chart-container">
                  <h4>Volume de Crédito Mensal</h4>
                  <canvas id="creditChart"></canvas>
              </div>
              <div class="renewals-container">
                  <h4>Renovações de Seguros (Este Mês)</h4>
                  <div id="dashboardRenewalsList" class="renewals-list"></div>
              </div>
          </div>
          <div class="dashboard-grid" style="grid-template-columns: 1fr;">
               <div class="tasks-container">
                  <h4>Tarefas Urgentes</h4>
                  <div id="dashboardTasksList" class="tasks-list"></div>
              </div>
          </div>
      </div>

      <!-- Clientes -->
      <div id="clientes-section" class="main-content">
        <div class="section-header">
          <h2><i class="ph ph-users"></i>Gestão de Clientes</h2>
          <div class="header-actions">
            <input type="search" id="search-clientes" class="search-bar" placeholder="Pesquisar por Nome ou NIF...">
            <button class="btn-primary" onclick="openFormModal('cliente')"><i class="ph ph-plus"></i> Adicionar Novo</button>
          </div>
        </div>
        <div class="table-container">
            <table class="data-table" id="clientTable">
                <thead><tr><th>Nome</th><th>NIF</th><th>Comercial</th><th>RGPD</th><th>Ações</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
      </div>
      
      <!-- Contratos -->
      <div id="contratos-section" class="main-content">
        <div class="section-header">
          <h2><i class="ph ph-file-text"></i>Gestão de Contratos</h2>
          <div class="header-actions">
            <input type="search" id="search-contratos" class="search-bar" placeholder="Pesquisar por Cliente, Tipo...">
            <button class="btn-primary" onclick="openFormModal('contrato')"><i class="ph ph-plus"></i> Adicionar Novo</button>
          </div>
        </div>
        <div class="table-container">
            <table class="data-table" id="contractTable">
                <thead><tr><th>Cliente</th><th>Tipo</th><th>Valor</th><th>Fase</th><th>Data de Início</th><th>Comercial</th><th>Ações</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
      </div>

      <!-- Tarefas -->
       <div id="tarefas-section" class="main-content">
        <div class="section-header">
          <h2><i class="ph ph-list-checks"></i>Tarefas / Pendentes</h2>
          <div class="header-actions">
            <button class="btn-primary" onclick="openFormModal('tarefa')"><i class="ph ph-plus"></i> Adicionar Nova Tarefa</button>
          </div>
        </div>
        <div class="table-container">
            <table class="data-table" id="tasksTable">
                <thead><tr><th>Título</th><th>Responsável</th><th>Prazo</th><th>Prioridade</th><th>Estado</th><th>Ações</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
      </div>

      <!-- Parceiros -->
      <div id="parceiros-section" class="main-content">
          <div class="section-header">
              <h2><i class="ph ph-handshake"></i>Parceiros</h2>
          </div>
          <div class="tabs">
              <button class="active" onclick="openPartnerTab(event, 'fornecedores')">Fornecedores</button>
              <button onclick="openPartnerTab(event, 'financeiras')">Financeiras</button>
              <button onclick="openPartnerTab(event, 'seguradoras')">Seguradoras</button>
          </div>

          <div id="fornecedores" class="tab-content active">
              <div class="header-actions" style="margin-bottom: 1.5em; justify-content: flex-end;">
                  <button class="btn-primary" onclick="openFormModal('fornecedor')"><i class="ph ph-plus"></i> Adicionar Fornecedor</button>
              </div>
              <div class="table-container">
                  <table class="data-table" id="fornecedoresTable">
                      <thead><tr><th>Nome</th><th>Equipamento</th><th>Contacto</th><th>Email</th><th>Ações</th></tr></thead>
                      <tbody></tbody>
                  </table>
              </div>
          </div>
          <div id="financeiras" class="tab-content">
              <div class="header-actions" style="margin-bottom: 1.5em; justify-content: flex-end;">
                  <button class="btn-primary" onclick="openFormModal('financeira')"><i class="ph ph-plus"></i> Adicionar Financeira</button>
              </div>
               <div class="table-container">
                  <table class="data-table" id="financeirasTable">
                      <thead><tr><th>Nome</th><th>Nome Comercial</th><th>Contacto</th><th>Email Comercial</th><th>Email Comissões</th><th>Ações</th></tr></thead>
                      <tbody></tbody>
                  </table>
              </div>
          </div>
          <div id="seguradoras" class="tab-content">
               <div class="header-actions" style="margin-bottom: 1.5em; justify-content: flex-end;">
                  <button class="btn-primary" onclick="openFormModal('seguradora')"><i class="ph ph-plus"></i> Adicionar Seguradora</button>
              </div>
              <div class="table-container">
                  <table class="data-table" id="seguradorasTable">
                      <thead><tr><th>Nome</th><th>Nome Comercial</th><th>Contacto</th><th>Email Comercial</th><th>Ações</th></tr></thead>
                      <tbody></tbody>
                  </table>
              </div>
          </div>
      </div>
      
      <!-- Gestão Comercial -->
      <div id="comercial-section" class="main-content">
        <div class="section-header">
          <h2><i class="ph ph-briefcase"></i>Gestão de Equipa</h2>
          <div class="header-actions">
            <button class="btn-primary" onclick="openFormModal('comercial')"><i class="ph ph-plus"></i> Adicionar Comercial</button>
          </div>
        </div>
        <div class="table-container">
            <table class="data-table" id="comerciaisTable">
                <thead><tr><th>Nome</th><th>Email</th><th>Telefone</th><th>Função</th><th>Estado</th><th>Ações</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
      </div>
      
      <!-- Gestão Financeira -->
      <div id="financeira-section" class="main-content">
        <div class="section-header">
          <h2><i class="ph ph-bank"></i>Gestão Financeira</h2>
        </div>
        <div class="tabs" id="finance-tabs">
            <button class="active" onclick="openFinanceTab(event, 'financeira-dashboard')">Dashboard Mensal</button>
            <button onclick="openFinanceTab(event, 'financeira-comissoes')">Comissões e Ganhos</button>
            <button onclick="openFinanceTab(event, 'financeira-despesas')">Despesas</button>
            <button onclick="openFinanceTab(event, 'financeira-por-conciliar')">Por Conciliar</button>
            <button onclick="openFinanceTab(event, 'financeira-banco')">Contas Bancárias</button>
        </div>

        <div id="financeira-dashboard" class="tab-content active">
            <div class="kpi-grid">
                 <div class="kpi-card">
                    <div class="title">Comissões Crédito (Mês)</div>
                    <div class="value" id="kpi-comissoes-credito">€0.00</div>
                </div>
                <div class="kpi-card">
                    <div class="title">Comissões Seguros (Mês)</div>
                    <div class="value" id="kpi-comissoes-seguros">€0.00</div>
                </div>
                 <div class="kpi-card">
                    <div class="title">Outros Ganhos (Mês)</div>
                    <div class="value" id="kpi-outros-ganhos">€0.00</div>
                </div>
                <div class="kpi-card">
                    <div class="title">Total Despesas (Mês)</div>
                    <div class="value" id="kpi-total-despesas">€0.00</div>
                </div>
            </div>
            <div class="reports-grid">
                <div class="report-widget">
                    <h4>A Receber das Financeiras (Mês)</h4>
                    <table class="data-table" id="financeirasReceberTable">
                        <thead><tr><th>Financeira</th><th>Valor a Receber</th></tr></thead>
                        <tbody><tr><td colspan="2">A calcular...</td></tr></tbody>
                    </table>
                </div>
                <div class="report-widget">
                    <h4>A Pagar a Fornecedores (Mês)</h4>
                    <table class="data-table" id="fornecedoresPagarTable">
                        <thead><tr><th>Fornecedor</th><th>Valor a Pagar</th></tr></thead>
                        <tbody><tr><td colspan="2">A calcular...</td></tr></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div id="financeira-comissoes" class="tab-content">
            <div class="tabs">
                <button class="active" onclick="openComissaoSubTab(event, 'comissoes-contratos')">Comissões de Contratos</button>
                <button onclick="openComissaoSubTab(event, 'comissoes-outros-ganhos')">Outros Ganhos</button>
            </div>

            <div id="comissoes-contratos" class="tab-content active">
                <div class="header-actions" style="margin-bottom: 1.5em; justify-content: flex-end;">
                    <button class="btn-primary" onclick="openComissaoModal()"><i class="ph ph-check-circle"></i> Liquidar Comissões</button>
                </div>
                <div class="table-container">
                    <table class="data-table" id="comissoesTable">
                        <thead><tr><th><input type="checkbox" onchange="toggleAllComissoes(this.checked)"></th><th>Paga por</th><th>Mês Referência</th><th>Nº Contratos</th><th>Valor Total</th><th>Estado</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div id="comissoes-outros-ganhos" class="tab-content">
                <div class="header-actions" style="margin-bottom: 1.5em; justify-content: flex-end;">
                    <button class="btn-primary" onclick="openFormModal('ganho')"><i class="ph ph-plus"></i> Adicionar Ganho</button>
                </div>
                <div class="table-container">
                    <table class="data-table" id="outrosGanhosTable">
                        <thead><tr><th>Data</th><th>Descrição</th><th>Parceiro</th><th>Valor Bruto</th><th>Retenção</th><th>Valor Líquido</th><th>Ações</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="financeira-despesas" class="tab-content">
            <div class="header-actions" style="margin-bottom: 1.5em; justify-content: flex-end;">
                <button class="btn-primary" onclick="openFormModal('despesa')"><i class="ph ph-plus"></i> Adicionar Despesa</button>
            </div>
            <div class="table-container">
                <table class="data-table" id="despesasTable">
                    <thead><tr><th>Data</th><th>Descrição</th><th>Tipo</th><th>Banco</th><th>Valor</th><th>Conciliada</th><th>Ações</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        
        <div id="financeira-por-conciliar" class="tab-content">
            <div class="header-actions" style="margin-bottom: 1.5em; justify-content: space-between; align-items: center;">
                <h3>Despesas por Conciliar</h3>
                <div class="header-actions">
                    <button class="btn-primary" onclick="openConciliarModal()"><i class="ph ph-check-square"></i> Conciliar Selecionadas</button>
                </div>
            </div>
            <div class="table-container">
                <table class="data-table" id="porConciliarTable">
                    <thead><tr><th><input type="checkbox" onchange="toggleAllConciliar(this.checked)"></th><th>Data</th><th>Descrição</th><th>Tipo</th><th>Valor</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        
        <div id="financeira-banco" class="tab-content">
             <div class="tabs">
                <button class="active" onclick="openBancoSubTab(event, 'contas')">Contas</button>
                <button onclick="openBancoSubTab(event, 'movimentos')">Movimentos</button>
            </div>
            <div id="contas" class="tab-content active">
                <div class="header-actions" style="margin-bottom: 1.5em; justify-content: flex-end;">
                    <button class="btn-primary" onclick="openFormModal('banco')"><i class="ph ph-plus"></i> Adicionar Conta</button>
                </div>
                <div class="table-container">
                    <table class="data-table" id="bancosTable">
                        <thead><tr><th>Nome do Banco</th><th>IBAN</th><th>Saldo</th><th>Estado</th><th>Ações</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            <div id="movimentos" class="tab-content">
                <div class="table-container">
                    <table class="data-table" id="movimentosTable">
                      <thead><tr><th>Data</th><th>Descrição</th><th>Valor</th><th>Tipo</th><th>Ações</th></tr></thead>
                      <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
      </div>
      
      <!-- Relatórios -->
      <div id="relatorios-section" class="main-content">
        <div class="section-header">
            <h2><i class="ph ph-chart-bar"></i>Relatórios</h2>
        </div>

        <div class="filter-bar">
            <div>
                <label>Período de Tempo</label>
                <div style="display: flex; gap: 1em;">
                    <input type="date" id="filter-start-date" style="width: auto;">
                    <input type="date" id="filter-end-date" style="width: auto;">
                </div>
            </div>
            <div>
                <label>Comercial</label>
                <select id="filter-comercial"></select>
            </div>
            <div>
                <label>Fornecedor</label>
                <select id="filter-fornecedor"></select>
            </div>
            <div>
                <label>Financeira</label>
                <select id="filter-financeira"></select>
            </div>
            <div>
                <button class="btn-primary" onclick="generateReports()"><i class="ph ph-funnel"></i> Filtrar</button>
                <button class="btn-secondary" onclick="clearReportFilters()">Limpar</button>
            </div>
        </div>

        <div id="reports-container">
            <!-- Carta de Comissão -->
            <div class="report-card">
                <div class="report-card-header">
                    <h4>Carta de Comissão</h4>
                    <button class="btn-primary" onclick="exportPdf('comissao')"><i class="ph ph-file-pdf"></i> Exportar PDF</button>
                </div>
                <div class="report-card-body" id="report-comissao">
                    <p>Selecione os filtros e clique em "Filtrar" para gerar o relatório.</p>
                </div>
            </div>

            <!-- Mapa de Produção Interno -->
            <div class="report-card">
                <div class="report-card-header">
                    <h4>Mapa de Produção Interno</h4>
                    <button class="btn-primary" onclick="exportPdf('producao-interno')"><i class="ph ph-file-pdf"></i> Exportar PDF</button>
                </div>
                <div class="report-card-body" id="report-producao-interno">
                     <p>Selecione os filtros e clique em "Filtrar" para gerar o relatório.</p>
                </div>
            </div>

            <!-- Carta de Pendentes -->
            <div class="report-card">
                <div class="report-card-header">
                    <h4>Carta de Pendentes</h4>
                    <button class="btn-primary" onclick="exportPdf('pendentes')"><i class="ph ph-file-pdf"></i> Exportar PDF</button>
                </div>
                <div class="report-card-body" id="report-pendentes">
                     <p>Selecione os filtros e clique em "Filtrar" para gerar o relatório.</p>
                </div>
            </div>

            <!-- Mapa de Produção - Freelance -->
            <div class="report-card">
                <div class="report-card-header">
                    <h4>Mapa de Produção - Freelance</h4>
                    <button class="btn-primary" onclick="exportPdf('producao-freelance')"><i class="ph ph-file-pdf"></i> Exportar PDF</button>
                </div>
                <div class="report-card-body" id="report-producao-freelance">
                    <p>Selecione os filtros e clique em "Filtrar". Depois, procure por um freelancer para ver os resultados.</p>
                    <div id="freelancer-search-container">
                        <input type="search" id="search-freelance" class="search-bar" placeholder="Pesquisar por nome do Freelancer...">
                    </div>
                    <div id="freelance-results"></div>
                </div>
            </div>
        </div>
      </div>

    </div>
  </div>

  <!-- MODAIS -->
  <div id="formModal" class="modal-overlay">
    <div class="modal-box"><div class="modal-header"><h3 id="formModalTitle"></h3><button class="close-btn" onclick="closeFormModal()">&times;</button></div><div id="formModalBody" class="modal-body"></div></div>
  </div>
  <div id="detailsModal" class="modal-overlay">
    <div class="modal-box"><div class="modal-header"><h3 id="detailsModalTitle"></h3><button class="close-btn" onclick="closeDetailsModal()">&times;</button></div><div id="detailsModalBody" class="modal-body"></div></div>
  </div>
  <div id="confirmModal" class="modal-overlay">
    <div class="modal-box" style="max-width: 400px;"><p id="confirmModalText"></p><div class="modal-footer" style="text-align: center;"><button id="confirmModalNo" class="btn-secondary">Não</button><button id="confirmModalYes" class="btn-primary">Sim</button></div></div>
  </div>
  <div id="conciliarModal" class="modal-overlay">
    <div class="modal-box" style="max-width: 450px;">
        <div class="modal-header"><h3>Conciliar Despesas</h3><button class="close-btn" onclick="closeConciliarModal()">&times;</button></div>
        <div class="modal-body">
            <p>Selecione a data e o banco para conciliar as <strong id="conciliarCount"></strong> despesa(s) selecionada(s).</p>
            <div class="row">
                <div class="col"><label>Data do Movimento</label><input type="date" id="conciliarDate"></div>
                <div class="col"><label>Banco</label><select id="conciliarBanco"></select></div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn-secondary" onclick="closeConciliarModal()">Cancelar</button>
            <button type="button" class="btn-primary" onclick="conciliarDespesasEmMassa()">Confirmar e Gerar PDF</button>
        </div>
    </div>
  </div>
   <div id="comissaoModal" class="modal-overlay">
    <div class="modal-box" style="max-width: 500px;">
        <div class="modal-header"><h3>Liquidar Comissões</h3><button class="close-btn" onclick="closeComissaoModal()">&times;</button></div>
        <div class="modal-body">
            <p>Insira os dados para liquidar as <strong id="comissaoCount"></strong> comissão(ões) selecionada(s).</p>
            <div class="row">
              <div class="col"><label>Nº da Fatura</label><input type="text" id="comissaoFatura" required></div>
              <div class="col"><label>Data de Pagamento</label><input type="date" id="comissaoDataPagamento" required></div>
            </div>
            <label>Banco de Recebimento</label><select id="comissaoBanco" required></select>
            <div style="margin-top: 1em;">
                <label><input type="checkbox" id="comissaoRetencaoCheck" onchange="document.getElementById('comissaoRetencaoOptions').style.display = this.checked ? 'block' : 'none'"> Com retenção?</label>
                <div id="comissaoRetencaoOptions" style="display:none; margin-top: .5em; padding-left: 1.5em;">
                    <label style="font-weight: normal; margin-right: 1em;"><input type="radio" name="comissaoRetencaoPercent" value="0.23" checked> 23%</label>
                    <label style="font-weight: normal;"><input type="radio" name="comissaoRetencaoPercent" value="0.25"> 25%</label>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn-secondary" onclick="closeComissaoModal()">Cancelar</button>
            <button type="button" class="btn-primary" onclick="liquidarComissoes()">Confirmar Liquidação</button>
        </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div id="toast-container"></div>

  <!-- FIREBASE SDKS (MODULAR) -->
  <script type="module">
    // Importações do Firebase v11+ Modular SDK (Versão Atualizada)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, doc, getDoc, getDocs, addDoc, updateDoc, deleteDoc, query, where, orderBy, serverTimestamp, runTransaction, writeBatch, collectionGroup, arrayUnion, arrayRemove, limit, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

    // Inicialização do jsPDF
    const { jsPDF } = window.jspdf;

    // AVISO: A sua chave de API está visível no código do lado do cliente.
    // Para um ambiente de produção, é recomendado proteger esta chave usando
    // App Check ou movendo a lógica sensível para um backend (Cloud Functions).
    const firebaseConfig = {
      apiKey: "AIzaSyA0xYVjKFIv0pJaYksNmh_SKEJJL7bLZbw",
      authDomain: "tw25-1dbb3.firebaseapp.com",
      projectId: "tw25-1dbb3",
      storageBucket: "tw25-1dbb3.appspot.com",
      messagingSenderId: "995776920444",
      appId: "1:995776920444:web:7866264b9f4d74bedac2f9"
    };

    // Inicialização dos serviços Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // --- LÓGICA DA APLICAÇÃO ---
    let currentUserData = null; 
    let partnersData = {}; 
    let currentFormSubmitHandler = null;
    let creditChartInstance = null;
    let contractTypeChartInstance = null;
    let cachedReportData = []; // Cache para os dados filtrados dos relatórios
    
    // Objeto com os tipos de seguro e comissões
    const insuranceTypes = {
        "Acidentes de Trabalho": 8.3,
        "Acidentes Pessoais": 12.5,
        "Viagem": 8.3,
        "Saúde - Individual": 8.3,
        "Saúde - Grupo Pacotizado (Saneg)": 7.5,
        "Saúde - Grupo (Restante)": 6.3,
        "Incêndio": 10,
        "Multirrisco": 13,
        "Multirrisco Industrial": 12.5,
        "Multirrisco Estabelecimento": 15,
        "Agrícola": 7.5,
        "Pecuária": 8.3,
        "Colheitas": 6.3,
        "Construção": 8.3,
        "Máquinas Casco": 6.3,
        "Equipamento Eletrónico": 8.3,
        "Montagem": 8.3,
        "Cristais": 10,
        "Roubo": 10,
        "Avaria Máquinas": 8.3,
        "Automóvel": 6.3,
        "Transportes - Aéreo Cascos": 6.3,
        "Transportes - Marítimo Cascos": 6.3,
        "Transportes - Mercadorias Transportadas": 8.3,
        "Transportes - Transportes Especiais": 8.3,
        "Responsabilidade Civil": 8.3,
        "Diversos - Cauções": 8.3,
        "Diversos - Perdas de Exploração": 10
    };


    // --- Sistema de Notificações Toast ---
    function showToast(message, type = 'success') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        container.appendChild(toast);

        setTimeout(() => {
            toast.classList.add('show');
        }, 100);

        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => {
                if (container.contains(toast)) {
                    container.removeChild(toast);
                }
            }, 400);
        }, 3500);
    }
    
    // --- Autenticação e UI ---
    onAuthStateChanged(auth, async user => {
      const loginContainer = document.getElementById('login-container');
      const appContainer = document.getElementById('app-container');
      if (user) {
        const q = query(collection(db, 'comerciais'), where('email', '==', user.email), limit(1));
        const comecialSnapshot = await getDocs(q);
        
        if (!comecialSnapshot.empty) {
            const doc = comecialSnapshot.docs[0];
            currentUserData = { id: doc.id, ...doc.data() };
        } else {
            currentUserData = { id: user.uid, email: user.email, role: 'Administrador', firstName: 'Admin' };
            console.warn("Utilizador autenticado mas sem perfil na coleção 'comerciais'. A assumir função de Administrador.");
        }
        
        setupUIVisibility();
        await preloadPartnerData(); 

        loginContainer.style.display = 'none';
        appContainer.style.display = 'block';
        showSection('dashboard');
        loadAllData();
        setupEventListeners();
      } else {
        currentUserData = null;
        loginContainer.style.display = 'flex';
        appContainer.style.display = 'none';
      }
    });
    
    function setupUIVisibility() {
        if (!currentUserData) return;
        const isAdmin = currentUserData.role === 'Administrador';
        document.getElementById('nav-comercial').style.display = isAdmin ? 'flex' : 'none';
        document.getElementById('nav-financeira').style.display = isAdmin ? 'flex' : 'none';
        document.getElementById('nav-relatorios').style.display = isAdmin ? 'flex' : 'none'; // Apenas Admin vê relatórios
    }

    document.getElementById('loginForm').onsubmit = e => {
      e.preventDefault();
      document.getElementById('loginError').textContent = '';
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      signInWithEmailAndPassword(auth, email, password)
        .catch(err => {
            document.getElementById('loginError').textContent = "Login falhou. Verifique os seus dados.";
            showToast("Login falhou. Verifique os seus dados.", "error");
        });
    };
    document.getElementById('logoutBtn').onclick = () => signOut(auth);

    function setupEventListeners() {
        document.getElementById('search-clientes').addEventListener('input', (e) => loadClients(e.target.value));
        document.getElementById('search-contratos').addEventListener('input', (e) => loadContracts(e.target.value));
        document.getElementById('search-freelance').addEventListener('input', (e) => renderFreelanceReport(cachedReportData, e.target.value));
    }

    function loadAllData() {
        loadClients();
        loadContracts();
        loadTasks();
        loadPartners();
        if (currentUserData && currentUserData.role === 'Administrador') {
            loadComerciais();
        }
        loadDashboardData();
    }
    
    // --- Funções Globais (Navegação, Modais) ---
    // Expostas globalmente para que os `onclick` no HTML funcionem com `script type="module"`.
    const showSection = window.showSection = (sectionId) => {
        document.querySelectorAll('.main-content').forEach(s => s.classList.remove('active'));
        document.getElementById(sectionId + '-section').classList.add('active');
        document.querySelectorAll('.sidebar nav button').forEach(b => b.classList.remove('active'));
        document.getElementById('nav-' + sectionId).classList.add('active');
        
        if (sectionId === 'dashboard') loadDashboardData();
        if (sectionId === 'financeira') loadFinanceiraModule();
        if (sectionId === 'relatorios') setupReportsModule();
    }

    const formModal = document.getElementById('formModal');
    const detailsModal = document.getElementById('detailsModal');
    const confirmModal = document.getElementById('confirmModal');
    const conciliarModal = document.getElementById('conciliarModal');
    const comissaoModal = document.getElementById('comissaoModal');

    const openFormModal = window.openFormModal = async (type, id = null) => {
        document.getElementById('formModalTitle').textContent = `${id ? 'Editar' : 'Adicionar'} ${type.charAt(0).toUpperCase() + type.slice(1)}`;
        const formModalBody = document.getElementById('formModalBody');
        formModalBody.innerHTML = ''; 
        
        let formHTML = '';
        switch(type) {
            case 'cliente': formHTML = getClientFormHTML(); break;
            case 'contrato': formHTML = getContractFormHTML(); break;
            case 'tarefa': formHTML = getTaskFormHTML(); break;
            case 'fornecedor': formHTML = getFornecedorFormHTML(); break;
            case 'financeira': formHTML = getFinanceiraFormHTML(); break;
            case 'seguradora': formHTML = getSeguradoraFormHTML(); break;
            case 'comercial': formHTML = getComercialFormHTML(); break;
            case 'despesa': formHTML = getDespesaFormHTML(); break;
            case 'banco': formHTML = getBancoFormHTML(); break;
            case 'ganho': formHTML = getGanhoFormHTML(); break;
        }
        formModalBody.innerHTML = formHTML;

        if (id) {
            if (type === 'cliente') await populateClientForm(id);
            if (type === 'contrato') await loadContractDropdowns(() => populateContractForm(id));
            if (type === 'tarefa') await loadDropdownsForTaskForm(() => populateTaskForm(id));
            if (type === 'fornecedor') await populatePartnerForm('fornecedores', id);
            if (type === 'financeira') await populatePartnerForm('financeiras', id);
            if (type === 'seguradora') await populatePartnerForm('seguradoras', id);
            if (type === 'comercial') await populateComercialForm(id);
            if (type === 'despesa') await populateDespesaForm(id);
            if (type === 'banco') await populateBancoForm(id);
            if (type === 'ganho') await populateGanhoForm(id);
        } else {
            if (type === 'cliente') {
                document.getElementById('clientCreationDate').value = new Date().toISOString().split('T')[0];
                await loadComerciaisForDropdown('clientManager');
            }
            if (type === 'contrato') await loadContractDropdowns();
            if (type === 'tarefa') await loadDropdownsForTaskForm();
            if (type === 'despesa') {
                document.getElementById('despesaDate').value = new Date().toISOString().split('T')[0];
                await loadBancosForDropdown('despesaBanco');
            }
            if (type === 'ganho') {
                 document.getElementById('ganhoData').value = new Date().toISOString().split('T')[0];
                 await loadBancosForDropdown('ganhoBanco');
                 await loadPartnersForDropdown('financeiras', 'ganhoParceiro');
            }
        }
        
        const form = formModalBody.querySelector('form');
        currentFormSubmitHandler = async (e) => {
            e.preventDefault();
            switch(type) {
                case 'cliente': await handleClientFormSubmit(id); break;
                case 'contrato': await handleContractFormSubmit(id); break;
                case 'tarefa': await handleTaskFormSubmit(id); break;
                case 'fornecedor': await handlePartnerFormSubmit('fornecedores', id); break;
                case 'financeira': await handlePartnerFormSubmit('financeiras', id); break;
                case 'seguradora': await handlePartnerFormSubmit('seguradoras', id); break;
                case 'comercial': await handleComercialFormSubmit(id); break;
                case 'despesa': await handleDespesaFormSubmit(id); break;
                case 'banco': await handleBancoFormSubmit(id); break;
                case 'ganho': await handleGanhoFormSubmit(id); break;
            }
        };
        form.addEventListener('submit', currentFormSubmitHandler);
        formModal.classList.add('active');
    }

    const closeFormModal = window.closeFormModal = () => {
        const form = document.getElementById('formModalBody').querySelector('form');
        if (form && currentFormSubmitHandler) {
            form.removeEventListener('submit', currentFormSubmitHandler);
        }
        formModal.classList.remove('active');
    }
    
    const openDetailsModal = window.openDetailsModal = async (type, id, collectionName) => {
        const detailsModalTitle = document.getElementById('detailsModalTitle');
        const detailsModalBody = document.getElementById('detailsModalBody');
        detailsModalBody.innerHTML = 'A carregar...';
        detailsModal.classList.add('active');

        if (type === 'cliente') {
            const docRef = doc(db, 'clientes', id);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const d = docSnap.data();
                detailsModalTitle.textContent = `Detalhes de: ${d.name}`;
                detailsModalBody.innerHTML = `
                    <div class="details-grid">
                        <div>
                            <h4>Dados Pessoais e Comerciais</h4>
                            <p><strong>Nome:</strong> ${d.name || '-'}</p><p><strong>Email:</strong> ${d.email || '-'}</p><p><strong>Telefone:</strong> ${d.phone || '-'}</p><p><strong>NIF:</strong> ${d.nif || '-'}</p><p><strong>Morada:</strong> ${d.address || '-'}</p><p><strong>Código Postal:</strong> ${d.postalCode || '-'}</p><p><strong>Localidade:</strong> ${d.city || '-'}</p>
                        </div>
                        <div>
                            <h4>Documentos Associados</h4>
                            <form id="upload-form">
                                <input type="file" id="file-input" required>
                                <button type="submit" class="btn-primary" style="padding: .5em 1em;"><i class="ph ph-upload-simple"></i></button>
                            </form>
                            <progress id="upload-progress" value="0" max="100"></progress>
                            <ul id="documentList"></ul>
                        </div>
                    </div>
                    <h4>Contratos Associados</h4>
                    <div id="associatedContracts">A carregar contratos...</div>
                    <h4>Histórico de Interações</h4>
                    <div id="interactionHistory"></div>
                    <form id="interactionForm">
                        <label>Adicionar Nova Interação</label>
                        <textarea id="newInteractionNote" rows="3" required></textarea>
                        <div class="modal-footer" style="margin-top: 1em; padding: 0;"><button type="submit" class="btn-primary">Adicionar</button></div>
                    </form>
                `;
                
                loadAssociatedContracts(id);
                loadInteractions('clientes', id, 'interactionHistory');
                loadDocuments('clientes', id, 'documentList');

                document.getElementById('interactionForm').onsubmit = (e) => {
                    e.preventDefault();
                    const note = document.getElementById('newInteractionNote').value;
                    handleInteractionSubmit('clientes', id, note, 'interactionHistory');
                    document.getElementById('newInteractionNote').value = '';
                };

                document.getElementById('upload-form').onsubmit = (e) => {
                    e.preventDefault();
                    const fileInput = document.getElementById('file-input');
                    const file = fileInput.files[0];
                    if (file) {
                        handleFileUpload('clientes', id, file);
                    }
                };

            }
        } else if (type === 'contrato') {
            const docRef = doc(db, 'contratos', id);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const d = docSnap.data();
                detailsModalTitle.textContent = `Detalhes do Contrato: ${d.type}`;
                detailsModalBody.innerHTML = `
                    <div class="details-grid">
                        <div>
                             <h4>Informação do Contrato</h4>
                            <p><strong>Cliente:</strong> ${d.clientName || '-'}</p>
                            <p><strong>Tipo de Serviço:</strong> ${d.type || '-'}</p>
                            <p><strong>Valor:</strong> €${parseFloat(d.valorFinanciado || 0).toLocaleString('pt-PT')}</p>
                            <p><strong>Fase:</strong> ${d.fase || '-'}</p>
                            <p><strong>Data de Início:</strong> ${d.startDate || '-'}</p>
                            <p><strong>Comercial:</strong> ${d.commercialName || '-'}</p>
                            <hr>
                            <h4>Observações</h4>
                            <p>${d.notes || 'Nenhuma observação.'}</p>
                        </div>
                        <div>
                            <h4>Etapas e Tarefas Associadas</h4>
                            <div id="milestonesList"></div>
                            <form id="milestoneForm" style="margin-top: 1em; border-top: 1px solid var(--color-border); padding-top: 1em;">
                                <label>Adicionar Etapa e Tarefa (Opcional)</label>
                                <input type="text" id="newMilestoneDescription" placeholder="Descrição da nova etapa*" required>
                                <div class="row">
                                    <div class="col"><input type="text" id="newMilestoneOwner" placeholder="Responsável da tarefa"></div>
                                    <div class="col"><input type="date" id="newMilestoneDueDate"></div>
                                </div>
                                <button type="submit" class="btn-primary" style="width: 100%;">Adicionar Etapa</button>
                            </form>
                        </div>
                    </div>
                    <h4>Histórico de Interações do Contrato</h4>
                    <div id="contractInteractionHistory"></div>
                     <form id="contractInteractionForm">
                        <label>Adicionar Nova Interação</label>
                        <textarea id="newContractInteractionNote" rows="3" required></textarea>
                        <div class="modal-footer" style="margin-top: 1em; padding: 0;"><button type="submit" class="btn-primary">Adicionar</button></div>
                    </form>
                `;
                loadMilestones(id, 'milestonesList');
                loadInteractions('contratos', id, 'contractInteractionHistory');

                document.getElementById('milestoneForm').onsubmit = (e) => {
                    e.preventDefault();
                    handleMilestoneSubmit(id);
                };

                document.getElementById('contractInteractionForm').onsubmit = (e) => {
                    e.preventDefault();
                    const note = document.getElementById('newContractInteractionNote').value;
                    handleInteractionSubmit('contratos', id, note, 'contractInteractionHistory');
                    document.getElementById('newContractInteractionNote').value = '';
                };
            }
        } else if (type === 'partner' && collectionName) {
            const docRef = doc(db, collectionName, id);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const d = docSnap.data();
                detailsModalTitle.textContent = `Detalhes de: ${d.name}`;
                let detailsHTML = '<h4>Dados Gerais</h4>';
                for (const [key, value] of Object.entries(d)) {
                    if (value) {
                       detailsHTML += `<p><strong>${key.charAt(0).toUpperCase() + key.slice(1)}:</strong> ${value}</p>`;
                    }
                }

                detailsModalBody.innerHTML = `
                    <div>${detailsHTML}</div>
                    <hr>
                    <h4>Histórico de Interações</h4>
                    <div id="partnerInteractionHistory"></div>
                    <form id="partnerInteractionForm">
                        <label>Adicionar Nova Interação</label>
                        <textarea id="newPartnerInteractionNote" rows="3" required></textarea>
                        <div class="modal-footer" style="margin-top: 1em; padding: 0;"><button type="submit" class="btn-primary">Adicionar</button></div>
                    </form>
                `;
                
                loadInteractions(collectionName, id, 'partnerInteractionHistory');

                document.getElementById('partnerInteractionForm').onsubmit = (e) => {
                    e.preventDefault();
                    const note = document.getElementById('newPartnerInteractionNote').value;
                    handleInteractionSubmit(collectionName, id, note, 'partnerInteractionHistory');
                    document.getElementById('newPartnerInteractionNote').value = '';
                };
            }
        }
    }

    const closeDetailsModal = window.closeDetailsModal = () => { detailsModal.classList.remove('active'); }

    let confirmCallback = null;
    function showConfirmModal(message, callback) {
        document.getElementById('confirmModalText').textContent = message;
        confirmCallback = callback;
        confirmModal.classList.add('active');
    }
    document.getElementById('confirmModalYes').onclick = () => {
        if (confirmCallback) confirmCallback();
        confirmModal.classList.remove('active');
    };
    document.getElementById('confirmModalNo').onclick = () => { confirmModal.classList.remove('active'); };

    // --- DASHBOARD ---
    const loadDashboardData = window.loadDashboardData = async () => {
        const today = new Date();
        const currentMonth = today.getMonth();
        const currentYear = today.getFullYear();
        document.getElementById('dashboard-update-time').textContent = `Última atualização: hoje às ${String(today.getHours()).padStart(2, '0')}:${String(today.getMinutes()).padStart(2, '0')}`;

        const contractsSnapshot = await getDocs(collection(db, 'contratos'));
        let creditVolume = 0;
        let monthlyCommissions = 0;
        let monthlyPremium = 0;
        let monthlyCreditData = new Array(6).fill(0);
        const sixMonthsAgo = new Date();
        sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 5);
        sixMonthsAgo.setDate(1);

        const renewalsList = document.getElementById('dashboardRenewalsList');
        renewalsList.innerHTML = '';
        let renewalsCount = 0;

        contractsSnapshot.forEach(doc => {
            const contract = doc.data();
            if (contract.fase !== 'Ativo') return;

            if (contract.type === 'Crédito' && contract.valorFinanciado) {
                creditVolume += parseFloat(contract.valorFinanciado);
                const contractDate = new Date(contract.startDate);
                if(contractDate >= sixMonthsAgo) {
                    const monthDiff = (today.getFullYear() - contractDate.getFullYear()) * 12 + (today.getMonth() - contractDate.getMonth());
                    if (monthDiff >= 0 && monthDiff < 6) {
                        monthlyCreditData[5 - monthDiff] += parseFloat(contract.valorFinanciado);
                    }
                }
            }
            
            if (contract.type === 'Seguro') {
                const startDate = new Date(contract.startDate);
                // Check new business for this month
                if (startDate.getMonth() === currentMonth && startDate.getFullYear() === currentYear) {
                    monthlyCommissions += parseFloat(contract.comissaoRecebida || 0);
                    monthlyPremium += parseFloat(contract.premioComercial || 0);
                }
                
                // Check renewals for this month
                if (contract.nextRenewalDate) {
                    const renewalDate = new Date(contract.nextRenewalDate);
                    if (renewalDate.getMonth() === currentMonth && renewalDate.getFullYear() === currentYear) {
                         if (startDate.getMonth() !== currentMonth || startDate.getFullYear() !== currentYear) {
                            monthlyCommissions += parseFloat(contract.comissaoRecebida || 0);
                            monthlyPremium += parseFloat(contract.premioComercial || 0);
                        }
                        const item = document.createElement('div');
                        item.className = 'renewal-item';
                        item.innerHTML = `
                            <div>
                                <div class="title">${contract.clientName} - ${contract.tipoSeguro}</div>
                                <div class="deadline">Renova em: ${contract.nextRenewalDate}</div>
                            </div>
                            <div>
                                <button onclick="handleRenewal('${doc.id}', true)" class="btn-primary" style="padding: .4em .8em; font-size: .8em;">Renovar</button>
                                <button onclick="handleRenewal('${doc.id}', false)" class="btn-secondary" style="padding: .4em .8em; font-size: .8em;">Não Renovar</button>
                            </div>
                        `;
                        renewalsList.appendChild(item);
                        renewalsCount++;
                    }
                }
            }
        });
        
        if (renewalsCount === 0) {
            renewalsList.innerHTML = '<p>Nenhuma renovação este mês.</p>';
        }

        document.getElementById('kpi-credit-volume').textContent = `€${creditVolume.toLocaleString('pt-PT', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        document.getElementById('kpi-monthly-commissions').textContent = `€${monthlyCommissions.toLocaleString('pt-PT', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        document.getElementById('kpi-monthly-premium').textContent = `€${monthlyPremium.toLocaleString('pt-PT', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

        const pendingTasksQuery = query(collection(db, 'tarefas'), where('status', '==', 'Pendente'));
        const tasksSnapshot = await getDocs(pendingTasksQuery);
        document.getElementById('kpi-pending-tasks').textContent = tasksSnapshot.size;
        
        const dashboardTasksList = document.getElementById('dashboardTasksList');
        dashboardTasksList.innerHTML = '';
        
        let tasks = [];
        tasksSnapshot.forEach(doc => tasks.push({ id: doc.id, ...doc.data() }));
        tasks.sort((a, b) => (a.dueDate && b.dueDate) ? new Date(a.dueDate) - new Date(b.dueDate) : a.dueDate ? -1 : 1);

        if (tasks.length === 0) {
            dashboardTasksList.innerHTML = '<p>Nenhuma tarefa pendente.</p>';
        } else {
            tasks.slice(0, 5).forEach(task => {
                const item = document.createElement('div');
                item.className = 'task-item';
                item.onclick = () => showSection('tarefas');
                item.innerHTML = `<div><div class="title">${task.title}</div><div class="deadline">Prazo: ${task.dueDate || 'N/D'}</div></div>`;
                dashboardTasksList.appendChild(item);
            });
        }
        
        loadDocumentTrackingWidget();
        
        const monthNames = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
        let labels = [];
        for (let i = 5; i >= 0; i--) {
            labels.push(monthNames[(today.getMonth() - i + 12) % 12]);
        }
        const ctx = document.getElementById('creditChart').getContext('2d');
        if(creditChartInstance) creditChartInstance.destroy();
        creditChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Volume de Crédito',
                    data: monthlyCreditData,
                    backgroundColor: 'rgba(200, 184, 156, 0.7)',
                    borderColor: 'rgba(200, 184, 156, 1)',
                    borderWidth: 1,
                    borderRadius: 5
                }]
            },
            options: { responsive: true, scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } }
        });
    }
    
    const handleRenewal = window.handleRenewal = async (contractId, didRenew) => {
        if (didRenew) {
            const contractRef = doc(db, 'contratos', contractId);
            const contractSnap = await getDoc(contractRef);
            if (!contractSnap.exists()) return;
            const contract = contractSnap.data();

            const oldRenewalDate = new Date(contract.nextRenewalDate);
            let newRenewalDate = new Date(oldRenewalDate);

            switch(contract.fracionamento) {
                case 'Mensal': newRenewalDate.setMonth(oldRenewalDate.getMonth() + 1); break;
                case 'Trimestral': newRenewalDate.setMonth(oldRenewalDate.getMonth() + 3); break;
                case 'Semestral': newRenewalDate.setMonth(oldRenewalDate.getMonth() + 6); break;
                case 'Anual': newRenewalDate.setFullYear(oldRenewalDate.getFullYear() + 1); break;
            }
            
            await updateDoc(contractRef, { nextRenewalDate: newRenewalDate.toISOString().split('T')[0] });
            showToast('Apólice renovada com sucesso!', 'success');
        } else {
            await updateDoc(doc(db, 'contratos', contractId), { fase: 'Cancelado' });
            showToast('Contrato cancelado.', 'info');
        }
        loadDashboardData();
    }


    // --- PARCEIROS ---
    async function preloadPartnerData() {
        const partnerTypes = ['fornecedores', 'financeiras', 'seguradoras', 'comerciais', 'clientes'];
        for (const type of partnerTypes) {
            partnersData[type] = {};
            const snapshot = await getDocs(collection(db, type));
            snapshot.forEach(doc => {
                const data = doc.data();
                partnersData[type][doc.id] = data.name || `${data.firstName} ${data.lastName}`;
            });
        }
    }

    const openPartnerTab = window.openPartnerTab = (evt, tabName) => {
        document.querySelectorAll('#parceiros-section .tab-content').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('#parceiros-section .tabs button').forEach(btn => btn.classList.remove('active'));
        document.getElementById(tabName).classList.add('active');
        evt.currentTarget.classList.add('active');
    }

    const loadPartners = window.loadPartners = async () => {
        loadPartnerData('fornecedores');
        loadPartnerData('financeiras');
        loadPartnerData('seguradoras');
        await preloadPartnerData(); 
    }
    
    async function loadPartnerData(type) {
        const tableBody = document.getElementById(`${type}Table`).querySelector('tbody');
        tableBody.innerHTML = '';
        const q = query(collection(db, type), orderBy('name'));
        const snapshot = await getDocs(q);
        snapshot.forEach(doc => {
            const d = doc.data();
            const row = tableBody.insertRow();
            let cells = '';
            
            let editType;
            if (type === 'fornecedores') {
                editType = 'fornecedor';
                cells = `<td>${d.name}</td><td>${d.equipment}</td><td>${d.contactPerson}</td><td>${d.email}</td>`;
            } else if (type === 'financeiras') {
                editType = 'financeira';
                cells = `<td>${d.name}</td><td>${d.commercialName}</td><td>${d.commercialContact}</td><td>${d.commercialEmail}</td><td>${d.commissionEmail}</td>`;
            } else if (type === 'seguradoras') {
                editType = 'seguradora';
                cells = `<td>${d.name}</td><td>${d.commercialName}</td><td>${d.commercialContact}</td><td>${d.commercialEmail}</td>`;
            }

            row.innerHTML = `${cells}<td class="actions-cell">
                <button onclick="openDetailsModal('partner', '${doc.id}', '${type}')" title="Ver Detalhes"><i class="ph ph-eye"></i></button>
                <button onclick="openFormModal('${editType}', '${doc.id}')" title="Editar"><i class="ph ph-pencil-simple"></i></button>
                <button class="btn-danger" onclick="deleteItem('${type}', '${doc.id}', '${d.name}', loadPartners)" title="Eliminar"><i class="ph ph-trash"></i></button>
            </td>`;
        });
    }
    
    async function handlePartnerFormSubmit(type, id) {
        let data = {};
        if (type === 'fornecedores') {
            const certidao = document.getElementById('partnerCertidaoComercial').value;
            if (certidao && !/^\d{4}-\d{4}-\d{4}$/.test(certidao)) {
                showToast('Certidão Comercial deve ter o formato 1234-1234-1234.', 'error');
                return;
            }
            data = {
                name: document.getElementById('partnerName').value, nif: document.getElementById('partnerNif').value, iban: document.getElementById('partnerIban').value, address: document.getElementById('partnerAddress').value, postalCode: document.getElementById('partnerPostalCode').value, city: document.getElementById('partnerCity').value, phone: document.getElementById('partnerPhone').value, email: document.getElementById('partnerEmail').value, cae: document.getElementById('partnerCae').value, capital: document.getElementById('partnerCapital').value, contactPerson: document.getElementById('partnerContactPerson').value, equipment: document.getElementById('partnerEquipment').value,
                certidaoComercial: certidao
            };
        } else if (type === 'financeiras') {
            data = {
                name: document.getElementById('partnerName').value, address: document.getElementById('partnerAddress').value, nif: document.getElementById('partnerNif').value, commercialName: document.getElementById('partnerCommercialName').value, commercialDob: document.getElementById('partnerCommercialDob').value, commercialContact: document.getElementById('partnerCommercialContact').value, commercialEmail: document.getElementById('partnerCommercialEmail').value, commissionEmail: document.getElementById('partnerCommissionEmail').value
            };
        } else if (type === 'seguradoras') {
            data = {
                name: document.getElementById('partnerName').value, address: document.getElementById('partnerAddress').value, nif: document.getElementById('partnerNif').value, commercialName: document.getElementById('partnerCommercialName').value, commercialDob: document.getElementById('partnerCommercialDob').value, commercialContact: document.getElementById('partnerCommercialContact').value, commercialEmail: document.getElementById('partnerCommercialEmail').value
            };
        }
        
        try {
            if (id) {
                await updateDoc(doc(db, type, id), data);
            } else {
                await addDoc(collection(db, type), data);
            }
            showToast(`Parceiro guardado com sucesso!`, 'success');
            closeFormModal();
            loadPartners();
        } catch (error) {
            console.error("Erro ao guardar parceiro:", error);
            showToast("Erro ao guardar parceiro.", "error");
        }
    }
    
    async function populatePartnerForm(type, id) {
        const docSnap = await getDoc(doc(db, type, id));
        if(!docSnap.exists()) return;
        const d = docSnap.data();
        if (type === 'fornecedores') {
            document.getElementById('partnerName').value = d.name || ''; document.getElementById('partnerNif').value = d.nif || ''; document.getElementById('partnerIban').value = d.iban || ''; document.getElementById('partnerAddress').value = d.address || ''; document.getElementById('partnerPostalCode').value = d.postalCode || ''; document.getElementById('partnerCity').value = d.city || ''; document.getElementById('partnerPhone').value = d.phone || ''; document.getElementById('partnerEmail').value = d.email || ''; document.getElementById('partnerCae').value = d.cae || ''; document.getElementById('partnerCapital').value = d.capital || ''; document.getElementById('partnerContactPerson').value = d.contactPerson || ''; document.getElementById('partnerEquipment').value = d.equipment || '';
            document.getElementById('partnerCertidaoComercial').value = d.certidaoComercial || '';
        } else if (type === 'financeiras') {
            document.getElementById('partnerName').value = d.name || ''; document.getElementById('partnerAddress').value = d.address || ''; document.getElementById('partnerNif').value = d.nif || ''; document.getElementById('partnerCommercialName').value = d.commercialName || ''; document.getElementById('partnerCommercialDob').value = d.commercialDob || ''; document.getElementById('partnerCommercialContact').value = d.commercialContact || ''; document.getElementById('partnerCommercialEmail').value = d.commercialEmail || ''; document.getElementById('partnerCommissionEmail').value = d.commissionEmail || '';
        } else if (type === 'seguradoras') {
            document.getElementById('partnerName').value = d.name || ''; document.getElementById('partnerAddress').value = d.address || ''; document.getElementById('partnerNif').value = d.nif || ''; document.getElementById('partnerCommercialName').value = d.commercialName || ''; document.getElementById('partnerCommercialDob').value = d.commercialDob || ''; document.getElementById('partnerCommercialContact').value = d.commercialContact || ''; document.getElementById('partnerCommercialEmail').value = d.commercialEmail || '';
        }
    }

    // --- TAREFAS ---
    const loadTasks = window.loadTasks = async () => {
        const tableBody = document.getElementById('tasksTable').querySelector('tbody');
        tableBody.innerHTML = '';
        const q = query(collection(db, 'tarefas'), orderBy('dueDate'));
        const snapshot = await getDocs(q);
        snapshot.forEach(docSnap => {
            const d = docSnap.data();
            const row = tableBody.insertRow();
            row.innerHTML = `
                <td>${d.title}</td>
                <td>${d.owner || '-'}</td>
                <td>${d.dueDate || '-'}</td>
                <td>${d.priority || '-'}</td>
                <td>${d.status || '-'}</td>
                <td class="actions-cell">
                    ${d.status !== 'Concluído' ? `<button onclick="completeTask('${docSnap.id}', '${d.title}')" title="Concluir Tarefa"><i class="ph ph-check-circle"></i></button>` : ''}
                    <button onclick="openFormModal('tarefa', '${docSnap.id}')" title="Editar"><i class="ph ph-pencil-simple"></i></button>
                    <button class="btn-danger" onclick="deleteItem('tarefas', '${docSnap.id}', '${d.title}', loadTasks)" title="Eliminar"><i class="ph ph-trash"></i></button>
                </td>
            `;
        });
    }

    const completeTask = window.completeTask = async (id, title) => {
        const taskDocRef = doc(db, 'tarefas', id);
        const taskDocSnap = await getDoc(taskDocRef);
        if (!taskDocSnap.exists()) return;
        const taskData = taskDocSnap.data();

        const today = new Date().toISOString().split('T')[0];
        await updateDoc(taskDocRef, {
            status: 'Concluído',
            completionDate: today
        });
        
        showToast(`Tarefa '${title}' concluída!`, 'success');
        const note = `Tarefa '${title}' foi concluída.`;
        
        if (taskData.clientId) { handleInteractionSubmit('clientes', taskData.clientId, note); }
        if (taskData.contractId) { 
            handleInteractionSubmit('contratos', taskData.contractId, note); 
            if (taskData.autoTaskType === 'documentos_em_falta') {
                const docNote = `Pendente de documentos em falta foi resolvido.`;
                handleInteractionSubmit('contratos', taskData.contractId, docNote);
            }
        }
        
        loadTasks();
        loadDashboardData();
    }

    // --- Funções de ajuda e genéricas ---
    function getClientFormHTML() { 
        return `<form id="clientForm">
            <div class="row">
                <div class="col"><label>Nome Completo</label><input type="text" id="clientName" required /></div>
                <div class="col"><label>Email</label><input type="email" id="clientEmail" /></div>
            </div>
            <div class="row">
                <div class="col"><label>Telefone</label><input type="tel" id="clientPhone" /></div>
                <div class="col"><label>NIF*</label><input type="text" id="clientNif" maxlength="9" required /></div>
            </div>
            <div class="row">
                <div class="col"><label>Data de Nascimento</label><input type="date" id="clientDob" /></div>
            </div>
            <label>Morada</label><input type="text" id="clientAddress" />
            <div class="row">
                <div class="col"><label>Código Postal</label><input type="text" id="clientPostalCode" /></div>
                <div class="col"><label>Localidade</label><input type="text" id="clientCity" /></div>
            </div>
            <div class="row">
                <div class="col"><label>Tipo de Serviço</label><select id="clientServiceType"><option value="">Selecionar</option><option value="Crédito">Crédito</option><option value="Seguro">Seguro</option><option value="Consultoria">Consultoria</option><option value="Legalização">Legalização</option></select></div>
                <div class="col"><label>Comercial Responsável</label><select id="clientManager"></select></div>
            </div>
            <div class="row">
                <div class="col"><label>Data de Criação</label><input type="date" id="clientCreationDate" readonly /></div>
                <div class="col"><label>RGPD Assinado?</label><select id="clientRgpd"><option value="Sim">Sim</option><option value="Não">Não</option></select></div>
            </div>
            <label>Observações Internas</label><textarea id="clientInternalNotes" rows="3"></textarea>
            <div class="modal-footer"><button type="button" class="btn-secondary" onclick="closeFormModal()">Cancelar</button><button type="submit" class="btn-primary">Guardar</button></div>
        </form>`; 
    }
    
    async function handleClientFormSubmit(id) {
        const nif = document.getElementById('clientNif').value.trim();
        const email = document.getElementById('clientEmail').value.trim();

        if (!/^\d{9}$/.test(nif)) {
            showToast('O NIF é obrigatório e deve conter exatamente 9 números.', 'error');
            return;
        }

        if (email && !email.includes('@')) {
            showToast('Por favor, insira um email válido.', 'error');
            return;
        }

        const q = query(collection(db, 'clientes'), where('nif', '==', nif));
        const querySnapshot = await getDocs(q);
        let isDuplicate = false;
        querySnapshot.forEach(doc => {
            if (doc.id !== id) {
                isDuplicate = true;
            }
        });

        if (isDuplicate) {
            showToast('Já existe um cliente com este NIF.', 'error');
            return;
        }

        const managerSelect = document.getElementById('clientManager'); 
        const data = { 
            name: document.getElementById('clientName').value.trim(), 
            email: email, 
            phone: document.getElementById('clientPhone').value.trim(), 
            nif: nif, 
            dob: document.getElementById('clientDob').value,
            address: document.getElementById('clientAddress').value.trim(), 
            postalCode: document.getElementById('clientPostalCode').value.trim(), 
            city: document.getElementById('clientCity').value.trim(), 
            serviceType: document.getElementById('clientServiceType').value, 
            managerId: managerSelect.value, 
            managerName: managerSelect.options[managerSelect.selectedIndex]?.text || '', 
            rgpd: document.getElementById('clientRgpd').value, 
            creationDate: document.getElementById('clientCreationDate').value, 
            internalNotes: document.getElementById('clientInternalNotes').value.trim(), 
            clientType: 'Particular' 
        }; 
        try {
            if (id) {
                await updateDoc(doc(db, 'clientes', id), data);
            } else {
                await addDoc(collection(db, 'clientes'), data);
            }
            showToast(`Cliente ${id ? 'atualizado' : 'adicionado'} com sucesso!`, 'success');
            closeFormModal(); 
            loadClients(); 
            loadDashboardData(); 
        } catch (error) {
            console.error("Erro ao guardar cliente:", error);
            showToast("Erro ao guardar o cliente.", "error");
        }
    }

    async function populateClientForm(id) { 
        await loadComerciaisForDropdown('clientManager'); 
        const docSnap = await getDoc(doc(db, 'clientes', id)); 
        if (docSnap.exists()) { 
            const d = docSnap.data(); 
            document.getElementById('clientName').value = d.name || ''; 
            document.getElementById('clientEmail').value = d.email || ''; 
            document.getElementById('clientPhone').value = d.phone || ''; 
            document.getElementById('clientNif').value = d.nif || ''; 
            document.getElementById('clientDob').value = d.dob || '';
            document.getElementById('clientAddress').value = d.address || ''; 
            document.getElementById('clientPostalCode').value = d.postalCode || ''; 
            document.getElementById('clientCity').value = d.city || ''; 
            document.getElementById('clientServiceType').value = d.serviceType || ''; 
            document.getElementById('clientManager').value = d.managerId || ''; 
            document.getElementById('clientRgpd').value = d.rgpd || 'Não'; 
            document.getElementById('clientCreationDate').value = d.creationDate || ''; 
            document.getElementById('clientInternalNotes').value = d.internalNotes || ''; 
        } 
    }
    
    // --- CONTRATOS ---
    function getContractFormHTML() { 
        let insuranceOptions = '<option value="">Selecione o Ramo</option>';
        for(const type in insuranceTypes) {
            insuranceOptions += `<option value="${type}">${type}</option>`;
        }
    
        return `<form id="contractForm">
            <div class="row">
                <div class="col"><label>Cliente*</label><select id="contractClient" required></select></div>
                <div class="col"><label>Data do Contrato*</label><input type="date" id="contractDate" required></div>
                <div class="col"><label>Comercial*</label><select id="contractCommercial" required></select></div>
            </div>
            <div class="row">
                <div class="col"><label>Tipo de Serviço*</label>
                    <select id="contractType" onchange="handleContractTypeChange(this.value)" required>
                        <option value="">Selecione Tipo de Serviço</option>
                        <option value="Crédito">Crédito</option>
                        <option value="Seguro">Seguro</option>
                        <option value="Legalização Automóvel">Legalização Automóvel</option>
                        <option value="Consultoria Financeira">Consultoria Financeira</option>
                    </select>
                </div>
                 <div class="col"><label>Fase do Contrato</label>
                    <select id="contractFase">
                        <option value="Proposta">Proposta</option>
                        <option value="Ativo">Ativo</option>
                        <option value="Cancelado">Cancelado</option>
                    </select>
                </div>
            </div>

            <!-- Detalhes Crédito -->
            <div id="detailsCredito" class="service-details">
                <h4>Detalhes do Crédito</h4>
                 <div class="row">
                    <div class="col"><label>Nº Proposta</label><input type="text" id="creditoProposta"></div>
                </div>
                <div class="row">
                    <div class="col"><label>Fornecedor</label><select id="creditoFornecedor"></select></div>
                    <div class="col"><label>Financeira</label><select id="creditoFinanceira"></select></div>
                </div>
                <div class="row">
                    <div class="col">
                        <label>Tipo de Crédito</label>
                        <select id="creditoTipo" onchange="handleCreditTypeChange(this.value)">
                            <option value="">Selecione</option>
                            <option value="Automovel">Automóvel</option>
                            <option value="Consumo">Consumo</option>
                            <option value="Habitacao">Habitação</option>
                        </select>
                    </div>
                    <div class="col"><label>Valor Financiado (€)</label><input type="number" id="creditoValorFinanciado" oninput="calculateComissaoPagar()"></div>
                </div>
                
                <!-- Campos Dinâmicos para Tipo de Crédito -->
                <div id="creditoAutomovelFields" class="credit-type-details"><label>Matrícula</label><input type="text" id="creditoMatricula"></div>
                <div id="creditoConsumoFields" class="credit-type-details"><label>Artigo</label><input type="text" id="creditoArtigo"></div>
                <div id="creditoHabitacaoFields" class="credit-type-details row">
                    <div class="col"><label>Código Postal</label><input type="text" id="creditoHabitacaoCP"></div>
                    <div class="col"><label>Área (m²)</label><input type="number" id="creditoHabitacaoArea"></div>
                </div>

                <div class="row">
                    <div class="col"><label>Comissão (%)</label><input type="number" id="creditoComissaoPercent" step="0.01" oninput="calculateComissaoPagar()"></div>
                    <div class="col"><label>Comissão a Pagar</label><input type="text" id="creditoComissaoPagar" readonly style="background-color: #eee;"></div>
                </div>
                <div class="row">
                    <div class="col"><label>Comissão Recebida (€)</label><input type="number" id="creditoComissaoRecebida" step="0.01"></div>
                </div>
                 <div class="row">
                    <div class="col"><label>Data entrega fornecedor</label><input type="date" id="creditoDataFornecedor"></div>
                    <div class="col"><label>Data entrega financeira</label><input type="date" id="creditoDataFinanceira"></div>
                </div>
                <label><input type="checkbox" id="creditoDocsFaltaCheck" onchange="document.getElementById('creditoDocsFaltaContainer').style.display = this.checked ? 'block' : 'none'"> Documentos em falta?</label>
                <div id="creditoDocsFaltaContainer" style="display:none;"><textarea id="creditoDocsFalta" rows="2" placeholder="Especificar documentos..."></textarea></div>
                <h4>Checklist Documentos</h4>
                <div class="checklist">
                    <label><input type="checkbox" name="creditoChecklist" value="Livrete"> Livrete</label>
                    <label><input type="checkbox" name="creditoChecklist" value="Contrato"> Contrato</label>
                    <label><input type="checkbox" name="creditoChecklist" value="DUA"> DUA</label>
                    <label><input type="checkbox" name="creditoChecklist" value="DAV"> DAV</label>
                    <label><input type="checkbox" name="creditoChecklist" value="MUA de compra"> MUA de compra</label>
                    <label><input type="checkbox" name="creditoChecklist" value="MUA de venda"> MUA de venda</label>
                    <label><input type="checkbox" name="creditoChecklist" value="Extinção de reserva"> Extinção de reserva</label>
                </div>
                <label style="margin-top: 1em;"><input type="checkbox" id="creditoRealizado"> Crédito realizado?</label>
            </div>

            <!-- Detalhes Seguro -->
            <div id="detailsSeguro" class="service-details">
                <h4>Detalhes do Seguro</h4>
                <div class="row">
                    <div class="col"><label>Tipo de Seguro</label><select id="seguroTipo" onchange="calculateSeguroComissao()">${insuranceOptions}</select></div>
                    <div class="col"><label>Seguradora</label><select id="seguroSeguradora"></select></div>
                </div>
                <div class="row">
                    <div class="col"><label>Nº Apólice</label><input type="text" id="seguroApolice"></div>
                    <div class="col"><label>Matrícula</label><input type="text" id="seguroMatricula"></div>
                </div>
                <div class="row">
                    <div class="col"><label>Prémio Comercial (€)</label><input type="number" id="seguroPremioComercial" oninput="calculateSeguroComissao()"></div>
                    <div class="col"><label>Fracionamento</label>
                        <select id="seguroFracionamento" onchange="calculateSeguroComissao()">
                            <option value="Anual">Anual</option>
                            <option value="Semestral">Semestral</option>
                            <option value="Trimestral">Trimestral</option>
                            <option value="Mensal">Mensal</option>
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div class="col"><label>Comissão Recebida (€)</label><input type="number" id="seguroComissao" readonly style="background-color: #eee;"></div>
                </div>
                <label><input type="checkbox" id="seguroIsFreelancer" onchange="document.getElementById('seguroFreelancerContainer').style.display = this.checked ? 'block' : 'none'"> Freelancer?</label>
                <div id="seguroFreelancerContainer" style="display:none;"><input type="text" id="seguroFreelancerName" placeholder="Nome do Freelancer"></div>
            </div>

            <!-- Detalhes Legalização Automóvel -->
            <div id="detailsLegalizacao" class="service-details">
                <h4>Detalhes da Legalização</h4>
                <div class="row">
                    <div class="col"><label>Nº Chassis</label><input type="text" id="legalizacaoChassis"></div>
                    <div class="col"><label>Matrícula Estrangeira</label><input type="text" id="legalizacaoMatricula"></div>
                </div>
                <div class="row">
                    <div class="col"><label>País de Importação</label><input type="text" id="legalizacaoPais"></div>
                    <div class="col"><label>Data Estimada de Conclusão</label><input type="date" id="legalizacaoDataConclusao"></div>
                </div>
            </div>

            <!-- Detalhes Consultoria Financeira -->
            <div id="detailsConsultoria" class="service-details">
                <h4>Detalhes da Consultoria</h4>
                <label>Diagnóstico Financeiro Feito?</label>
                <select id="consultoriaDiagnostico"><option value="Não">Não</option><option value="Sim">Sim</option></select>
                <label>Situação Atual (Rendimentos, despesas, dívidas)</label>
                <textarea id="consultoriaSituacao" rows="3"></textarea>
                <label>Data da Sessão</label>
                <input type="date" id="consultoriaDataSessao">
                <label>Ações a Implementar</label>
                <textarea id="consultoriaAcoes" rows="3"></textarea>
            </div>

            <div class="modal-footer"><button type="button" class="btn-secondary" onclick="closeFormModal()">Cancelar</button><button type="submit" class="btn-primary">Guardar Contrato</button></div>
        </form>`; 
    }

    const calculateSeguroComissao = window.calculateSeguroComissao = () => {
        const tipoSeguro = document.getElementById('seguroTipo').value;
        const premioComercial = parseFloat(document.getElementById('seguroPremioComercial').value) || 0;
        const fracionamento = document.getElementById('seguroFracionamento').value;

        if (!tipoSeguro || !premioComercial || !fracionamento) {
            document.getElementById('seguroComissao').value = 0;
            return;
        }

        const comissaoPercent = insuranceTypes[tipoSeguro] || 0;
        let fatorFracionamento = 1;
        switch(fracionamento) {
            case 'Semestral': fatorFracionamento = 2; break;
            case 'Trimestral': fatorFracionamento = 4; break;
            case 'Mensal': fatorFracionamento = 12; break;
        }

        const comissaoCalculada = (premioComercial * (comissaoPercent / 100)) / fatorFracionamento;
        document.getElementById('seguroComissao').value = comissaoCalculada.toFixed(2);
    }

    const handleContractTypeChange = window.handleContractTypeChange = async (serviceType) => {
        document.querySelectorAll('.service-details').forEach(div => div.style.display = 'none');
        if (serviceType === 'Crédito') {
            document.getElementById('detailsCredito').style.display = 'block';
            await loadPartnersForDropdown('fornecedores', 'creditoFornecedor');
            await loadPartnersForDropdown('financeiras', 'creditoFinanceira');
        }
        if (serviceType === 'Seguro') {
            document.getElementById('detailsSeguro').style.display = 'block';
            await loadPartnersForDropdown('seguradoras', 'seguroSeguradora');
        }
        if (serviceType === 'Legalização Automóvel') document.getElementById('detailsLegalizacao').style.display = 'block';
        if (serviceType === 'Consultoria Financeira') document.getElementById('detailsConsultoria').style.display = 'block';
    }

    const handleCreditTypeChange = window.handleCreditTypeChange = (creditType) => {
        document.querySelectorAll('.credit-type-details').forEach(div => div.style.display = 'none');
        if(creditType) {
            document.getElementById(`credito${creditType}Fields`).style.display = 'block';
        }
    }

    const calculateComissaoPagar = window.calculateComissaoPagar = () => {
        const valorFinanciado = parseFloat(document.getElementById('creditoValorFinanciado').value) || 0;
        const comissaoPercent = parseFloat(document.getElementById('creditoComissaoPercent').value) || 0;
        const comissaoPagar = valorFinanciado * (comissaoPercent / 100);
        document.getElementById('creditoComissaoPagar').value = comissaoPagar.toLocaleString('pt-PT', { style: 'currency', currency: 'EUR' });
    }

    async function loadPartnersForDropdown(type, selectId) {
        const select = document.getElementById(selectId);
        if (!select) return;
        select.innerHTML = '<option value="">Selecione</option>';
        const q = query(collection(db, type), orderBy('name'));
        const snapshot = await getDocs(q);
        snapshot.forEach(doc => {
            select.innerHTML += `<option value="${doc.id}">${doc.data().name}</option>`;
        });
    }

    async function handleContractFormSubmit(id) {
        const clientSelect = document.getElementById('contractClient');
        const commercialSelect = document.getElementById('contractCommercial');
        const contractType = document.getElementById('contractType').value;
        const startDate = document.getElementById('contractDate').value;

        if (!startDate) {
            showToast('A data de início do contrato é obrigatória.', 'error');
            return;
        }

        let data = {
            clientId: clientSelect.value,
            clientName: clientSelect.options[clientSelect.selectedIndex]?.text || '',
            commercialId: commercialSelect.value,
            commercialName: commercialSelect.options[commercialSelect.selectedIndex]?.text || '',
            type: contractType,
            fase: document.getElementById('contractFase').value,
            startDate: startDate,
            commissionStatus: 'Não Paga'
        };

        if (contractType === 'Crédito') {
            const creditoTipo = document.getElementById('creditoTipo').value;
            Object.assign(data, {
                numeroProposta: document.getElementById('creditoProposta').value,
                fornecedorId: document.getElementById('creditoFornecedor').value,
                financeiraId: document.getElementById('creditoFinanceira').value,
                valorFinanciado: document.getElementById('creditoValorFinanciado').value,
                comissaoPercent: document.getElementById('creditoComissaoPercent').value,
                comissaoPagar: (parseFloat(document.getElementById('creditoValorFinanciado').value || 0) * parseFloat(document.getElementById('creditoComissaoPercent').value || 0) / 100),
                comissaoRecebida: document.getElementById('creditoComissaoRecebida').value,
                dataEntregaFornecedor: document.getElementById('creditoDataFornecedor').value,
                dataEntregaFinanceira: document.getElementById('creditoDataFinanceira').value,
                documentosEmFalta: document.getElementById('creditoDocsFaltaCheck').checked,
                documentosEmFaltaDesc: document.getElementById('creditoDocsFalta').value,
                checklistDocs: Array.from(document.querySelectorAll('input[name="creditoChecklist"]:checked')).map(cb => cb.value),
                creditoRealizado: document.getElementById('creditoRealizado').checked,
                creditoTipo: creditoTipo
            });

            if (creditoTipo === 'Automovel') {
                data.creditoMatricula = document.getElementById('creditoMatricula').value;
            } else if (creditoTipo === 'Consumo') {
                data.creditoArtigo = document.getElementById('creditoArtigo').value;
            } else if (creditoTipo === 'Habitacao') {
                data.creditoHabitacaoCP = document.getElementById('creditoHabitacaoCP').value;
                data.creditoHabitacaoArea = document.getElementById('creditoHabitacaoArea').value;
            }
        } else if (contractType === 'Seguro') {
            const fracionamento = document.getElementById('seguroFracionamento').value;
            let nextRenewalDate = new Date(startDate);
            switch (fracionamento) {
                case 'Mensal':
                    nextRenewalDate.setMonth(nextRenewalDate.getMonth() + 1);
                    break;
                case 'Trimestral':
                    nextRenewalDate.setMonth(nextRenewalDate.getMonth() + 3);
                    break;
                case 'Semestral':
                    nextRenewalDate.setMonth(nextRenewalDate.getMonth() + 6);
                    break;
                case 'Anual':
                    nextRenewalDate.setFullYear(nextRenewalDate.getFullYear() + 1);
                    break;
            }
            Object.assign(data, {
                tipoSeguro: document.getElementById('seguroTipo').value,
                seguradoraId: document.getElementById('seguroSeguradora').value,
                apolice: document.getElementById('seguroApolice').value,
                matricula: document.getElementById('seguroMatricula').value,
                premioComercial: document.getElementById('seguroPremioComercial').value,
                fracionamento: fracionamento,
                comissaoRecebida: document.getElementById('seguroComissao').value,
                nextRenewalDate: nextRenewalDate.toISOString().split('T')[0],
                isFreelancer: document.getElementById('seguroIsFreelancer').checked,
                freelancerName: document.getElementById('seguroFreelancerName').value,
            });
        }

        try {
            let contractId = id;
            if (id) {
                await updateDoc(doc(db, 'contratos', id), data);
            } else {
                const newDocRef = await addDoc(collection(db, 'contratos'), data);
                contractId = newDocRef.id;
            }

            // CORREÇÃO: Criar tarefa automaticamente se houver documentos em falta
            if (data.type === 'Crédito' && data.documentosEmFalta && data.documentosEmFaltaDesc) {
                const q = query(collection(db, 'tarefas'),
                    where('contractId', '==', contractId),
                    where('autoTaskType', '==', 'documentos_em_falta'));
                const existingTaskSnapshot = await getDocs(q);

                if (existingTaskSnapshot.empty) {
                    const taskData = {
                        title: `Documentos em falta: Contrato ${data.clientName}`,
                        description: data.documentosEmFaltaDesc,
                        owner: data.commercialName,
                        dueDate: new Date(new Date().setDate(new Date().getDate() + 7)).toISOString().split('T')[0], // Prazo de 7 dias
                        priority: 'Alta',
                        status: 'Pendente',
                        clientId: data.clientId,
                        contractId: contractId,
                        autoTaskType: 'documentos_em_falta'
                    };
                    await addDoc(collection(db, 'tarefas'), taskData);
                    showToast('Tarefa para documentos em falta criada automaticamente.', 'info');
                }
            }

            showToast(`Contrato ${id ? 'atualizado' : 'adicionado'} com sucesso!`, 'success');
            closeFormModal();
            loadContracts();
            loadDashboardData();
            loadTasks(); // Recarregar tarefas
        } catch (error) {
            console.error("Erro ao guardar contrato:", error);
            showToast("Erro ao guardar contrato.", "error");
        }
    }


    async function populateContractForm(id) { 
        const docSnap = await getDoc(doc(db, 'contratos', id)); 
        if (docSnap.exists()) { 
            const d = docSnap.data(); 
            document.getElementById('contractClient').value = d.clientId || ''; 
            document.getElementById('contractCommercial').value = d.commercialId || ''; 
            document.getElementById('contractType').value = d.type || ''; 
            document.getElementById('contractFase').value = d.fase || 'Proposta'; 
            document.getElementById('contractDate').value = d.startDate || ''; 

            await handleContractTypeChange(d.type);

            if (d.type === 'Crédito') {
                document.getElementById('creditoProposta').value = d.numeroProposta || '';
                document.getElementById('creditoFornecedor').value = d.fornecedorId || '';
                document.getElementById('creditoFinanceira').value = d.financeiraId || '';
                document.getElementById('creditoValorFinanciado').value = d.valorFinanciado || '';
                document.getElementById('creditoComissaoPercent').value = d.comissaoPercent || '';
                document.getElementById('creditoComissaoRecebida').value = d.comissaoRecebida || '';
                document.getElementById('creditoDataFornecedor').value = d.dataEntregaFornecedor || '';
                document.getElementById('creditoDataFinanceira').value = d.dataEntregaFinanceira || '';
                document.getElementById('creditoDocsFaltaCheck').checked = d.documentosEmFalta || false;
                document.getElementById('creditoDocsFalta').value = d.documentosEmFaltaDesc || '';
                document.getElementById('creditoRealizado').checked = d.creditoRealizado || false;
                if(d.creditoTipo) {
                    document.getElementById('creditoTipo').value = d.creditoTipo;
                    handleCreditTypeChange(d.creditoTipo);
                    if (d.creditoTipo === 'Automovel') {
                        document.getElementById('creditoMatricula').value = d.creditoMatricula || '';
                    } else if (d.creditoTipo === 'Consumo') {
                        document.getElementById('creditoArtigo').value = d.creditoArtigo || '';
                    } else if (d.creditoTipo === 'Habitacao') {
                        document.getElementById('creditoHabitacaoCP').value = d.creditoHabitacaoCP || '';
                        document.getElementById('creditoHabitacaoArea').value = d.creditoHabitacaoArea || '';
                    }
                }
                calculateComissaoPagar();
            }
            else if (d.type === 'Seguro') {
                document.getElementById('seguroTipo').value = d.tipoSeguro || '';
                document.getElementById('seguroSeguradora').value = d.seguradoraId || '';
                document.getElementById('seguroApolice').value = d.apolice || '';
                document.getElementById('seguroMatricula').value = d.matricula || '';
                document.getElementById('seguroPremioComercial').value = d.premioComercial || '';
                document.getElementById('seguroFracionamento').value = d.fracionamento || 'Anual';
                document.getElementById('seguroComissao').value = d.comissaoRecebida || '';
                if (d.isFreelancer) {
                    document.getElementById('seguroIsFreelancer').checked = true;
                    document.getElementById('seguroFreelancerContainer').style.display = 'block';
                    document.getElementById('seguroFreelancerName').value = d.freelancerName || '';
                }
            }
        } 
    }
    
    async function loadContractDropdowns(callback) { await loadClientsForDropdown('contractClient'); await loadComerciaisForDropdown('contractCommercial'); if (callback) callback(); }
    async function loadAssociatedContracts(clientId) { 
        const container = document.getElementById('associatedContracts'); 
        container.innerHTML = ''; 
        const q = query(collection(db, 'contratos'), where('clientId', '==', clientId));
        const snapshot = await getDocs(q); 
        if (snapshot.empty) { 
            container.innerHTML = '<p>Nenhum contrato associado.</p>'; 
            return; 
        } 
        let html = '<ul style="list-style: none; padding: 0;">'; 
        snapshot.forEach(doc => { 
            const d = doc.data(); 
            html += `<li style="margin-bottom: .5em;">${d.type} - Fase: ${d.fase} (Início: ${d.startDate})</li>`; 
        }); 
        html += '</ul>'; 
        container.innerHTML = html; 
    }
    function getTaskFormHTML() { return `<form id="taskForm"><label>Título da tarefa</label><input type="text" id="taskTitle" required /><label>Descrição</label><textarea id="taskDescription" rows="3"></textarea><div class="row"><div class="col"><label>Responsável</label><input type="text" id="taskOwner" /></div><div class="col"><label>Prazo</label><input type="date" id="taskDueDate" /></div></div><div class="row"><div class="col"><label>Prioridade</label><select id="taskPriority"><option value="Baixa">Baixa</option><option value="Média" selected>Média</option><option value="Alta">Alta</option></select></div><div class="col"><label>Estado</label><select id="taskStatus"><option value="Pendente">Pendente</option><option value="Em Andamento">Em Andamento</option><option value="Concluído">Concluído</option></select></div></div><div class="row"><div class="col"><label>Associar a Cliente (Opcional)</label><select id="taskClient"><option value="">Nenhum</option></select></div><div class="col"><label>Associar a Contrato (Opcional)</label><select id="taskContract"><option value="">Nenhum</option></select></div></div><div class="modal-footer"><button type="button" class="btn-secondary" onclick="closeFormModal()">Cancelar</button><button type="submit" class="btn-primary">Guardar</button></div></form>`; }
    async function handleTaskFormSubmit(id) { 
        const data = { 
            title: document.getElementById('taskTitle').value.trim(), 
            description: document.getElementById('taskDescription').value.trim(), 
            owner: document.getElementById('taskOwner').value.trim(), 
            dueDate: document.getElementById('taskDueDate').value, 
            priority: document.getElementById('taskPriority').value, 
            status: document.getElementById('taskStatus').value, 
            clientId: document.getElementById('taskClient').value, 
            contractId: document.getElementById('taskContract').value, 
            createdAt: id ? null : serverTimestamp() // Adiciona timestamp na criação
        }; 
        if(id) delete data.createdAt; // Não atualiza o timestamp

        try {
            if (id) {
                await updateDoc(doc(db, 'tarefas', id), data);
            } else {
                await addDoc(collection(db, 'tarefas'), data);
            }
            const note = `Tarefa '${data.title}' foi ${id ? 'atualizada' : 'criada'} com estado '${data.status}'.`; 
            if (data.clientId) { handleInteractionSubmit('clientes', data.clientId, note); } 
            if (data.contractId) { handleInteractionSubmit('contratos', data.contractId, note); } 
            showToast(`Tarefa guardada com sucesso!`, 'success');
            closeFormModal(); 
            loadTasks(); 
            loadDashboardData(); 
        } catch (error) {
            console.error("Erro ao guardar tarefa:", error);
            showToast("Erro ao guardar tarefa.", "error");
        }
    }
    async function populateTaskForm(id) { 
        const docSnap = await getDoc(doc(db, 'tarefas', id)); 
        if (docSnap.exists()) { 
            const d = docSnap.data(); 
            document.getElementById('taskTitle').value = d.title || ''; 
            document.getElementById('taskDescription').value = d.description || ''; 
            document.getElementById('taskOwner').value = d.owner || ''; 
            document.getElementById('taskDueDate').value = d.dueDate || ''; 
            document.getElementById('taskPriority').value = d.priority || 'Média'; 
            document.getElementById('taskStatus').value = d.status || 'Pendente'; 
            document.getElementById('taskClient').value = d.clientId || ''; 
            document.getElementById('taskContract').value = d.contractId || ''; 
        } 
    }
    async function loadDropdownsForTaskForm(callback) { await loadClientsForDropdown('taskClient'); await loadContractsForDropdown('taskContract'); if(callback) callback(); }
    async function loadClientsForDropdown(selectId) { 
        const select = document.getElementById(selectId); 
        if (!select) return; 
        select.innerHTML = '<option value="">Selecione</option>'; 
        const q = query(collection(db, 'clientes'), orderBy('name'));
        const snapshot = await getDocs(q); 
        snapshot.forEach(doc => { 
            select.innerHTML += `<option value="${doc.id}">${doc.data().name}</option>`; 
        }); 
    }
    async function loadContractsForDropdown(selectId) { 
        const select = document.getElementById(selectId); 
        if (!select) return; 
        select.innerHTML = '<option value="">Nenhum</option>'; 
        const q = query(collection(db, 'contratos'), orderBy('clientName'));
        const snapshot = await getDocs(q); 
        snapshot.forEach(doc => { 
            const d = doc.data(); 
            select.innerHTML += `<option value="${doc.id}">${d.type} - ${d.clientName}</option>`; 
        }); 
    }
    const deleteItem = window.deleteItem = (collectionName, id, name, callback) => { 
        showConfirmModal(`Tem a certeza que quer eliminar "${name}"?`, async () => { 
            await deleteDoc(doc(db, collectionName, id)); 
            showToast(`"${name}" eliminado com sucesso.`, 'info');
            callback(); 
            loadDashboardData(); 
        }); 
    }
    function getFornecedorFormHTML() { 
        return `<form id="partnerForm">
            <div class="row">
                <div class="col"><label>Nome</label><input id="partnerName" required></div>
                <div class="col"><label>NIF</label><input id="partnerNif"></div>
                <div class="col"><label>IBAN</label><input id="partnerIban"></div>
            </div>
            <div class="row">
                <div class="col"><label>Morada</label><input id="partnerAddress"></div>
                <div class="col"><label>Código Postal</label><input id="partnerPostalCode"></div>
                <div class="col"><label>Localidade</label><input id="partnerCity"></div>
            </div>
            <div class="row">
                <div class="col"><label>Telefone</label><input id="partnerPhone"></div>
                <div class="col"><label>Email</label><input id="partnerEmail" type="email"></div>
                <div class="col"><label>CAE</label><input id="partnerCae"></div>
            </div>
            <div class="row">
                <div class="col"><label>Capital Social</label><input id="partnerCapital" type="number"></div>
                <div class="col"><label>Pessoa a Contactar</label><input id="partnerContactPerson"></div>
                <div class="col"><label>Certidão Comercial</label><input id="partnerCertidaoComercial" placeholder="1234-1234-1234"></div>
            </div>
            <div class="row">
                <div class="col"><label>Equipamento</label>
                    <select id="partnerEquipment">
                        <option>AUTO</option>
                        <option>MOTAS</option>
                        <option>EQUIPAMENTO</option>
                        <option>CONSUMO SAUDE</option>
                        <option>CONSUMO LAR</option>
                        <option>CONSUMO OUTROS</option>
                        <option>SERVICOS</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer"><button type="button" class="btn-secondary" onclick="closeFormModal()">Cancelar</button><button type="submit" class="btn-primary">Guardar</button></div>
        </form>`; 
    }
    function getFinanceiraFormHTML() { return `<form id="partnerForm"><div class="row"><div class="col"><label>Nome da Financeira</label><input id="partnerName" required></div><div class="col"><label>Morada</label><input id="partnerAddress"></div></div><div class="row"><div class="col"><label>NIF</label><input id="partnerNif"></div><div class="col"><label>Nome do Comercial</label><input id="partnerCommercialName"></div></div><div class="row"><div class="col"><label>Data Nascimento Comercial</label><input id="partnerCommercialDob" type="date"></div><div class="col"><label>Contacto Comercial</label><input id="partnerCommercialContact"></div></div><div class="row"><div class="col"><label>Email Comercial</label><input id="partnerCommercialEmail" type="email"></div><div class="col"><label>Email Comissões</label><input id="partnerCommissionEmail" type="email"></div></div><div class="modal-footer"><button type="button" class="btn-secondary" onclick="closeFormModal()">Cancelar</button><button type="submit" class="btn-primary">Guardar</button></div></form>`; }
    function getSeguradoraFormHTML() { return `<form id="partnerForm"><div class="row"><div class="col"><label>Nome da Seguradora</label><input id="partnerName" required></div><div class="col"><label>Morada</label><input id="partnerAddress"></div></div><div class="row"><div class="col"><label>NIF</label><input id="partnerNif"></div><div class="col"><label>Nome do Comercial</label><input id="partnerCommercialName"></div></div><div class="row"><div class="col"><label>Data Nascimento Comercial</label><input id="partnerCommercialDob" type="date"></div><div class="col"><label>Contacto Comercial</label><input id="partnerCommercialContact"></div><div class="col"><label>Email Comercial</label><input id="partnerCommercialEmail" type="email"></div></div><div class="modal-footer"><button type="button" class="btn-secondary" onclick="closeFormModal()">Cancelar</button><button type="submit" class="btn-primary">Guardar</button></div></form>`; }
    async function handleInteractionSubmit(collectionName, docId, note, elementId) { 
        if (!note.trim()) return; 
        const interactionData = { 
            note: note, 
            timestamp: serverTimestamp(), 
            user: currentUserData.firstName || 'Sistema' 
        };
        await addDoc(collection(db, collectionName, docId, 'interactions'), interactionData);
        if(elementId) { 
            loadInteractions(collectionName, docId, elementId); 
        } 
    }
    async function loadInteractions(collectionName, docId, elementId) { 
        const container = document.getElementById(elementId); 
        container.innerHTML = ''; 
        const q = query(collection(db, collectionName, docId, 'interactions'), orderBy('timestamp', 'desc'));
        const snapshot = await getDocs(q); 
        if (snapshot.empty) { 
            container.innerHTML = '<p>Nenhuma interação registada.</p>'; 
            return; 
        } 
        snapshot.forEach(doc => { 
            const d = doc.data(); 
            const date = d.timestamp ? d.timestamp.toDate().toLocaleString('pt-PT') : 'Data inválida'; 
            const item = document.createElement('div'); 
            item.className = 'interaction-item'; 
            item.innerHTML = `<div class="date">${date} por <strong>${d.user || 'Sistema'}</strong></div><div>${d.note}</div>`; 
            container.appendChild(item); 
        }); 
    }
    
    const loadClients = window.loadClients = async (searchTerm = '') => {
        const tableBody = document.getElementById('clientTable').querySelector('tbody');
        tableBody.innerHTML = '<tr><td colspan="5">A carregar clientes...</td></tr>';
        
        let initialQuery;
        if (currentUserData && currentUserData.role === 'Comercial') {
            initialQuery = query(collection(db, 'clientes'), where('managerId', '==', currentUserData.id), orderBy('name'));
        } else {
            initialQuery = query(collection(db, 'clientes'), orderBy('name'));
        }
        
        const snapshot = await getDocs(initialQuery);
        let clients = [];
        snapshot.forEach(doc => {
            clients.push({ id: doc.id, ...doc.data() });
        });
        
        if (searchTerm) {
            const lowerCaseSearchTerm = searchTerm.toLowerCase();
            clients = clients.filter(client => 
                (client.name && client.name.toLowerCase().includes(lowerCaseSearchTerm)) ||
                (client.nif && client.nif.toLowerCase().includes(lowerCaseSearchTerm))
            );
        }

        tableBody.innerHTML = '';
        if (clients.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="5">Nenhum cliente encontrado.</td></tr>';
            return;
        }

        clients.forEach(d => {
            const row = tableBody.insertRow();
            row.innerHTML = `
                <td>${d.name || '-'}</td>
                <td>${d.nif || '-'}</td>
                <td>${d.managerName || '-'}</td>
                <td>${d.rgpd || '-'}</td>
                <td class="actions-cell">
                    <button onclick="openDetailsModal('cliente', '${d.id}')" title="Ver Detalhes"><i class="ph ph-eye"></i></button>
                    <button onclick="openFormModal('cliente', '${d.id}')" title="Editar"><i class="ph ph-pencil-simple"></i></button>
                    <button class="btn-danger" onclick="deleteItem('clientes', '${d.id}', '${d.name}', loadClients)" title="Eliminar"><i class="ph ph-trash"></i></button>
                </td>
            `;
        });
    }

    const loadContracts = window.loadContracts = async (searchTerm = '') => {
        const tableBody = document.getElementById('contractTable').querySelector('tbody');
        tableBody.innerHTML = '<tr><td colspan="7">A carregar contratos...</td></tr>';

        let initialQuery;
        if (currentUserData && currentUserData.role === 'Comercial') {
            initialQuery = query(collection(db, 'contratos'), where('commercialId', '==', currentUserData.id), orderBy('startDate', 'desc'));
        } else {
            initialQuery = query(collection(db, 'contratos'), orderBy('startDate', 'desc'));
        }

        const snapshot = await getDocs(initialQuery);
        let contracts = [];
        snapshot.forEach(doc => {
            contracts.push({ id: doc.id, ...doc.data() });
        });

        if (searchTerm) {
            const lowerCaseSearchTerm = searchTerm.toLowerCase();
            contracts = contracts.filter(contract => 
                (contract.clientName && contract.clientName.toLowerCase().includes(lowerCaseSearchTerm)) ||
                (contract.type && contract.type.toLowerCase().includes(lowerCaseSearchTerm))
            );
        }

        tableBody.innerHTML = '';
        if (contracts.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="7">Nenhum contrato encontrado.</td></tr>';
            return;
        }

        contracts.forEach(d => {
            const row = tableBody.insertRow();
            row.innerHTML = `
                <td>${d.clientName || '-'}</td>
                <td>${d.type || '-'}</td>
                <td>€${parseFloat(d.valorFinanciado || d.value || 0).toLocaleString('pt-PT')}</td>
                <td>${d.fase || '-'}</td>
                <td>${d.startDate || '-'}</td>
                <td>${d.commercialName || '-'}</td>
                <td class="actions-cell">
                    <button onclick="openDetailsModal('contrato', '${d.id}')" title="Ver Detalhes"><i class="ph ph-eye"></i></button>
                    <button onclick="openFormModal('contrato', '${d.id}')" title="Editar"><i class="ph ph-pencil-simple"></i></button>
                    <button class="btn-danger" onclick="deleteItem('contratos', '${d.id}', 'este contrato', loadContracts)" title="Eliminar"><i class="ph ph-trash"></i></button>
                </td>
            `;
        });
    }

    function getComercialFormHTML() { return `<form id="comercialForm"><p style="font-size: .9em; color: var(--color-text-secondary);">Nota: A criação de um novo comercial aqui apenas cria o perfil. O login (email/password) deve ser criado separadamente no painel do Firebase Authentication por um administrador.</p><div class="row"><div class="col"><label>Primeiro Nome</label><input id="comercialFirstName" required></div><div class="col"><label>Último Nome</label><input id="comercialLastName" required></div></div><div class="row"><div class="col"><label>Email (deve corresponder ao login)</label><input id="comercialEmail" type="email" required></div><div class="col"><label>Função</label><select id="comercialRole"><option value="Comercial">Comercial</option><option value="Gestor de Equipa">Gestor de Equipa</option><option value="Administrador">Administrador</option></select></div></div><div class="row"><div class="col"><label>Telefone</label><input id="comercialPhone"></div><div class="col"><label>NIF</label><input id="comercialNif"></div></div><div class="row"><div class="col"><label>IBAN</label><input id="comercialIban"></div></div><div class="row"><div class="col"><label>Data de Início</label><input id="comercialStartDate" type="date"></div><div class="col"><label>Estado</label><select id="comercialStatus"><option value="Ativo">Ativo</option><option value="Inativo">Inativo</option></select></div></div><div class="modal-footer"><button type="button" class="btn-secondary" onclick="closeFormModal()">Cancelar</button><button type="submit" class="btn-primary">Guardar</button></div></form>`;}
    async function handleComercialFormSubmit(id) { 
        const data = { 
            firstName: document.getElementById('comercialFirstName').value, 
            lastName: document.getElementById('comercialLastName').value, 
            name: `${document.getElementById('comercialFirstName').value} ${document.getElementById('comercialLastName').value}`,
            email: document.getElementById('comercialEmail').value, 
            role: document.getElementById('comercialRole').value, 
            phone: document.getElementById('comercialPhone').value, 
            nif: document.getElementById('comercialNif').value, 
            iban: document.getElementById('comercialIban').value, 
            startDate: document.getElementById('comercialStartDate').value, 
            status: document.getElementById('comercialStatus').value, 
        }; 
        try {
            if (id) {
                await updateDoc(doc(db, 'comerciais', id), data);
            } else {
                await addDoc(collection(db, 'comerciais'), data);
            }
            showToast(`Comercial guardado com sucesso!`, 'success');
            closeFormModal(); 
            loadComerciais();
        } catch (error) {
            console.error("Erro ao guardar comercial:", error);
            showToast("Erro ao guardar comercial.", "error");
        }
    }
    async function populateComercialForm(id) { 
        const docSnap = await getDoc(doc(db, 'comerciais', id)); 
        if (docSnap.exists()) { 
            const d = docSnap.data(); 
            document.getElementById('comercialFirstName').value = d.firstName || ''; 
            document.getElementById('comercialLastName').value = d.lastName || ''; 
            document.getElementById('comercialEmail').value = d.email || ''; 
            document.getElementById('comercialRole').value = d.role || 'Comercial'; 
            document.getElementById('comercialPhone').value = d.phone || ''; 
            document.getElementById('comercialNif').value = d.nif || ''; 
            document.getElementById('comercialIban').value = d.iban || ''; 
            document.getElementById('comercialStartDate').value = d.startDate || ''; 
            document.getElementById('comercialStatus').value = d.status || 'Ativo'; 
        } 
    }
    const loadComerciais = window.loadComerciais = async () => {
        if (!currentUserData || currentUserData.role !== 'Administrador') return;
        const tableBody = document.getElementById('comerciaisTable').querySelector('tbody');
        tableBody.innerHTML = '';
        const q = query(collection(db, 'comerciais'), orderBy('firstName'));
        const snapshot = await getDocs(q);
        snapshot.forEach(docSnap => {
            const d = docSnap.data();
            const row = tableBody.insertRow();
            row.innerHTML = `
                <td>${d.firstName} ${d.lastName}</td>
                <td>${d.email || '-'}</td>
                <td>${d.phone || '-'}</td>
                <td>${d.role || 'N/D'}</td>
                <td><span style="color: ${d.status === 'Ativo' ? 'var(--color-success)' : 'var(--color-danger)'}">${d.status}</span></td>
                <td class="actions-cell">
                    <button onclick="toggleComercialStatus('${docSnap.id}', '${d.status}')" title="${d.status === 'Ativo' ? 'Desativar' : 'Ativar'}"><i class="ph ph-power"></i></button>
                    <button onclick="openFormModal('comercial', '${docSnap.id}')" title="Editar"><i class="ph ph-pencil-simple"></i></button>
                </td>
            `;
        });
    }
    const toggleComercialStatus = window.toggleComercialStatus = async (id, currentStatus) => {
        const newStatus = currentStatus === 'Ativo' ? 'Inativo' : 'Ativo';
        await updateDoc(doc(db, 'comerciais', id), { status: newStatus });
        showToast(`Estado do comercial alterado para ${newStatus}.`, 'info');
        loadComerciais();
    }
    async function loadComerciaisForDropdown(selectId) {
        const select = document.getElementById(selectId);
        if (!select) return;
        select.innerHTML = '<option value="">Selecione</option>';
        const q = query(collection(db, 'comerciais'), where('status', '==', 'Ativo'));
        const snapshot = await getDocs(q);
        
        let comerciais = [];
        snapshot.forEach(doc => {
            comerciais.push({ id: doc.id, ...doc.data() });
        });

        comerciais.sort((a, b) => a.firstName.localeCompare(b.firstName));

        comerciais.forEach(d => {
            select.innerHTML += `<option value="${d.id}">${d.firstName} ${d.lastName}</option>`;
        });
    }

    // --- GESTÃO FINANCEIRA ---
    const openFinanceTab = window.openFinanceTab = (evt, tabName) => {
        document.querySelectorAll('#financeira-section > .tab-content').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('#financeira-section > .tabs button').forEach(btn => btn.classList.remove('active'));
        document.getElementById(tabName).classList.add('active');
        evt.currentTarget.classList.add('active');

        if(tabName === 'financeira-dashboard') loadFinanceiraDashboard();
        if(tabName === 'financeira-comissoes') openComissaoSubTab({currentTarget: document.querySelector('#financeira-comissoes .tabs button.active') || document.querySelector('#financeira-comissoes .tabs button')}, 'comissoes-contratos');
        if(tabName === 'financeira-despesas') loadDespesas();
        if(tabName === 'financeira-por-conciliar') loadPorConciliar();
        if(tabName === 'financeira-banco') openBancoSubTab({currentTarget: document.querySelector('#financeira-banco .tabs button.active') || document.querySelector('#financeira-banco .tabs button')}, 'contas');
    }
    
    const openComissaoSubTab = window.openComissaoSubTab = (evt, tabName) => {
        document.querySelectorAll('#financeira-comissoes .tab-content').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('#financeira-comissoes .tabs button').forEach(btn => btn.classList.remove('active'));
        document.getElementById(tabName).classList.add('active');
        evt.currentTarget.classList.add('active');
        if(tabName === 'comissoes-contratos') loadComissoes();
        if(tabName === 'comissoes-outros-ganhos') loadOutrosGanhos();
    }

    const openBancoSubTab = window.openBancoSubTab = (evt, tabName) => {
        document.querySelectorAll('#financeira-banco .tab-content').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('#financeira-banco .tabs button').forEach(btn => btn.classList.remove('active'));
        document.getElementById(tabName).classList.add('active');
        
        if (evt && evt.currentTarget) {
            evt.currentTarget.classList.add('active');
        }
        
        if (tabName === 'contas') loadBancos();
        if (tabName === 'movimentos') loadMovimentos();
    }

    const loadFinanceiraModule = window.loadFinanceiraModule = () => {
        loadFinanceiraDashboard();
        const financeTabs = document.querySelector('#finance-tabs');
        if (financeTabs) {
            financeTabs.querySelector('button').classList.add('active');
            document.getElementById('financeira-dashboard').classList.add('active');
        }
    }
    
    async function loadFinanceiraDashboard() {
        const today = new Date();
        const currentMonth = today.getMonth();
        const currentYear = today.getFullYear();

        const contratosSnapshot = await getDocs(query(collection(db, 'contratos'), where('fase', '==', 'Ativo')));
        const despesasSnapshot = await getDocs(collection(db, 'despesas'));
        const outrosGanhosSnapshot = await getDocs(collection(db, 'outrosGanhos'));
        
        let comissoesCredito = 0;
        let comissoesSeguros = 0;
        let outrosGanhos = 0;
        let aReceberFinanceira = {};
        let aPagarFornecedor = {};

        contratosSnapshot.forEach(doc => {
            const d = doc.data();
            const contractDate = new Date(d.startDate);
            if (contractDate.getMonth() !== currentMonth || contractDate.getFullYear() !== currentYear) return;

            if(d.type === 'Crédito') {
                comissoesCredito += parseFloat(d.comissaoRecebida || 0);
                if(d.financeiraId) {
                    aReceberFinanceira[d.financeiraId] = (aReceberFinanceira[d.financeiraId] || 0) + parseFloat(d.comissaoRecebida || 0);
                }
                if(d.fornecedorId) {
                    aPagarFornecedor[d.fornecedorId] = (aPagarFornecedor[d.fornecedorId] || 0) + parseFloat(d.comissaoPagar || 0);
                }
            } else if (d.type === 'Seguro') {
                comissoesSeguros += parseFloat(d.comissaoRecebida || 0);
            }
        });

        outrosGanhosSnapshot.forEach(doc => {
            const d = doc.data();
            const ganhoDate = new Date(d.date);
             if (ganhoDate.getMonth() === currentMonth && ganhoDate.getFullYear() === currentYear) {
                outrosGanhos += parseFloat(d.valorBruto || 0);
             }
        });

        document.getElementById('kpi-comissoes-credito').textContent = `€${comissoesCredito.toLocaleString('pt-PT', {minimumFractionDigits: 2})}`;
        document.getElementById('kpi-comissoes-seguros').textContent = `€${comissoesSeguros.toLocaleString('pt-PT', {minimumFractionDigits: 2})}`;
        document.getElementById('kpi-outros-ganhos').textContent = `€${outrosGanhos.toLocaleString('pt-PT', {minimumFractionDigits: 2})}`;
        
        let totalDespesas = 0;
        despesasSnapshot.forEach(doc => {
             const despesaDate = new Date(doc.data().date);
             if (despesaDate.getMonth() === currentMonth && despesaDate.getFullYear() === currentYear) {
                totalDespesas += parseFloat(doc.data().value || 0);
             }
        });
        document.getElementById('kpi-total-despesas').textContent = `€${totalDespesas.toLocaleString('pt-PT', {minimumFractionDigits: 2})}`;

        const tableReceberBody = document.getElementById('financeirasReceberTable').querySelector('tbody');
        tableReceberBody.innerHTML = '';
        for(const id in aReceberFinanceira) {
            const name = partnersData.financeiras[id] || 'Desconhecida';
            tableReceberBody.innerHTML += `<tr><td>${name}</td><td>€${aReceberFinanceira[id].toLocaleString('pt-PT')}</td></tr>`;
        }
        if (tableReceberBody.innerHTML === '') tableReceberBody.innerHTML = '<tr><td colspan="2">Nenhum valor a receber este mês.</td></tr>';

        const tablePagarBody = document.getElementById('fornecedoresPagarTable').querySelector('tbody');
        tablePagarBody.innerHTML = '';
        for(const id in aPagarFornecedor) {
            const name = partnersData.fornecedores[id] || 'Desconhecido';
            tablePagarBody.innerHTML += `<tr><td>${name}</td><td>€${aPagarFornecedor[id].toLocaleString('pt-PT')}</td></tr>`;
        }
        if (tablePagarBody.innerHTML === '') tablePagarBody.innerHTML = '<tr><td colspan="2">Nenhum valor a pagar este mês.</td></tr>';
    }

    const loadDespesas = window.loadDespesas = async () => {
        const tableBody = document.getElementById('despesasTable').querySelector('tbody');
        tableBody.innerHTML = '';
        const q = query(collection(db, 'despesas'), orderBy('date', 'desc'));
        const snapshot = await getDocs(q);
        snapshot.forEach(docSnap => {
            const d = docSnap.data();
            const row = tableBody.insertRow();
            row.innerHTML = `
                <td>${d.date}</td>
                <td>${d.description}</td>
                <td>${d.type}</td>
                <td>${d.bancoName || '-'}</td>
                <td>€${parseFloat(d.value || 0).toLocaleString('pt-PT')}</td>
                <td><input type="checkbox" ${d.isConciliada ? 'checked' : ''} disabled></td>
                <td class="actions-cell">
                    <button onclick="openFormModal('despesa', '${docSnap.id}')" title="Editar"><i class="ph ph-pencil-simple"></i></button>
                    <button class="btn-danger" onclick="deleteItem('despesas', '${docSnap.id}', 'esta despesa', loadDespesas)" title="Eliminar"><i class="ph ph-trash"></i></button>
                </td>
            `;
        });
    }
    
    function getDespesaFormHTML() {
        return `<form id="despesaForm">
            <div class="row">
                <div class="col"><label>Data</label><input type="date" id="despesaDate" required></div>
                <div class="col"><label>Valor</label><input type="number" id="despesaValue" step="0.01" required></div>
            </div>
            <label>Descrição</label><input type="text" id="despesaDescription" required>
            <div class="row">
                <div class="col"><label>Tipo de Despesa</label>
                    <select id="despesaType" required onchange="handleDespesaTypeChange(this.value)">
                        <option value="Renda">Renda</option>
                        <option value="Comunicações">Comunicações</option>
                        <option value="Material de Escritório">Material de Escritório</option>
                        <option value="Transporte">Transporte</option>
                        <option value="Comissões">Comissões</option>
                        <option value="Outro">Outro</option>
                    </select>
                </div>
                <div class="col"><label>Banco</label><select id="despesaBanco"></select></div>
            </div>
            <div id="comissao-fields" style="display: none;">
                <div class="row">
                    <div class="col"><label>Fornecedor</label><select id="despesaFornecedor"></select></div>
                    <div class="col"><label>Nº Fatura</label><input type="text" id="despesaFatura"></div>
                </div>
            </div>
            <label><input type="checkbox" id="despesaIsConciliada"> Marcar como já conciliada</label>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeFormModal()">Cancelar</button>
                <button type="submit" class="btn-primary">Guardar</button>
            </div>
        </form>`;
    }
    
    const handleDespesaTypeChange = window.handleDespesaTypeChange = (type) => {
        const comissaoFields = document.getElementById('comissao-fields');
        if (type === 'Comissões') {
            comissaoFields.style.display = 'block';
            loadPartnersForDropdown('fornecedores', 'despesaFornecedor');
        } else {
            comissaoFields.style.display = 'none';
        }
    }

    async function handleDespesaFormSubmit(id) {
        const tipoDespesa = document.getElementById('despesaType').value;
        const bancoSelect = document.getElementById('despesaBanco');
        const data = {
            date: document.getElementById('despesaDate').value,
            value: document.getElementById('despesaValue').value,
            description: document.getElementById('despesaDescription').value,
            type: tipoDespesa,
            isConciliada: document.getElementById('despesaIsConciliada').checked,
            bancoId: bancoSelect.value,
            bancoName: bancoSelect.options[bancoSelect.selectedIndex]?.text || '',
        };

        let fornecedorId = null;
        if (tipoDespesa === 'Comissões') {
            const fornecedorSelect = document.getElementById('despesaFornecedor');
            fornecedorId = fornecedorSelect.value;
            data.fornecedorId = fornecedorId;
            data.fornecedorName = fornecedorSelect.options[fornecedorSelect.selectedIndex]?.text || '';
            data.faturaNumero = document.getElementById('despesaFatura').value;
        }

        try {
            if (id) {
                await updateDoc(doc(db, 'despesas', id), data);
            } else {
                await addDoc(collection(db, 'despesas'), data);
            }

            if (tipoDespesa === 'Comissões' && fornecedorId) {
                const note = `Despesa de comissão registada (Fatura Nº ${data.faturaNumero || 'N/A'}) no valor de €${data.value}.`;
                await handleInteractionSubmit('fornecedores', fornecedorId, note);
            }

            showToast('Despesa guardada com sucesso!', 'success');
            closeFormModal();
            loadDespesas();
            loadPorConciliar();
            loadFinanceiraDashboard();
        } catch (error) {
            console.error("Erro ao guardar despesa:", error);
            showToast("Erro ao guardar despesa.", "error");
        }
    }

    async function populateDespesaForm(id) {
        await loadBancosForDropdown('despesaBanco');
        const docSnap = await getDoc(doc(db, 'despesas', id));
        if (docSnap.exists()) {
            const d = docSnap.data();
            document.getElementById('despesaDate').value = d.date;
            document.getElementById('despesaValue').value = d.value;
            document.getElementById('despesaDescription').value = d.description;
            document.getElementById('despesaType').value = d.type;
            document.getElementById('despesaBanco').value = d.bancoId || '';
            document.getElementById('despesaIsConciliada').checked = d.isConciliada;
            
            if(d.type === 'Comissões') {
                handleDespesaTypeChange('Comissões');
                await loadPartnersForDropdown('fornecedores', 'despesaFornecedor');
                document.getElementById('despesaFornecedor').value = d.fornecedorId || '';
                document.getElementById('despesaFatura').value = d.faturaNumero || '';
            }
        }
    }

    async function loadPorConciliar() {
        const tableBody = document.getElementById('porConciliarTable').querySelector('tbody');
        tableBody.innerHTML = '';
        const q = query(collection(db, 'despesas'), where('isConciliada', '==', false));
        const snapshot = await getDocs(q);
        
        if(snapshot.empty) {
            tableBody.innerHTML = '<tr><td colspan="5">Nenhuma despesa por conciliar.</td></tr>';
            return;
        }

        let despesas = [];
        snapshot.forEach(doc => {
            despesas.push({ id: doc.id, ...doc.data() });
        });

        despesas.sort((a, b) => new Date(b.date) - new Date(a.date));

        tableBody.innerHTML = '';
        despesas.forEach(d => {
            const row = tableBody.insertRow();
            row.innerHTML = `
                <td><input type="checkbox" class="conciliar-check" value="${d.id}" data-value="${d.value}"></td>
                <td>${d.date}</td>
                <td>${d.description}</td>
                <td>${d.type}</td>
                <td>€${parseFloat(d.value || 0).toLocaleString('pt-PT')}</td>
            `;
        });
    }
    
    const toggleAllConciliar = window.toggleAllConciliar = (checked) => {
        document.querySelectorAll('.conciliar-check').forEach(cb => cb.checked = checked);
    }
    
    const openConciliarModal = window.openConciliarModal = async () => {
        const selectedIds = Array.from(document.querySelectorAll('.conciliar-check:checked')).map(cb => cb.value);
        if (selectedIds.length === 0) {
            showToast('Por favor, selecione pelo menos uma despesa para conciliar.', 'warning');
            return;
        }
        document.getElementById('conciliarCount').textContent = selectedIds.length;
        await loadBancosForDropdown('conciliarBanco', true); // Apenas bancos ativos
        document.getElementById('conciliarDate').value = new Date().toISOString().split('T')[0];
        conciliarModal.classList.add('active');
    }
    const closeConciliarModal = window.closeConciliarModal = () => { conciliarModal.classList.remove('active'); }

    const conciliarDespesasEmMassa = window.conciliarDespesasEmMassa = async () => {
        const selectedIds = Array.from(document.querySelectorAll('.conciliar-check:checked')).map(cb => cb.value);
        const conciliarDate = document.getElementById('conciliarDate').value;
        const bancoSelect = document.getElementById('conciliarBanco');
        const bancoId = bancoSelect.value;
        const bancoName = bancoSelect.options[bancoSelect.selectedIndex]?.text || '';

        if (!conciliarDate || !bancoId) {
            showToast('Por favor, preencha a data e o banco.', 'error');
            return;
        }

        try {
            let totalDespesas = 0;
            const despesasPromises = selectedIds.map(id => getDoc(doc(db, 'despesas', id)));
            const despesasDocs = await Promise.all(despesasPromises);
            
            despesasDocs.forEach(docSnap => {
                if (docSnap.exists()) {
                    totalDespesas += parseFloat(docSnap.data().value);
                }
            });

            const bancoRef = doc(db, 'bancos', bancoId);
            await runTransaction(db, async (transaction) => {
                const bancoDoc = await transaction.get(bancoRef);
                if (!bancoDoc.exists()) {
                    throw "Banco não encontrado!";
                }
                const novoSaldo = parseFloat(bancoDoc.data().balance) - totalDespesas;
                transaction.update(bancoRef, { balance: novoSaldo });
                
                const movimentoRef = doc(collection(db, 'bancos', bancoId, 'movimentos'));
                transaction.set(movimentoRef, {
                    data: conciliarDate,
                    valor: -totalDespesas,
                    tipo: 'Despesa Conciliada',
                    descricao: `Conciliação de ${selectedIds.length} despesas`,
                    createdAt: serverTimestamp()
                });

                selectedIds.forEach(id => {
                    const docRef = doc(db, 'despesas', id);
                    transaction.update(docRef, { 
                        isConciliada: true,
                        dataConciliacao: conciliarDate,
                        bancoId: bancoId,
                        bancoName: bancoName
                    });
                });
            });

            // Geração do PDF após a transação ser bem-sucedida
            const pdf = new jsPDF();
            pdf.text("Nota de Lançamento de Despesas", 14, 16);
            pdf.setFontSize(10);
            pdf.text(`Data de Conciliação: ${conciliarDate}`, 14, 22);
            pdf.text(`Conta Bancária: ${bancoName}`, 14, 28);

            const tableData = [];
            despesasDocs.forEach(docSnap => {
                if (docSnap.exists()) {
                    const d = docSnap.data();
                    tableData.push([d.date, d.description, d.type, `€${parseFloat(d.value).toFixed(2)}`]);
                }
            });

            pdf.autoTable({
                startY: 35,
                head: [['Data', 'Descrição', 'Tipo', 'Valor']],
                body: tableData,
                foot: [['', '', 'Total', `€${totalDespesas.toFixed(2)}`]],
                theme: 'striped'
            });

            pdf.save(`conciliacao_${conciliarDate}.pdf`);

            showToast('Despesas conciliadas e PDF gerado com sucesso!', 'success');
            closeConciliarModal();
            loadPorConciliar();
            loadDespesas();
            loadBancos();
            loadMovimentos();

        } catch (error) {
            console.error("Erro na conciliação:", error);
            showToast("Erro na conciliação. Tente novamente.", "error");
        }
    };
    
    const loadBancos = window.loadBancos = async (apenasAtivos = false) => {
        const tableBody = document.getElementById('bancosTable').querySelector('tbody');
        tableBody.innerHTML = '';
        let q = apenasAtivos ? query(collection(db, 'bancos'), where('status', '==', 'Ativo')) : query(collection(db, 'bancos'));
        const snapshot = await getDocs(q);

        let bancos = [];
        snapshot.forEach(doc => {
            bancos.push({ id: doc.id, ...doc.data() });
        });

        bancos.sort((a, b) => (a.name || '').localeCompare(b.name || ''));

        bancos.forEach(d => {
            const row = tableBody.insertRow();
            row.innerHTML = `
                <td>${d.name}</td>
                <td>${d.iban || '-'}</td>
                <td>€${parseFloat(d.balance || 0).toLocaleString('pt-PT', {minimumFractionDigits: 2})}</td>
                <td><span style="color: ${d.status === 'Ativo' ? 'var(--color-success)' : 'var(--color-danger)'}">${d.status}</span></td>
                <td class="actions-cell">
                    <button onclick="toggleBancoStatus('${d.id}', '${d.status}')" title="${d.status === 'Ativo' ? 'Desativar' : 'Ativar'}"><i class="ph ph-power"></i></button>
                    <button onclick="openFormModal('banco', '${d.id}')" title="Editar"><i class="ph ph-pencil-simple"></i></button>
                </td>
            `;
        });
    }

    const toggleBancoStatus = window.toggleBancoStatus = async (id, currentStatus) => {
        const newStatus = currentStatus === 'Ativo' ? 'Inativo' : 'Ativo';
        await updateDoc(doc(db, 'bancos', id), { status: newStatus });
        showToast(`Estado do banco alterado para ${newStatus}.`, 'info');
        loadBancos();
    }
    
    async function loadBancosForDropdown(selectId, apenasAtivos = false) {
        const select = document.getElementById(selectId);
        if (!select) return;
        select.innerHTML = '<option value="">Selecione um banco</option>';
        let q = apenasAtivos ? query(collection(db, 'bancos'), where('status', '==', 'Ativo')) : query(collection(db, 'bancos'));
        const snapshot = await getDocs(q);

        let bancos = [];
        snapshot.forEach(doc => {
            bancos.push({ id: doc.id, ...doc.data() });
        });

        bancos.sort((a, b) => (a.name || '').localeCompare(b.name || ''));

        bancos.forEach(d => {
            select.innerHTML += `<option value="${d.id}">${d.name}</option>`;
        });
    }

    function getBancoFormHTML() {
        return `<form id="bancoForm">
            <label>Nome do Banco</label><input type="text" id="bancoName" required>
            <label>IBAN</label><input type="text" id="bancoIban">
            <label>Saldo Inicial</label><input type="number" id="bancoBalance" step="0.01" required>
            <label>Estado</label><select id="bancoStatus"><option value="Ativo">Ativo</option><option value="Inativo">Inativo</option></select>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeFormModal()">Cancelar</button>
                <button type="submit" class="btn-primary">Guardar</button>
            </div>
        </form>`;
    }

    async function handleBancoFormSubmit(id) {
        const data = {
            name: document.getElementById('bancoName').value,
            iban: document.getElementById('bancoIban').value,
            balance: parseFloat(document.getElementById('bancoBalance').value),
            status: document.getElementById('bancoStatus').value,
        };
        try {
            if (id) {
                await updateDoc(doc(db, 'bancos', id), data);
            } else {
                await addDoc(collection(db, 'bancos'), data);
            }
            showToast('Conta bancária guardada com sucesso!', 'success');
            closeFormModal();
            loadBancos();
        } catch (error) {
            console.error("Erro ao guardar conta bancária:", error);
            showToast("Erro ao guardar conta bancária.", "error");
        }
    }

    async function populateBancoForm(id) {
        const docSnap = await getDoc(doc(db, 'bancos', id));
        if (docSnap.exists()) {
            const d = docSnap.data();
            document.getElementById('bancoName').value = d.name;
            document.getElementById('bancoIban').value = d.iban;
            document.getElementById('bancoBalance').value = d.balance;
            document.getElementById('bancoStatus').value = d.status || 'Ativo';
        }
    }

    async function loadMovimentos() {
        const tableBody = document.getElementById('movimentosTable').querySelector('tbody');
        tableBody.innerHTML = '<tr><td colspan="5">A carregar movimentos...</td></tr>';
        
        try {
            const q = query(collectionGroup(db, 'movimentos'));
            const snapshot = await getDocs(q);
            
            if (snapshot.empty) {
                tableBody.innerHTML = '<tr><td colspan="5">Nenhum movimento encontrado.</td></tr>';
                return;
            }

            let movimentos = [];
            snapshot.forEach(docSnap => {
                movimentos.push({ 
                    id: docSnap.id, 
                    bankId: docSnap.ref.parent.parent.id, 
                    ...docSnap.data() 
                });
            });

            movimentos.sort((a, b) => new Date(b.data) - new Date(a.data));

            tableBody.innerHTML = '';
            movimentos.forEach(d => {
                const valor = parseFloat(d.valor || 0);
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${d.data}</td>
                    <td>${d.descricao}</td>
                    <td style="color: ${valor > 0 ? 'var(--color-success)' : 'var(--color-danger)'}">${valor.toLocaleString('pt-PT', {style: 'currency', currency: 'EUR'})}</td>
                    <td>${d.tipo}</td>
                    <td class="actions-cell">
                        <button class="btn-danger" onclick="deleteMovimento('${d.bankId}', '${d.id}')" title="Eliminar Movimento"><i class="ph ph-trash"></i></button>
                    </td>
                `;
            });
        } catch (error) {
            // MELHORIA: Adicionada mensagem de erro mais específica.
            console.error("Erro ao carregar movimentos:", error);
            let errorMessage = 'Erro ao carregar movimentos. Verifique a consola.';
            if (error.code === 'failed-precondition') {
                errorMessage = `Erro: A consulta requer um índice. Por favor, aceda à consola do Firebase, encontre o link no erro na consola do browser e crie o índice para a coleção 'movimentos'.`;
            }
            tableBody.innerHTML = `<tr><td colspan="5">${errorMessage}</td></tr>`;
            showToast("Erro ao carregar movimentos.", "error");
        }
    }
    
    const deleteMovimento = window.deleteMovimento = (bankId, movimentoId) => {
        showConfirmModal('Tem a certeza que quer eliminar este movimento? O saldo da conta será revertido. Esta ação é irreversível.', async () => {
            try {
                const movimentoRef = doc(db, 'bancos', bankId, 'movimentos', movimentoId);
                const bancoRef = doc(db, 'bancos', bankId);

                await runTransaction(db, async (transaction) => {
                    const movimentoDoc = await transaction.get(movimentoRef);
                    if (!movimentoDoc.exists()) {
                        throw "Movimento não encontrado!";
                    }
                    const bancoDoc = await transaction.get(bancoRef);
                    if (!bancoDoc.exists()) {
                        throw "Banco não encontrado!";
                    }

                    const movimentoValor = parseFloat(movimentoDoc.data().valor);
                    const saldoAtual = parseFloat(bancoDoc.data().balance);
                    const novoSaldo = saldoAtual - movimentoValor;

                    transaction.update(bancoRef, { balance: novoSaldo });
                    transaction.delete(movimentoRef);
                });

                showToast('Movimento eliminado e saldo atualizado com sucesso!', 'success');
                loadMovimentos();
                loadBancos();
            } catch (error) {
                console.error("Erro ao eliminar movimento:", error);
                showToast("Erro ao eliminar o movimento.", "error");
            }
        });
    }

    // --- MILESTONES (ETAPAS DO CONTRATO) ---
    async function loadMilestones(contractId, containerId) {
        const container = document.getElementById(containerId);
        container.innerHTML = 'A carregar etapas...';
        const q = query(collection(db, 'contratos', contractId, 'milestones'), orderBy('createdAt'));
        const snapshot = await getDocs(q);
        
        if (snapshot.empty) {
            container.innerHTML = '<p>Nenhuma etapa definida.</p>';
            return;
        }

        container.innerHTML = '';
        snapshot.forEach(docSnap => {
            const d = docSnap.data();
            const item = document.createElement('div');
            item.className = `milestone-item ${d.completed ? 'completed' : ''}`;
            item.innerHTML = `
                <input type="checkbox" id="milestone-${docSnap.id}" ${d.completed ? 'checked' : ''} onchange="toggleMilestone('${contractId}', '${docSnap.id}', this.checked)">
                <label for="milestone-${docSnap.id}">${d.description}</label>
            `;
            container.appendChild(item);
        });
    }

    async function handleMilestoneSubmit(contractId) {
        const descInput = document.getElementById('newMilestoneDescription');
        const ownerInput = document.getElementById('newMilestoneOwner');
        const dueDateInput = document.getElementById('newMilestoneDueDate');
        
        const description = descInput.value.trim();
        if (!description) return;

        await addDoc(collection(db, 'contratos', contractId, 'milestones'), {
            description: description,
            completed: false,
            createdAt: serverTimestamp()
        });

        const owner = ownerInput.value.trim();
        const dueDate = dueDateInput.value;
        if (owner || dueDate) {
            const contractDoc = await getDoc(doc(db, 'contratos', contractId));
            const contractData = contractDoc.data();
            
            await addDoc(collection(db, 'tarefas'), {
                title: description,
                owner: owner,
                dueDate: dueDate,
                priority: 'Média',
                status: 'Pendente',
                clientId: contractData.clientId || '',
                contractId: contractId,
            });
            loadTasks();
            loadDashboardData();
        }
        showToast('Etapa adicionada com sucesso!', 'success');
        descInput.value = '';
        ownerInput.value = '';
        dueDateInput.value = '';
        
        loadMilestones(contractId, 'milestonesList');
    }

    const toggleMilestone = window.toggleMilestone = async (contractId, milestoneId, isCompleted) => {
        await updateDoc(doc(db, 'contratos', contractId, 'milestones', milestoneId), {
            completed: isCompleted
        });
        loadMilestones(contractId, 'milestonesList');
    }

    // --- WIDGET DE CONTROLO DE DOCUMENTOS ---
    const loadDocumentTrackingWidget = window.loadDocumentTrackingWidget = async () => {
        const container = document.getElementById('documentTrackingList');
        if (!container) return;
        container.innerHTML = '<p>A procurar propostas pendentes...</p>';

        const q = query(collection(db, 'contratos'), where('type', '==', 'Crédito'));
        const snapshot = await getDocs(q);
        
        const pendingContracts = [];
        snapshot.forEach(doc => {
            const data = doc.data();
            if (!data.dataEntregaFornecedor || !data.dataEntregaFinanceira) {
                pendingContracts.push({ id: doc.id, ...data });
            }
        });

        if (pendingContracts.length === 0) {
            container.innerHTML = '<p>Nenhuma entrega de documentos pendente.</p>';
            return;
        }

        container.innerHTML = '';
        const docList = ["Livrete", "Contrato", "DUA", "DAV", "MUA de compra", "MUA de venda", "Extinção de reserva"];
        
        pendingContracts.forEach(contract => {
            const fornecedorName = partnersData.fornecedores[contract.fornecedorId] || 'N/D';
            const financeiraName = partnersData.financeiras[contract.financeiraId] || 'N/D';

            let checklistFornecedorHTML = docList.map(doc => `
                <label><input type="checkbox" onchange="updateContractChecklistFromDashboard('${contract.id}', 'checklistDocsFornecedor', '${doc}', this.checked)" 
                ${(contract.checklistDocsFornecedor || []).includes(doc) ? 'checked' : ''}> ${doc}</label>
            `).join('');
            let checklistFinanceiraHTML = docList.map(doc => `
                <label><input type="checkbox" onchange="updateContractChecklistFromDashboard('${contract.id}', 'checklistDocsFinanceira', '${doc}', this.checked)"
                ${(contract.checklistDocsFinanceira || []).includes(doc) ? 'checked' : ''}> ${doc}</label>
            `).join('');

            const item = document.createElement('details');
            item.className = 'doc-tracking-item';
            item.innerHTML = `
                <summary>
                    <span>Proposta #${contract.numeroProposta || 'N/A'}</span>
                    <span>${fornecedorName} <i class="ph ph-arrow-right"></i> ${financeiraName}</span>
                </summary>
                <div class="doc-tracking-body">
                    <div>
                        <h5><i class="ph ph-download-simple"></i> Fornecedor -> THE WAY</h5>
                        <input type="date" value="${contract.dataEntregaFornecedor || ''}" onchange="updateContractFromDashboard('${contract.id}', 'dataEntregaFornecedor', this.value)">
                        <div class="checklist">${checklistFornecedorHTML}</div>
                    </div>
                    <div>
                        <h5><i class="ph ph-upload-simple"></i> THE WAY -> Financeira</h5>
                        <input type="date" value="${contract.dataEntregaFinanceira || ''}" onchange="updateContractFromDashboard('${contract.id}', 'dataEntregaFinanceira', this.value)">
                        <div class="checklist">${checklistFinanceiraHTML}</div>
                    </div>
                </div>
            `;
            container.appendChild(item);
        });
    }

    const updateContractFromDashboard = window.updateContractFromDashboard = async (contractId, field, value) => {
        const updateData = {};
        updateData[field] = value;
        await updateDoc(doc(db, 'contratos', contractId), updateData);
        
        const fieldName = field === 'dataEntregaFornecedor' ? 'Fornecedor -> THE WAY' : 'THE WAY -> Financeira';
        const note = `Data de entrega de documentos (${fieldName}) atualizada para ${value}.`;
        await handleInteractionSubmit('contratos', contractId, note);

        const docSnap = await getDoc(doc(db, 'contratos', contractId));
        const data = docSnap.data();
        if (data.dataEntregaFornecedor && data.dataEntregaFinanceira) {
            loadDocumentTrackingWidget();
        }
    }

    const updateContractChecklistFromDashboard = window.updateContractChecklistFromDashboard = async (contractId, field, docName, isChecked) => {
        const docRef = doc(db, 'contratos', contractId);
        if (isChecked) {
            await updateDoc(docRef, { [field]: arrayUnion(docName) });
        } else {
            await updateDoc(docRef, { [field]: arrayRemove(docName) });
        }
        
        const fieldName = field === 'checklistDocsFornecedor' ? 'Fornecedor -> THE WAY' : 'THE WAY -> Financeira';
        const status = isChecked ? 'recebido' : 'não recebido';
        const note = `Documento '${docName}' (${fieldName}) marcado como ${status}.`;
        await handleInteractionSubmit('contratos', contractId, note);
    }

    // --- GESTÃO DE DOCUMENTOS ---
    async function handleFileUpload(collectionName, docId, file) {
        const progressBar = document.getElementById('upload-progress');
        const uploadForm = document.getElementById('upload-form');
        
        if (!file) return;

        progressBar.style.display = 'block';
        uploadForm.style.display = 'none';

        const filePath = `${collectionName}/${docId}/${Date.now()}_${file.name}`;
        const fileRef = ref(storage, filePath);
        
        try {
            const snapshot = await uploadBytes(fileRef, file);
            const url = await getDownloadURL(snapshot.ref);
            await addDoc(collection(db, collectionName, docId, 'documentos'), {
                name: file.name,
                url: url,
                path: filePath,
                uploadedAt: serverTimestamp()
            });
            
            showToast('Ficheiro enviado com sucesso!', 'success');
            loadDocuments(collectionName, docId, 'documentList');
        } catch (error) {
            console.error("Erro no upload: ", error);
            showToast("Ocorreu um erro ao enviar o ficheiro.", "error");
        } finally {
            progressBar.style.display = 'none';
            uploadForm.style.display = 'flex';
            document.getElementById('file-input').value = '';
        }
    }

    async function loadDocuments(collectionName, docId, elementId) {
        const container = document.getElementById(elementId);
        if (!container) return;
        container.innerHTML = '<li>A carregar documentos...</li>';
        
        const q = query(collection(db, collectionName, docId, 'documentos'), orderBy('uploadedAt', 'desc'));
        const snapshot = await getDocs(q);
        
        if (snapshot.empty) {
            container.innerHTML = '<li>Nenhum documento encontrado.</li>';
            return;
        }

        container.innerHTML = '';
        snapshot.forEach(docSnap => {
            const d = docSnap.data();
            const date = d.uploadedAt ? d.uploadedAt.toDate().toLocaleDateString('pt-PT') : '';
            const item = document.createElement('li');
            item.innerHTML = `
                <a href="${d.url}" target="_blank" title="Abrir ${d.name}"><i class="ph ph-file-arrow-down"></i> ${d.name}</a>
                <div>
                    <span class="file-date">${date}</span>
                    <button class="btn-danger" style="padding: .2em .5em; font-size: .8em;" onclick="deleteDocument('${collectionName}', '${docId}', '${docSnap.id}', '${d.path}')" title="Eliminar">
                        <i class="ph ph-trash"></i>
                    </button>
                </div>
            `;
            container.appendChild(item);
        });
    }

    const deleteDocument = window.deleteDocument = (collectionName, parentId, docId, filePath) => {
        showConfirmModal('Tem a certeza que quer eliminar este documento? Esta ação é irreversível.', async () => {
            try {
                await deleteDoc(doc(db, collectionName, parentId, 'documentos', docId));
                await deleteObject(ref(storage, filePath));
                showToast('Documento eliminado com sucesso.', 'info');
                loadDocuments(collectionName, parentId, 'documentList');
            } catch (error) {
                console.error("Erro ao eliminar documento:", error);
                showToast("Erro ao eliminar o documento.", "error");
            }
        });
    }

    // --- FUNÇÕES DE COMISSÕES (REFACTOR) ---
    async function loadComissoes() {
        const tableBody = document.getElementById('comissoesTable').querySelector('tbody');
        tableBody.innerHTML = '<tr><td colspan="6">A carregar comissões...</td></tr>';
        
        const q = query(collection(db, 'contratos'), where('commissionStatus', '==', 'Não Paga'));
        const snapshot = await getDocs(q);

        const monthlyGroups = {};

        snapshot.forEach(docSnap => {
            const contract = docSnap.data();
            const valor = parseFloat(contract.comissaoRecebida || 0);
            if (valor <= 0 || !contract.startDate) return;

            let payerId = null;
            let payerName = 'N/D';
            let payerType = 'cliente';

            if (contract.type === 'Crédito' && contract.financeiraId) {
                payerId = contract.financeiraId;
                payerName = partnersData.financeiras[payerId] || 'Financeira';
                payerType = 'financeira';
            } else if (contract.type === 'Seguro' && contract.seguradoraId) {
                payerId = contract.seguradoraId;
                payerName = partnersData.seguradoras[payerId] || 'Seguradora';
                payerType = 'seguradora';
            } else if (['Legalização Automóvel', 'Consultoria Financeira'].includes(contract.type) && contract.clientId) {
                payerId = contract.clientId;
                payerName = partnersData.clientes[payerId] || 'Cliente';
                payerType = 'cliente';
            }

            if (!payerId) return;

            const date = new Date(contract.startDate);
            const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
            const groupKey = `${payerId}_${monthKey}`;

            if (!monthlyGroups[groupKey]) {
                monthlyGroups[groupKey] = {
                    payerName: payerName,
                    month: monthKey,
                    total: 0,
                    contractIds: [],
                    count: 0
                };
            }
            monthlyGroups[groupKey].total += valor;
            monthlyGroups[groupKey].contractIds.push(docSnap.id);
            monthlyGroups[groupKey].count++;
        });

        if (Object.keys(monthlyGroups).length === 0) {
            tableBody.innerHTML = '<tr><td colspan="6">Nenhuma comissão por liquidar.</td></tr>';
            return;
        }

        tableBody.innerHTML = '';
        for (const key in monthlyGroups) {
            const group = monthlyGroups[key];
            const row = tableBody.insertRow();
            row.innerHTML = `
                <td><input type="checkbox" class="comissao-check" data-group-key="${key}"></td>
                <td>${group.payerName}</td>
                <td>${group.month}</td>
                <td>${group.count}</td>
                <td>${group.total.toLocaleString('pt-PT', {style: 'currency', currency: 'EUR'})}</td>
                <td>Por Liquidar</td>
            `;
            row.querySelector('.comissao-check').dataset.contracts = JSON.stringify(group.contractIds);
            row.querySelector('.comissao-check').dataset.total = group.total;
        }
    }

    const toggleAllComissoes = window.toggleAllComissoes = (checked) => {
        document.querySelectorAll('.comissao-check:not(:disabled)').forEach(cb => cb.checked = checked);
    }

    const openComissaoModal = window.openComissaoModal = async () => {
        const selectedGroups = Array.from(document.querySelectorAll('.comissao-check:checked'));
        if (selectedGroups.length === 0) {
            showToast('Por favor, selecione pelo menos um grupo de comissões para liquidar.', 'warning');
            return;
        }
        document.getElementById('comissaoCount').textContent = selectedGroups.length;
        document.getElementById('comissaoDataPagamento').value = new Date().toISOString().split('T')[0];
        await loadBancosForDropdown('comissaoBanco', true);
        comissaoModal.classList.add('active');
    }
    const closeComissaoModal = window.closeComissaoModal = () => { comissaoModal.classList.remove('active'); }

    const liquidarComissoes = window.liquidarComissoes = async () => {
        const selectedCheckboxes = Array.from(document.querySelectorAll('.comissao-check:checked'));
        const faturaNumero = document.getElementById('comissaoFatura').value;
        const dataPagamento = document.getElementById('comissaoDataPagamento').value;
        const bancoSelect = document.getElementById('comissaoBanco');
        const bancoId = bancoSelect.value;
        const temRetencao = document.getElementById('comissaoRetencaoCheck').checked;
        const retencaoPercent = temRetencao ? parseFloat(document.querySelector('input[name="comissaoRetencaoPercent"]:checked').value) : 0;


        if (!faturaNumero || !bancoId || !dataPagamento) {
            showToast('Por favor, preencha todos os campos.', 'error');
            return;
        }

        try {
            const bancoRef = doc(db, 'bancos', bancoId);

            for (const cb of selectedCheckboxes) {
                const totalComissaoBruta = parseFloat(cb.dataset.total);
                const valorRetencao = totalComissaoBruta * retencaoPercent;
                const valorLiquido = totalComissaoBruta - valorRetencao;
                const contractIds = JSON.parse(cb.dataset.contracts);

                await runTransaction(db, async (transaction) => {
                    const bancoDoc = await transaction.get(bancoRef);
                    if (!bancoDoc.exists()) throw "Banco não encontrado!";
                    
                    const novoSaldo = parseFloat(bancoDoc.data().balance) + valorLiquido;
                    transaction.update(bancoRef, { balance: novoSaldo });

                    const movimentoRef = doc(collection(db, 'bancos', bancoId, 'movimentos'));
                    transaction.set(movimentoRef, {
                        data: dataPagamento,
                        valor: valorLiquido,
                        tipo: 'Comissão',
                        descricao: `Recebimento Fatura ${faturaNumero} (${contractIds.length} contratos)`,
                        createdAt: serverTimestamp()
                    });

                    contractIds.forEach(id => {
                        const docRef = doc(db, 'contratos', id);
                        transaction.update(docRef, {
                            commissionStatus: 'Paga',
                            faturaNumero: faturaNumero,
                            dataPagamentoComissao: dataPagamento,
                            bancoRecepcaoId: bancoId,
                            temRetencao: temRetencao,
                            retencaoPercent: retencaoPercent * 100,
                            valorLiquidoComissao: valorLiquido
                        });
                    });
                });
            }
            
            showToast('Comissões liquidadas com sucesso!', 'success');
            closeComissaoModal();
            loadComissoes();
            loadBancos();
            loadMovimentos();
        } catch (error) {
            console.error("Erro ao liquidar comissões:", error);
            showToast("Erro ao liquidar comissões.", "error");
        }
    }

    // --- FUNÇÕES DE OUTROS GANHOS ---
    function getGanhoFormHTML() {
        return `<form id="ganhoForm">
            <div class="row">
                <div class="col"><label>Data</label><input type="date" id="ganhoData" required></div>
                <div class="col"><label>Valor Bruto</label><input type="number" id="ganhoValor" step="0.01" required></div>
            </div>
            <label>Descrição</label><input type="text" id="ganhoDescricao" required placeholder="Ex: Rapel Anual">
            <div class="row">
                 <div class="col"><label>Parceiro (Opcional)</label><select id="ganhoParceiro"></select></div>
                 <div class="col"><label>Banco</label><select id="ganhoBanco" required></select></div>
            </div>
             <div>
                <label><input type="checkbox" id="ganhoRetencaoCheck" onchange="document.getElementById('ganhoRetencaoOptions').style.display = this.checked ? 'block' : 'none'"> Com retenção?</label>
                <div id="ganhoRetencaoOptions" style="display:none; margin-top: .5em; padding-left: 1.5em;">
                    <label style="font-weight: normal; margin-right: 1em;"><input type="radio" name="ganhoRetencaoPercent" value="0.23" checked> 23%</label>
                    <label style="font-weight: normal;"><input type="radio" name="ganhoRetencaoPercent" value="0.25"> 25%</label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeFormModal()">Cancelar</button>
                <button type="submit" class="btn-primary">Guardar Ganho</button>
            </div>
        </form>`;
    }

    async function handleGanhoFormSubmit(id) {
        const valorBruto = parseFloat(document.getElementById('ganhoValor').value);
        const temRetencao = document.getElementById('ganhoRetencaoCheck').checked;
        const retencaoPercent = temRetencao ? parseFloat(document.querySelector('input[name="ganhoRetencaoPercent"]:checked').value) : 0;
        const valorRetencao = valorBruto * retencaoPercent;
        const valorLiquido = valorBruto - valorRetencao;

        const bancoSelect = document.getElementById('ganhoBanco');
        const parceiroSelect = document.getElementById('ganhoParceiro');

        const data = {
            date: document.getElementById('ganhoData').value,
            description: document.getElementById('ganhoDescricao').value,
            valorBruto: valorBruto,
            temRetencao: temRetencao,
            retencaoPercent: retencaoPercent * 100,
            valorLiquido: valorLiquido,
            bancoId: bancoSelect.value,
            bancoName: bancoSelect.options[bancoSelect.selectedIndex]?.text || '',
            parceiroId: parceiroSelect.value,
            parceiroName: parceiroSelect.options[parceiroSelect.selectedIndex]?.text || '',
        };

        if(!data.date || !data.bancoId || isNaN(valorBruto)) {
            showToast('Por favor, preencha a data, valor e banco.', 'error');
            return;
        }

        try {
            const bancoRef = doc(db, 'bancos', data.bancoId);
            await runTransaction(db, async (transaction) => {
                 const bancoDoc = await transaction.get(bancoRef);
                 if (!bancoDoc.exists()) throw "Banco não encontrado!";

                 const novoSaldo = parseFloat(bancoDoc.data().balance) + valorLiquido;
                 transaction.update(bancoRef, { balance: novoSaldo });

                 const movimentoRef = doc(collection(db, 'bancos', data.bancoId, 'movimentos'));
                 transaction.set(movimentoRef, {
                    data: data.date,
                    valor: valorLiquido,
                    tipo: 'Outro Ganho',
                    descricao: data.description,
                    createdAt: serverTimestamp()
                 });

                 if (id) {
                    // Lógica para editar (precisaria reverter o movimento antigo)
                    await updateDoc(doc(db, 'outrosGanhos', id), data);
                 } else {
                    await addDoc(collection(db, 'outrosGanhos'), data);
                 }
            });

            showToast('Ganho registado com sucesso!', 'success');
            closeFormModal();
            loadOutrosGanhos();
            loadFinanceiraDashboard();
            loadBancos();
            loadMovimentos();

        } catch (error) {
            console.error("Erro ao registar ganho:", error);
            showToast("Erro ao registar ganho.", "error");
        }
    }

    async function loadOutrosGanhos() {
        const tableBody = document.getElementById('outrosGanhosTable').querySelector('tbody');
        tableBody.innerHTML = '';
        const q = query(collection(db, 'outrosGanhos'), orderBy('date', 'desc'));
        const snapshot = await getDocs(q);
        snapshot.forEach(docSnap => {
            const d = docSnap.data();
            const row = tableBody.insertRow();
            row.innerHTML = `
                <td>${d.date}</td>
                <td>${d.description}</td>
                <td>${d.parceiroName || '-'}</td>
                <td>€${d.valorBruto.toLocaleString('pt-PT')}</td>
                <td>${d.temRetencao ? `${d.retencaoPercent}%` : 'N/A'}</td>
                <td>€${d.valorLiquido.toLocaleString('pt-PT')}</td>
                <td class="actions-cell">
                    <button class="btn-danger" onclick="deleteItem('outrosGanhos', '${docSnap.id}', 'este ganho', loadOutrosGanhos)" title="Eliminar"><i class="ph ph-trash"></i></button>
                </td>
            `;
        });
    }
    
    // --- MÓDULO DE RELATÓRIOS ---
    const setupReportsModule = window.setupReportsModule = async () => {
        // Carregar dropdowns para os filtros
        const comercialSelect = document.getElementById('filter-comercial');
        comercialSelect.innerHTML = '<option value="">Todos</option>';
        await loadComerciaisForDropdown('filter-comercial');

        const fornecedorSelect = document.getElementById('filter-fornecedor');
        fornecedorSelect.innerHTML = '<option value="">Todos</option>';
        await loadPartnersForDropdown('fornecedores', 'filter-fornecedor');
        
        const financeiraSelect = document.getElementById('filter-financeira');
        financeiraSelect.innerHTML = '<option value="">Todas</option>';
        await loadPartnersForDropdown('financeiras', 'filter-financeira');
    }

    const clearReportFilters = window.clearReportFilters = () => {
        document.getElementById('filter-start-date').value = '';
        document.getElementById('filter-end-date').value = '';
        document.getElementById('filter-comercial').value = '';
        document.getElementById('filter-fornecedor').value = '';
        document.getElementById('filter-financeira').value = '';
        document.getElementById('search-freelance').value = '';
        
        // Limpar resultados
        const initialText = '<p>Selecione os filtros e clique em "Filtrar" para gerar o relatório.</p>';
        document.getElementById('report-comissao').innerHTML = initialText;
        document.getElementById('report-producao-interno').innerHTML = initialText;
        document.getElementById('report-pendentes').innerHTML = initialText;
        document.getElementById('report-producao-freelance').innerHTML = initialText.replace('gerar o relatório', 'ver os resultados');
        document.getElementById('freelancer-search-container').style.display = 'none';
        document.getElementById('freelance-results').innerHTML = '';
        cachedReportData = [];
    }
    
    const generateReports = window.generateReports = async () => {
        showToast('A gerar relatórios...', 'info');
        
        // 1. Obter valores dos filtros
        const startDate = document.getElementById('filter-start-date').value;
        const endDate = document.getElementById('filter-end-date').value;
        const commercialId = document.getElementById('filter-comercial').value;
        const fornecedorId = document.getElementById('filter-fornecedor').value;
        const financeiraId = document.getElementById('filter-financeira').value;
        
        // 2. Fetch ALL contracts and filter on the client-side to avoid index errors
        const contractsQuery = query(collection(db, 'contratos'));
        const contractsSnapshot = await getDocs(contractsQuery);
        let allContracts = [];
        contractsSnapshot.forEach(doc => {
            allContracts.push({ id: doc.id, ...doc.data() });
        });

        // 3. Filter the data in JavaScript
        cachedReportData = allContracts.filter(contract => {
            if (startDate && contract.startDate < startDate) return false;
            if (endDate && contract.startDate > endDate) return false;
            if (commercialId && contract.commercialId !== commercialId) return false;
            if (fornecedorId && contract.fornecedorId !== fornecedorId) return false;
            if (financeiraId && contract.financeiraId !== financeiraId) return false;
            return true;
        });
        
        // 4. Gerar e renderizar cada relatório
        renderComissaoReport(cachedReportData);
        renderProducaoInternoReport(cachedReportData);
        await renderPendentesReport(); // Este é assíncrono e separado
        renderFreelanceReport(cachedReportData);
        
        document.getElementById('freelancer-search-container').style.display = 'block';

        showToast('Relatórios gerados com sucesso!', 'success');
    }
    
    // --- Funções de Renderização dos Relatórios ---
    function renderComissaoReport(data) {
        const container = document.getElementById('report-comissao');
        let totalComissao = 0;
        data.forEach(contract => {
            totalComissao += parseFloat(contract.comissaoRecebida || 0);
        });
        
        const iva = totalComissao * 0.23;
        const totalFinal = totalComissao + iva;
        
        container.innerHTML = `
            <div class="kpi-grid" style="grid-template-columns: repeat(3, 1fr);">
                <div class="kpi-card">
                    <div class="title">Total Comissões</div>
                    <div class="value">€${totalComissao.toLocaleString('pt-PT', {minimumFractionDigits: 2})}</div>
                </div>
                <div class="kpi-card">
                    <div class="title">IVA (23%)</div>
                    <div class="value">€${iva.toLocaleString('pt-PT', {minimumFractionDigits: 2})}</div>
                </div>
                <div class="kpi-card">
                    <div class="title">Total a Faturar</div>
                    <div class="value">€${totalFinal.toLocaleString('pt-PT', {minimumFractionDigits: 2})}</div>
                </div>
            </div>
        `;
    }

    function renderProducaoInternoReport(data) {
        const container = document.getElementById('report-producao-interno');
        const creditContracts = data.filter(c => c.type === 'Crédito');
        
        if(creditContracts.length === 0) {
            container.innerHTML = '<p>Nenhum contrato de crédito encontrado para os filtros selecionados.</p>';
            return;
        }

        let tableHTML = `
            <div class="table-container">
                <table class="data-table">
                    <thead><tr><th>Cliente</th><th>Matrícula</th><th>Valor Financiado</th><th>% Comissão</th><th>Comissão</th></tr></thead>
                    <tbody>`;
        
        creditContracts.forEach(c => {
            const clientNameParts = c.clientName.split(' ');
            const displayName = clientNameParts.length > 1 ? `${clientNameParts[0]} ${clientNameParts[clientNameParts.length - 1]}` : c.clientName;
            
            tableHTML += `
                <tr>
                    <td>${displayName}</td>
                    <td>${c.creditoMatricula || '-'}</td>
                    <td>€${parseFloat(c.valorFinanciado || 0).toLocaleString('pt-PT')}</td>
                    <td>${c.comissaoPercent || 0}%</td>
                    <td>€${parseFloat(c.comissaoRecebida || 0).toLocaleString('pt-PT')}</td>
                </tr>
            `;
        });
        
        tableHTML += `</tbody></table></div>`;
        container.innerHTML = tableHTML;
    }

    async function renderPendentesReport() {
        const container = document.getElementById('report-pendentes');
        const q = query(collection(db, 'tarefas'), where('status', '==', 'Pendente'));
        const snapshot = await getDocs(q);
        
        if (snapshot.empty) {
            container.innerHTML = '<p>Nenhuma tarefa pendente encontrada.</p>';
            return;
        }

        let tableHTML = `
            <div class="table-container">
                <table class="data-table">
                    <thead><tr><th>Pendente</th><th>Responsável</th><th>Dias em Aberto</th></tr></thead>
                    <tbody>`;
        
        const today = new Date();
        snapshot.forEach(doc => {
            const task = doc.data();
            let daysOpen = 'N/D';
            if(task.createdAt && task.createdAt.toDate) {
                const createdDate = task.createdAt.toDate();
                const diffTime = Math.abs(today - createdDate);
                daysOpen = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            }

            tableHTML += `
                <tr>
                    <td>${task.title}</td>
                    <td>${task.owner || 'N/D'}</td>
                    <td>${daysOpen}</td>
                </tr>
            `;
        });

        tableHTML += `</tbody></table></div>`;
        container.innerHTML = tableHTML;
    }

    function renderFreelanceReport(data, searchTerm = '') {
        const container = document.getElementById('freelance-results');
        const freelanceContracts = data.filter(c => c.isFreelancer && c.freelancerName);
        
        if(freelanceContracts.length === 0) {
            container.innerHTML = '<p>Nenhuma produção de freelancer encontrada para os filtros selecionados.</p>';
            return;
        }

        let filtered = freelanceContracts;
        if (searchTerm) {
            const lowerSearchTerm = searchTerm.toLowerCase();
            filtered = freelanceContracts.filter(c => c.freelancerName.toLowerCase().includes(lowerSearchTerm));
        }

        if(filtered.length === 0) {
            container.innerHTML = `<p>Nenhum resultado para a pesquisa "${searchTerm}".</p>`;
            return;
        }
        
        let tableHTML = `
            <div class="table-container">
                <table class="data-table">
                    <thead><tr><th>Freelancer</th><th>Cliente</th><th>Matrícula</th></tr></thead>
                    <tbody>`;
        
        filtered.forEach(c => {
            tableHTML += `
                <tr>
                    <td>${c.freelancerName}</td>
                    <td>${c.clientName}</td>
                    <td>${c.matricula || '-'}</td>
                </tr>
            `;
        });
        
        tableHTML += `</tbody></table></div>`;
        container.innerHTML = tableHTML;
    }

    // --- Funções de Exportação PDF ---
    const exportPdf = window.exportPdf = async (reportType) => {
        const doc = new jsPDF();
        const today = new Date().toLocaleDateString('pt-PT');
        
        // Cabeçalho Padrão
        doc.setFontSize(18);
        doc.text("THE WAY", 14, 22);
        doc.setFontSize(11);
        doc.text("Relatório Interno", 14, 30);
        doc.text(`Data: ${today}`, 150, 22);

        if (reportType === 'comissao') {
            let totalComissao = 0;
            cachedReportData.forEach(c => totalComissao += parseFloat(c.comissaoRecebida || 0));
            const iva = totalComissao * 0.23;
            const totalFinal = totalComissao + iva;
            
            doc.setFontSize(14);
            doc.text("Carta de Comissão", 14, 50);
            doc.autoTable({
                startY: 60,
                head: [['Descrição', 'Valor']],
                body: [
                    ['Soma das Comissões', `€${totalComissao.toFixed(2)}`],
                    ['IVA (23%)', `€${iva.toFixed(2)}`],
                ],
                foot: [['TOTAL', `€${totalFinal.toFixed(2)}`]],
                theme: 'striped'
            });
            doc.save(`carta_comissao_${today}.pdf`);

        } else if (reportType === 'producao-interno') {
            const creditContracts = cachedReportData.filter(c => c.type === 'Crédito');
            const body = creditContracts.map(c => {
                const clientNameParts = c.clientName.split(' ');
                const displayName = clientNameParts.length > 1 ? `${clientNameParts[0]} ${clientNameParts[clientNameParts.length - 1]}` : c.clientName;
                return [
                    displayName,
                    c.creditoMatricula || '-',
                    `€${parseFloat(c.valorFinanciado || 0).toFixed(2)}`,
                    `${c.comissaoPercent || 0}%`,
                    `€${parseFloat(c.comissaoRecebida || 0).toFixed(2)}`
                ];
            });
            doc.text("Mapa de Produção Interno", 14, 50);
            doc.autoTable({
                startY: 60,
                head: [['Cliente', 'Matrícula', 'Valor Financiado', '% Comissão', 'Comissão']],
                body: body,
                theme: 'striped'
            });
            doc.save(`mapa_producao_interno_${today}.pdf`);

        } else if (reportType === 'pendentes') {
            const q = query(collection(db, 'tarefas'), where('status', '==', 'Pendente'));
            const snapshot = await getDocs(q);
            const body = [];
            const todayDate = new Date();
            snapshot.forEach(d => {
                const task = d.data();
                let daysOpen = 'N/D';
                if(task.createdAt && task.createdAt.toDate) {
                    const createdDate = task.createdAt.toDate();
                    daysOpen = Math.ceil(Math.abs(todayDate - createdDate) / (1000 * 60 * 60 * 24));
                }
                body.push([task.title, task.owner || 'N/D', daysOpen]);
            });
            doc.text("Carta de Pendentes", 14, 50);
            doc.autoTable({
                startY: 60,
                head: [['Pendente', 'Responsável', 'Dias em Aberto']],
                body: body,
                theme: 'striped'
            });
            doc.save(`carta_pendentes_${today}.pdf`);

        } else if (reportType === 'producao-freelance') {
            const searchTerm = document.getElementById('search-freelance').value;
            let freelanceContracts = cachedReportData.filter(c => c.isFreelancer && c.freelancerName);
            if(searchTerm) {
                freelanceContracts = freelanceContracts.filter(c => c.freelancerName.toLowerCase().includes(searchTerm.toLowerCase()));
            }
            const body = freelanceContracts.map(c => [c.freelancerName, c.clientName, c.matricula || '-']);
            
            doc.text("Mapa de Produção - Freelance", 14, 50);
            if(searchTerm) doc.text(`Filtro: ${searchTerm}`, 14, 56);
            doc.autoTable({
                startY: 65,
                head: [['Freelancer', 'Cliente', 'Matrícula']],
                body: body,
                theme: 'striped'
            });
            doc.save(`mapa_freelance_${today}.pdf`);
        }
    }

  </script>
</body>
</html>
