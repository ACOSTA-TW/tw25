<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>THE WAY - Gestão Completa</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Fonte Inter -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- Ícones Phosphor -->
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  <!-- Chart.js para Gráficos -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --color-primary: #c8b89c; /* Beige */
      --color-primary-dark: #b5a589;
      --color-secondary: #6c757d;
      --color-background: #f8f7f4;
      --color-surface: #ffffff;
      --color-text-primary: #212529;
      --color-text-secondary: #6c757d;
      --color-border: #e9ecef;
      --color-danger: #e54a4a;
      --color-success: #198754;
      --color-warning: #ffc107;
    }
    body {
      margin: 0;
      background: var(--color-background);
      font-family: 'Inter', Arial, sans-serif;
      color: var(--color-text-primary);
      font-size: 15px;
    }
    .sidebar {
      position: fixed; left: 0; top: 0; bottom: 0;
      width: 240px; background: var(--color-surface); color: var(--color-text-primary);
      padding: 1.2em; box-shadow: 2px 0 18px #0000000a;
      display: flex; flex-direction: column; z-index: 100;
      box-sizing: border-box;
      border-right: 1px solid var(--color-border);
    }
    .sidebar .logo-box { text-align: center; margin: 1.5em 0 2em;}
    .logo {
      font-size: 1.5em;
      font-weight: 700;
    }
    .sidebar nav {
      flex: 1 1 auto; display: flex; flex-direction: column;
      gap: .7em; margin-top: .5em;
    }
    .sidebar nav button {
      background: none; border: none; color: var(--color-text-secondary);
      font-size: 1.05em; font-weight: 500; text-align: left;
      padding: .8em 1em; border-radius: 8px; cursor: pointer;
      transition: background .2s, color .2s;
      letter-spacing: .02em;
      display: flex; align-items: center; gap: .8em;
    }
    .sidebar nav button i { font-size: 1.3em; }
    .sidebar nav button.active,
    .sidebar nav button:hover {
      background: var(--color-primary);
      color: var(--color-surface);
    }
    .logout-btn {
      background: var(--color-primary); color: var(--color-surface);
      border: none; border-radius: 8px;
      padding: .7em 1.7em; font-weight: 700;
      margin: 1.3em 0 .5em 0; display: block;
      cursor: pointer; font-size: 1em;
      transition: background .16s;
    }
    .logout-btn:hover { background: var(--color-primary-dark); }
    .main-container { margin-left: 240px; padding: 2em; }
    .main-content { display: none; }
    .main-content.active { display: block; }
    .section-header {
        display: flex; justify-content: space-between; align-items: center;
        margin-bottom: 1.5em; flex-wrap: wrap; gap: 1em;
    }
    .section-header h2 {
        margin: 0; font-size: 1.8em; display: flex; align-items: center; gap: .5em;
    }
    .header-actions { display: flex; gap: 1em; align-items: center; }
    .search-bar {
        padding: .8em 1em; border-radius: 8px; border: 1.5px solid var(--color-border);
        font-size: 1em; width: 250px; background: var(--color-surface);
    }
    .btn-primary {
        background: var(--color-primary); color: var(--color-surface);
        border: none; padding: .8em 1.5em; border-radius: 8px;
        font-weight: 600; font-size: 1em; cursor: pointer;
        transition: background .2s; display: flex; align-items: center; gap: .5em;
    }
    .btn-primary:hover { background: var(--color-primary-dark); }
    
    /* Table Styles */
    .table-container {
        background: var(--color-surface); border-radius: 12px;
        padding: 1.5em; box-shadow: 0 4px 20px #0000000a;
        overflow-x: auto;
    }
    .data-table { width: 100%; border-collapse: collapse; }
    .data-table th, .data-table td {
        padding: 1em; text-align: left;
        border-bottom: 1px solid var(--color-border); vertical-align: middle;
    }
    .data-table th {
        font-weight: 600; font-size: .85em; color: var(--color-text-secondary);
        text-transform: uppercase; letter-spacing: .05em;
    }
    .data-table td { font-size: .95em; }
    .data-table tbody tr:last-child td { border-bottom: none; }
    .actions-cell { white-space: nowrap; }
    .actions-cell button {
      background: none; border: none; cursor: pointer;
      padding: .5em; color: var(--color-text-secondary); transition: color .2s;
    }
    .actions-cell button:hover { color: var(--color-primary); }
    .actions-cell button.btn-danger:hover { color: var(--color-danger); }
    .actions-cell i { font-size: 1.3em; }

    /* Modal Styles */
    .modal-overlay {
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.5); display: none;
        align-items: center; justify-content: center;
        z-index: 1000; padding: 1em;
    }
    .modal-overlay.active { display: flex; }
    .modal-box {
        background: var(--color-surface); padding: 2em;
        border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        width: 100%; max-width: 800px;
        max-height: 90vh; overflow-y: auto;
    }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5em; }
    .modal-header h3 { margin: 0; font-size: 1.5em; }
    .modal-header .close-btn { background: none; border: none; font-size: 1.8em; cursor: pointer; color: var(--color-text-secondary); }
    .modal-body .row {display:flex; flex-wrap: wrap; gap:1.5em;}
    .modal-body .col {flex:1; min-width: 250px;}
    .modal-body label {font-weight:600;display:block;margin-bottom:.5em; font-size: .9em;}
    .modal-body input, .modal-body select, .modal-body textarea {
      width: 100%; padding: .8em; border-radius: 8px;
      border: 1.5px solid var(--color-border); font-size: 1em;
      margin-bottom: 1em; background: var(--color-background);
      color: var(--color-text-primary); transition: border .16s;
      box-sizing: border-box;
    }
    .modal-footer { margin-top: 2em; text-align: right; }
    .modal-footer button { padding: .8em 2em; }
    .modal-footer .btn-secondary { background: var(--color-border); color: var(--color-text-primary); margin-right: 1em; }

    /* Details Modal Specifics */
    #detailsModalBody .details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2em; }
    #detailsModalBody h4 { margin-top: 1.5em; margin-bottom: .5em; border-bottom: 1px solid var(--color-border); padding-bottom: .5em; }
    #interactionHistory, #contractInteractionHistory { max-height: 200px; overflow-y: auto; border: 1px solid var(--color-border); border-radius: 8px; padding: 1em; }
    .interaction-item { border-bottom: 1px solid var(--color-border); padding: .8em 0; }
    .interaction-item:last-child { border-bottom: none; }
    .interaction-item .date { font-size: .8em; color: var(--color-text-secondary); margin-bottom: .3em; }
    #interactionForm, #contractInteractionForm { margin-top: 1em; }
    #documentList { list-style: none; padding: 0; }
    #documentList li { display: flex; justify-content: space-between; align-items: center; padding: .5em; border-radius: 6px; }
    #documentList li:hover { background-color: var(--color-background); }
    #milestonesList .milestone-item { display: flex; align-items: center; gap: .8em; padding: .5em 0;}
    #milestonesList .milestone-item label { margin-bottom: 0; font-weight: 500; }
    #milestonesList .milestone-item.completed label { text-decoration: line-through; color: var(--color-text-secondary); }


    /* Dashboard & Reports Styles */
    .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1.5em; margin-bottom: 2em; }
    .kpi-card { background: var(--color-surface); border-radius: 12px; padding: 1.5em; box-shadow: 0 4px 20px #0000000a; }
    .kpi-card .title { font-size: .9em; color: var(--color-text-secondary); margin-bottom: .5em; }
    .kpi-card .value { font-size: 2.2em; font-weight: 700; }
    .kpi-card .subtitle { font-size: .8em; color: var(--color-success); }
    .dashboard-grid, .reports-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 1.5em; margin-bottom: 2em; }
    .chart-container, .tasks-container, .report-widget, .document-tracking-container { background: var(--color-surface); border-radius: 12px; padding: 1.5em; box-shadow: 0 4px 20px #0000000a; }
    .tasks-list .task-item { display: flex; justify-content: space-between; align-items: center; padding: .8em 0; border-bottom: 1px solid var(--color-border); cursor: pointer; transition: background-color .2s; }
    .tasks-list .task-item:hover { background-color: var(--color-background); }
    .tasks-list .task-item:last-child { border-bottom: none; }
    .task-item .title { font-weight: 600; }
    .task-item .deadline { font-size: .9em; color: var(--color-danger); }
    .task-item .urgency-indicator { font-size: 1.5em; color: var(--color-warning); }
    
    /* Document Tracking Widget */
    .doc-tracking-item summary {
        font-weight: 600;
        cursor: pointer;
        padding: .8em;
        border-radius: 8px;
        transition: background-color .2s;
        display: flex; justify-content: space-between;
    }
    .doc-tracking-item summary:hover { background-color: var(--color-background); }
    .doc-tracking-item[open] summary { background-color: var(--color-background); }
    .doc-tracking-body { padding: 1em; display: grid; grid-template-columns: 1fr 1fr; gap: 1.5em; }
    .doc-tracking-body h5 { margin: 0 0 .5em 0; font-size: .9em; display: flex; align-items: center; gap: .5em; }
    .doc-tracking-body input[type="date"] { padding: .5em; font-size: .9em; margin-bottom: 1em; }
    .doc-tracking-body .checklist { font-size: .9em; display: flex; flex-direction: column; gap: .5em; }
    .doc-tracking-body .checklist label { font-weight: 400; }


    /* Tabs Styles */
    .tabs { display: flex; border-bottom: 1px solid var(--color-border); margin-bottom: 1.5em; }
    .tabs button {
        background: none; border: none; padding: 1em 1.5em; cursor: pointer;
        font-size: 1em; font-weight: 500; color: var(--color-text-secondary);
        border-bottom: 3px solid transparent;
    }
    .tabs button.active {
        color: var(--color-primary);
        border-bottom-color: var(--color-primary);
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* Dynamic Form Sections */
    .service-details { display: none; margin-top: 1.5em; border-top: 1px solid var(--color-border); padding-top: 1.5em; }
    .checklist { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: .8em; }
    .checklist label { font-weight: 500; display: flex; align-items: center; gap: .5em; margin-bottom: 0; }
    .checklist input { margin-bottom: 0; }

    /* Login Styles */
    #login-container {
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: var(--color-background);
        display: flex; align-items: center; justify-content: center; z-index: 2000;
    }
    #login-section {
        background: var(--color-surface); padding: 3em; border-radius: 15px;
        box-shadow: 0 10px 30px #0000001a; width: 100%; max-width: 400px;
    }

    @media(max-width:1200px){
        .dashboard-grid, .reports-grid { grid-template-columns: 1fr; }
    }
    @media(max-width:900px){
      .main-container {margin-left:0; padding: 1em; padding-bottom: 80px;}
      #detailsModalBody .details-grid { grid-template-columns: 1fr; }
      .doc-tracking-body { grid-template-columns: 1fr; }
      .sidebar {
          position: fixed; bottom: 0; top: auto; width: 100%; height: auto;
          flex-direction:row; align-items:center; gap: .5em;
          flex-wrap: nowrap; overflow-x: auto; padding: .5em;
          border-top: 1px solid var(--color-border); background: var(--color-surface);
      }
      .sidebar .logo-box { display: none; }
      .sidebar nav{ flex-direction:row; justify-content: space-around; width: 100%;}
      .sidebar nav button { flex-direction: column; gap: .2em; font-size: .8em; padding: .5em; flex: 1; justify-content: center;}
      .sidebar nav button span { font-size: .9em; }
      .sidebar nav button i { font-size: 1.5em; }
      .logout-btn { display: none; }
    }
  </style>
</head>
<body>

  <!-- ECRÃ DE LOGIN -->
  <div id="login-container">
    <div id="login-section">
      <h2>Entrar</h2>
      <form id="loginForm">
        <label>Email</label>
        <input class="input" type="email" id="email" required />
        <label>Password</label>
        <input class="input" type="password" id="password" required minlength="6" />
        <button type="submit" class="btn-primary" style="width: 100%;">Entrar</button>
      </form>
      <div id="loginError" style="color: var(--color-danger); margin-top:1em; text-align: center;"></div>
    </div>
  </div>

  <!-- ESTRUTURA PRINCIPAL (escondida até ao login) -->
  <div id="app-container" style="display: none;">
    <div class="sidebar">
      <div class="logo-box">
        <div class="logo">THE WAY</div>
      </div>
      <nav>
        <button id="nav-dashboard" onclick="showSection('dashboard')"><i class="ph-fill ph-squares-four"></i> <span>Dashboard</span></button>
        <button id="nav-clientes" onclick="showSection('clientes')"><i class="ph-fill ph-users"></i> <span>Gestão de Clientes</span></button>
        <button id="nav-contratos" onclick="showSection('contratos')"><i class="ph-fill ph-file-text"></i> <span>Gestão de Contratos</span></button>
        <button id="nav-parceiros" onclick="showSection('parceiros')"><i class="ph-fill ph-handshake"></i> <span>Parceiros</span></button>
        <button id="nav-tarefas" onclick="showSection('tarefas')"><i class="ph-fill ph-list-checks"></i> <span>Tarefas / Pendentes</span></button>
        <button id="nav-comercial" onclick="showSection('comercial')"><i class="ph-fill ph-briefcase"></i> <span>Gestão de Equipa</span></button>
        <button id="nav-financeira" onclick="showSection('financeira')"><i class="ph-fill ph-bank"></i> <span>Gestão Financeira</span></button>
        <button id="nav-relatorios" onclick="showSection('relatorios')"><i class="ph-fill ph-chart-bar"></i> <span>Relatórios</span></button>
      </nav>
      <button id="logoutBtn" class="logout-btn">Logout</button>
    </div>

    <div class="main-container">
      <!-- Dashboard -->
      <div id="dashboard-section" class="main-content">
          <div class="section-header">
              <h2>Dashboard</h2>
              <div id="dashboard-update-time"></div>
          </div>
          <div class="kpi-grid">
              <div class="kpi-card">
                  <div class="title">Volume Total Crédito</div>
                  <div class="value" id="kpi-credit-volume">€0</div>
                  <div class="subtitle" id="kpi-credit-subtitle">+0% vs mês anterior</div>
              </div>
              <div class="kpi-card">
                  <div class="title">Seguros Fechados</div>
                  <div class="value" id="kpi-closed-insurances">0</div>
                  <div class="subtitle" id="kpi-insurance-volume">Volume: €0</div>
              </div>
              <div class="kpi-card">
                  <div class="title">Pendentes Ativos</div>
                  <div class="value" id="kpi-pending-tasks">0</div>
                  <div class="subtitle" style="color: var(--color-danger)">Requer atenção imediata</div>
              </div>
              <div class="kpi-card">
                  <div class="title">Taxa Resolução</div>
                  <div class="value" id="kpi-resolution-rate">0%</div>
                  <div class="subtitle">Tarefas concluídas</div>
              </div>
          </div>

          <!-- NOVO WIDGET DE CONTROLO DE DOCUMENTOS -->
          <div class="document-tracking-container" style="margin-bottom: 2em;">
              <h4>Controlo de Documentos de Crédito</h4>
              <div id="documentTrackingList"></div>
          </div>

          <div class="dashboard-grid">
              <div class="chart-container">
                  <h4>Volume de Crédito Mensal</h4>
                  <canvas id="creditChart"></canvas>
              </div>
              <div class="tasks-container">
                  <h4>Tarefas Urgentes</h4>
                  <div id="dashboardTasksList" class="tasks-list"></div>
              </div>
          </div>
      </div>

      <!-- Clientes -->
      <div id="clientes-section" class="main-content">
        <div class="section-header">
          <h2><i class="ph ph-users"></i>Gestão de Clientes</h2>
          <div class="header-actions">
            <input type="search" id="search-clientes" class="search-bar" placeholder="Pesquisar por Nome ou NIF...">
            <button class="btn-primary" onclick="openFormModal('cliente')"><i class="ph ph-plus"></i> Adicionar Novo</button>
          </div>
        </div>
        <div class="table-container">
            <table class="data-table" id="clientTable">
                <thead><tr><th>ID</th><th>Nome</th><th>NIF</th><th>Tipo</th><th>Comercial</th><th>RGPD</th><th>Ações</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
      </div>
      
      <!-- Contratos -->
      <div id="contratos-section" class="main-content">
        <div class="section-header">
          <h2><i class="ph ph-file-text"></i>Gestão de Contratos</h2>
          <div class="header-actions">
            <input type="search" id="search-contratos" class="search-bar" placeholder="Pesquisar...">
            <button class="btn-primary" onclick="openFormModal('contrato')"><i class="ph ph-plus"></i> Adicionar Novo</button>
          </div>
        </div>
        <div class="table-container">
            <table class="data-table" id="contractTable">
                <thead><tr><th>Cliente</th><th>Tipo</th><th>Valor</th><th>Fase</th><th>Data de Início</th><th>Comercial</th><th>Ações</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
      </div>

      <!-- Tarefas -->
       <div id="tarefas-section" class="main-content">
        <div class="section-header">
          <h2><i class="ph ph-list-checks"></i>Tarefas / Pendentes</h2>
          <div class="header-actions">
            <button class="btn-primary" onclick="openFormModal('tarefa')"><i class="ph ph-plus"></i> Adicionar Nova Tarefa</button>
          </div>
        </div>
        <div class="table-container">
            <table class="data-table" id="tasksTable">
                <thead><tr><th>Título</th><th>Responsável</th><th>Prazo</th><th>Prioridade</th><th>Estado</th><th>Ações</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
      </div>

      <!-- Parceiros -->
      <div id="parceiros-section" class="main-content">
          <div class="section-header">
              <h2><i class="ph ph-handshake"></i>Parceiros</h2>
          </div>
          <div class="tabs">
              <button class="active" onclick="openPartnerTab(event, 'fornecedores')">Fornecedores</button>
              <button onclick="openPartnerTab(event, 'financeiras')">Financeiras</button>
              <button onclick="openPartnerTab(event, 'seguradoras')">Seguradoras</button>
          </div>

          <!-- Tab Fornecedores -->
          <div id="fornecedores" class="tab-content active">
              <div class="header-actions" style="margin-bottom: 1.5em; justify-content: flex-end;">
                  <button class="btn-primary" onclick="openFormModal('fornecedor')"><i class="ph ph-plus"></i> Adicionar Fornecedor</button>
              </div>
              <div class="table-container">
                  <table class="data-table" id="fornecedoresTable">
                      <thead><tr><th>Nome</th><th>Equipamento</th><th>Contacto</th><th>Email</th><th>Ações</th></tr></thead>
                      <tbody></tbody>
                  </table>
              </div>
          </div>
          <!-- Tab Financeiras -->
          <div id="financeiras" class="tab-content">
              <div class="header-actions" style="margin-bottom: 1.5em; justify-content: flex-end;">
                  <button class="btn-primary" onclick="openFormModal('financeira')"><i class="ph ph-plus"></i> Adicionar Financeira</button>
              </div>
               <div class="table-container">
                  <table class="data-table" id="financeirasTable">
                      <thead><tr><th>Nome</th><th>Nome Comercial</th><th>Contacto</th><th>Email Comercial</th><th>Email Comissões</th><th>Ações</th></tr></thead>
                      <tbody></tbody>
                  </table>
              </div>
          </div>
          <!-- Tab Seguradoras -->
          <div id="seguradoras" class="tab-content">
               <div class="header-actions" style="margin-bottom: 1.5em; justify-content: flex-end;">
                  <button class="btn-primary" onclick="openFormModal('seguradora')"><i class="ph ph-plus"></i> Adicionar Seguradora</button>
              </div>
              <div class="table-container">
                  <table class="data-table" id="seguradorasTable">
                      <thead><tr><th>Nome</th><th>Nome Comercial</th><th>Contacto</th><th>Email Comercial</th><th>Ações</th></tr></thead>
                      <tbody></tbody>
                  </table>
              </div>
          </div>
      </div>
      
      <!-- Gestão Comercial -->
      <div id="comercial-section" class="main-content">
        <div class="section-header">
          <h2><i class="ph ph-briefcase"></i>Gestão de Equipa</h2>
          <div class="header-actions">
            <button class="btn-primary" onclick="openFormModal('comercial')"><i class="ph ph-plus"></i> Adicionar Comercial</button>
          </div>
        </div>
        <div class="table-container">
            <table class="data-table" id="comerciaisTable">
                <thead><tr><th>Nome</th><th>Email</th><th>Telefone</th><th>Função</th><th>Estado</th><th>Ações</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
      </div>
      
      <!-- Gestão Financeira -->
      <div id="financeira-section" class="main-content">
        <div class="section-header">
          <h2><i class="ph ph-bank"></i>Gestão Financeira</h2>
        </div>
        <div class="tabs" id="finance-tabs">
            <button class="active" onclick="openFinanceTab(event, 'financeira-dashboard')">Dashboard Mensal</button>
            <button onclick="openFinanceTab(event, 'financeira-despesas')">Despesas</button>
            <button onclick="openFinanceTab(event, 'financeira-por-conciliar')">Por Conciliar</button>
            <button onclick="openFinanceTab(event, 'financeira-banco')">Banco</button>
        </div>

        <!-- Tab Financeira Dashboard -->
        <div id="financeira-dashboard" class="tab-content active">
            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="title">Comissões a Receber (s/ IVA)</div>
                    <div class="value" id="kpi-comissoes-receber">€0.00</div>
                </div>
                <div class="kpi-card">
                    <div class="title">Comissões a Pagar (c/ IVA)</div>
                    <div class="value" id="kpi-comissoes-pagar">€0.00</div>
                </div>
                <div class="kpi-card">
                    <div class="title">Total Despesas (Mês)</div>
                    <div class="value" id="kpi-total-despesas">€0.00</div>
                </div>
            </div>
            <div class="reports-grid">
                <div class="report-widget">
                    <h4>A Receber das Financeiras (Mês)</h4>
                    <table class="data-table" id="financeirasReceberTable">
                        <thead><tr><th>Financeira</th><th>Valor a Receber</th></tr></thead>
                        <tbody><tr><td colspan="2">A calcular...</td></tr></tbody>
                    </table>
                </div>
                <div class="report-widget">
                    <h4>A Pagar a Fornecedores (Mês)</h4>
                    <table class="data-table" id="fornecedoresPagarTable">
                        <thead><tr><th>Fornecedor</th><th>Valor a Pagar</th></tr></thead>
                        <tbody><tr><td colspan="2">A calcular...</td></tr></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Tab Financeira Despesas -->
        <div id="financeira-despesas" class="tab-content">
            <div class="header-actions" style="margin-bottom: 1.5em; justify-content: flex-end;">
                <button class="btn-primary" onclick="openFormModal('despesa')"><i class="ph ph-plus"></i> Adicionar Despesa</button>
            </div>
            <div class="table-container">
                <table class="data-table" id="despesasTable">
                    <thead><tr><th>Data</th><th>Descrição</th><th>Tipo</th><th>Banco</th><th>Valor</th><th>Conciliada</th><th>Ações</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Tab Financeira Por Conciliar -->
        <div id="financeira-por-conciliar" class="tab-content">
            <div class="header-actions" style="margin-bottom: 1.5em; justify-content: space-between; align-items: center;">
                <h3>Despesas por Conciliar</h3>
                <div class="header-actions">
                    <button class="btn-primary" onclick="openConciliarModal()"><i class="ph ph-check-square"></i> Conciliar Selecionadas</button>
                    <button class="btn-secondary" style="padding: .8em;" onclick="exportarLancamento()" title="Exportar Lançamento"><i class="ph ph-export"></i></button>
                </div>
            </div>
            <div class="table-container">
                <table class="data-table" id="porConciliarTable">
                    <thead><tr><th><input type="checkbox" onchange="toggleAllConciliar(this.checked)"></th><th>Data</th><th>Descrição</th><th>Tipo</th><th>Valor</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        
        <!-- Tab Financeira Banco -->
        <div id="financeira-banco" class="tab-content">
            <div class="header-actions" style="margin-bottom: 1.5em; justify-content: flex-end;">
                <button class="btn-primary" onclick="openFormModal('banco')"><i class="ph ph-plus"></i> Adicionar Conta</button>
            </div>
            <div class="table-container">
                <table class="data-table" id="bancosTable">
                    <thead><tr><th>Nome do Banco</th><th>IBAN</th><th>Saldo</th><th>Ações</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
      </div>
      
      <!-- Relatórios -->
      <div id="relatorios-section" class="main-content">
        <div class="section-header">
          <h2><i class="ph ph-chart-bar"></i>Relatórios</h2>
        </div>
        <div class="reports-grid">
            <div class="report-widget">
                <h4>Desempenho por Comercial</h4>
                <table class="data-table" id="comercialPerformanceTable">
                    <thead><tr><th>Comercial</th><th>Nº Contratos</th><th>Volume Total</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="report-widget">
                <h4>Distribuição de Contratos</h4>
                <div class="chart-container" style="padding: 0; box-shadow: none;">
                    <canvas id="contractTypeChart"></canvas>
                </div>
            </div>
        </div>
      </div>

    </div>
  </div>

  <!-- MODAIS -->
  <div id="formModal" class="modal-overlay">
    <div class="modal-box"><div class="modal-header"><h3 id="formModalTitle"></h3><button class="close-btn" onclick="closeFormModal()">&times;</button></div><div id="formModalBody" class="modal-body"></div></div>
  </div>
  <div id="detailsModal" class="modal-overlay">
    <div class="modal-box"><div class="modal-header"><h3 id="detailsModalTitle"></h3><button class="close-btn" onclick="closeDetailsModal()">&times;</button></div><div id="detailsModalBody" class="modal-body"></div></div>
  </div>
  <div id="confirmModal" class="modal-overlay">
    <div class="modal-box" style="max-width: 400px;"><p id="confirmModalText"></p><div class="modal-footer" style="text-align: center;"><button id="confirmModalNo" class="btn-secondary">Não</button><button id="confirmModalYes" class="btn-primary">Sim</button></div></div>
  </div>
   <!-- MODAL DE CONCILIAÇÃO -->
  <div id="conciliarModal" class="modal-overlay">
    <div class="modal-box" style="max-width: 450px;">
        <div class="modal-header"><h3>Conciliar Despesas</h3><button class="close-btn" onclick="closeConciliarModal()">&times;</button></div>
        <div class="modal-body">
            <p>Selecione a data e o banco para conciliar as <strong id="conciliarCount"></strong> despesa(s) selecionada(s).</p>
            <div class="row">
                <div class="col"><label>Data do Movimento</label><input type="date" id="conciliarDate"></div>
                <div class="col"><label>Banco</label><select id="conciliarBanco"></select></div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn-secondary" onclick="closeConciliarModal()">Cancelar</button>
            <button type="button" class="btn-primary" onclick="conciliarDespesasEmMassa()">Confirmar</button>
        </div>
    </div>
  </div>

  <!-- FIREBASE SDKS -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyA0xYVjKFIv0pJaYksNmh_SKEJJL7bLZbw",
      authDomain: "tw25-1dbb3.firebaseapp.com",
      projectId: "tw25-1dbb3",
      storageBucket: "tw25-1dbb3.appspot.com",
      messagingSenderId: "995776920444",
      appId: "1:995776920444:web:7866264b9f4d74bedac2f9"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // --- LÓGICA DA APLICAÇÃO ---
    let currentUserData = null; // Armazena os dados do utilizador logado (incluindo a função)
    let partnersData = {}; // Cache para dados dos parceiros (fornecedores, financeiras, etc.)

    auth.onAuthStateChanged(async user => {
      const loginContainer = document.getElementById('login-container');
      const appContainer = document.getElementById('app-container');
      if (user) {
        // Encontrar o perfil do utilizador na coleção 'comerciais' pelo email
        const comecialSnapshot = await db.collection('comerciais').where('email', '==', user.email).limit(1).get();
        if (!comecialSnapshot.empty) {
            const doc = comecialSnapshot.docs[0];
            currentUserData = { id: doc.id, ...doc.data() };
        } else {
            // Fallback: se não encontrar perfil, assume Administrador (não ideal para produção)
            currentUserData = { id: user.uid, email: user.email, role: 'Administrador', firstName: 'Admin' };
            console.warn("Utilizador autenticado mas sem perfil na coleção 'comerciais'. A assumir função de Administrador.");
        }
        
        // Esconder/mostrar secções com base na função
        setupUIVisibility();
        await preloadPartnerData(); // Carregar dados dos parceiros para cache

        loginContainer.style.display = 'none';
        appContainer.style.display = 'block';
        showSection('dashboard');
        loadAllData();
      } else {
        currentUserData = null;
        loginContainer.style.display = 'flex';
        appContainer.style.display = 'none';
      }
    });
    
    function setupUIVisibility() {
        if (!currentUserData) return;
        const isAdmin = currentUserData.role === 'Administrador';
        document.getElementById('nav-comercial').style.display = isAdmin ? 'flex' : 'none';
        document.getElementById('nav-financeira').style.display = isAdmin ? 'flex' : 'none';
        document.getElementById('nav-relatorios').style.display = isAdmin ? 'flex' : 'none';
    }

    document.getElementById('loginForm').onsubmit = e => {
      e.preventDefault();
      document.getElementById('loginError').textContent = '';
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      auth.signInWithEmailAndPassword(email, password)
        .catch(err => {
            document.getElementById('loginError').textContent = "Login falhou. Verifique os seus dados.";
        });
    };
    document.getElementById('logoutBtn').onclick = () => auth.signOut();

    function showSection(sectionId) {
        document.querySelectorAll('.main-content').forEach(s => s.classList.remove('active'));
        document.getElementById(sectionId + '-section').classList.add('active');
        document.querySelectorAll('.sidebar nav button').forEach(b => b.classList.remove('active'));
        document.getElementById('nav-' + sectionId).classList.add('active');
        
        // Carrega dados específicos da secção quando é aberta
        if (sectionId === 'dashboard') loadDashboardData();
        if (sectionId === 'financeira') loadFinanceiraModule();
        if (sectionId === 'relatorios') loadRelatoriosData();
    }

    function loadAllData() {
        loadClients();
        loadContracts();
        loadTasks();
        loadPartners();
        if (currentUserData && currentUserData.role === 'Administrador') {
            loadComerciais();
        }
        loadDashboardData(); // Carrega o dashboard por defeito
    }

    // --- MODAIS ---
    const formModal = document.getElementById('formModal');
    const detailsModal = document.getElementById('detailsModal');
    let currentFormSubmitHandler = null;

    async function openFormModal(type, id = null) {
        document.getElementById('formModalTitle').textContent = `${id ? 'Editar' : 'Adicionar'} ${type.charAt(0).toUpperCase() + type.slice(1)}`;
        const formModalBody = document.getElementById('formModalBody');
        formModalBody.innerHTML = ''; 
        
        let formHTML = '';
        switch(type) {
            case 'cliente': formHTML = getClientFormHTML(); break;
            case 'contrato': formHTML = getContractFormHTML(); break;
            case 'tarefa': formHTML = getTaskFormHTML(); break;
            case 'fornecedor': formHTML = getFornecedorFormHTML(); break;
            case 'financeira': formHTML = getFinanceiraFormHTML(); break;
            case 'seguradora': formHTML = getSeguradoraFormHTML(); break;
            case 'comercial': formHTML = getComercialFormHTML(); break;
            case 'despesa': formHTML = getDespesaFormHTML(); break;
            case 'banco': formHTML = getBancoFormHTML(); break;
        }
        formModalBody.innerHTML = formHTML;

        // Pós-renderização e carregamento de dados para formulários
        if (id) {
            if (type === 'cliente') await populateClientForm(id);
            if (type === 'contrato') await loadContractDropdowns(() => populateContractForm(id));
            if (type === 'tarefa') await loadDropdownsForTaskForm(() => populateTaskForm(id));
            if (type === 'fornecedor') await populatePartnerForm('fornecedores', id);
            if (type === 'financeira') await populatePartnerForm('financeiras', id);
            if (type === 'seguradora') await populatePartnerForm('seguradoras', id);
            if (type === 'comercial') await populateComercialForm(id);
            if (type === 'despesa') await populateDespesaForm(id);
            if (type === 'banco') await populateBancoForm(id);
        } else {
            if (type === 'cliente') {
                document.getElementById('clientCreationDate').value = new Date().toISOString().split('T')[0];
                await loadComerciaisForDropdown('clientManager');
            }
            if (type === 'contrato') await loadContractDropdowns();
            if (type === 'tarefa') await loadDropdownsForTaskForm();
            if (type === 'despesa') {
                document.getElementById('despesaDate').value = new Date().toISOString().split('T')[0];
                await loadBancosForDropdown('despesaBanco');
            }
        }
        
        const form = formModalBody.querySelector('form');
        currentFormSubmitHandler = async (e) => {
            e.preventDefault();
            switch(type) {
                case 'cliente': await handleClientFormSubmit(id); break;
                case 'contrato': await handleContractFormSubmit(id); break;
                case 'tarefa': await handleTaskFormSubmit(id); break;
                case 'fornecedor': await handlePartnerFormSubmit('fornecedores', id); break;
                case 'financeira': await handlePartnerFormSubmit('financeiras', id); break;
                case 'seguradora': await handlePartnerFormSubmit('seguradoras', id); break;
                case 'comercial': await handleComercialFormSubmit(id); break;
                case 'despesa': await handleDespesaFormSubmit(id); break;
                case 'banco': await handleBancoFormSubmit(id); break;
            }
        };
        form.addEventListener('submit', currentFormSubmitHandler);
        formModal.classList.add('active');
    }

    function closeFormModal() {
        const form = document.getElementById('formModalBody').querySelector('form');
        if (form && currentFormSubmitHandler) {
            form.removeEventListener('submit', currentFormSubmitHandler);
        }
        formModal.classList.remove('active');
    }
    
    async function openDetailsModal(type, id) {
        const detailsModalTitle = document.getElementById('detailsModalTitle');
        const detailsModalBody = document.getElementById('detailsModalBody');
        detailsModalBody.innerHTML = 'A carregar...';
        detailsModal.classList.add('active');

        if (type === 'cliente') {
            const doc = await db.collection('clientes').doc(id).get();
            if (doc.exists) {
                const d = doc.data();
                detailsModalTitle.textContent = `Detalhes de: ${d.name}`;
                detailsModalBody.innerHTML = `
                    <div class="details-grid">
                        <div>
                            <h4>Dados Pessoais e Comerciais</h4>
                            <p><strong>Nome:</strong> ${d.name || '-'}</p><p><strong>Email:</strong> ${d.email || '-'}</p><p><strong>Telefone:</strong> ${d.phone || '-'}</p><p><strong>NIF:</strong> ${d.nif || '-'}</p><p><strong>Morada:</strong> ${d.address || '-'}</p><p><strong>Código Postal:</strong> ${d.postalCode || '-'}</p><p><strong>Localidade:</strong> ${d.city || '-'}</p>
                        </div>
                        <div>
                            <h4>Documentos Associados</h4>
                            <p><i>(Funcionalidade de upload a ser implementada)</i></p>
                        </div>
                    </div>
                    <h4>Contratos Associados</h4>
                    <div id="associatedContracts">A carregar contratos...</div>
                    <h4>Histórico de Interações</h4>
                    <div id="interactionHistory"></div>
                    <form id="interactionForm">
                        <label>Adicionar Nova Interação</label>
                        <textarea id="newInteractionNote" rows="3" required></textarea>
                        <div class="modal-footer" style="margin-top: 1em; padding: 0;"><button type="submit" class="btn-primary">Adicionar</button></div>
                    </form>
                `;
                
                loadAssociatedContracts(id);
                loadInteractions('clientes', id, 'interactionHistory');

                document.getElementById('interactionForm').onsubmit = (e) => {
                    e.preventDefault();
                    const note = document.getElementById('newInteractionNote').value;
                    handleInteractionSubmit('clientes', id, note, 'interactionHistory');
                    document.getElementById('newInteractionNote').value = '';
                };
            }
        } else if (type === 'contrato') {
            const doc = await db.collection('contratos').doc(id).get();
            if (doc.exists) {
                const d = doc.data();
                detailsModalTitle.textContent = `Detalhes do Contrato: ${d.type}`;
                detailsModalBody.innerHTML = `
                    <div class="details-grid">
                        <div>
                             <h4>Informação do Contrato</h4>
                            <p><strong>Cliente:</strong> ${d.clientName || '-'}</p>
                            <p><strong>Tipo de Serviço:</strong> ${d.type || '-'}</p>
                            <p><strong>Valor:</strong> €${parseFloat(d.valorFinanciado || 0).toLocaleString('pt-PT')}</p>
                            <p><strong>Fase:</strong> ${d.fase || '-'}</p>
                            <p><strong>Data de Início:</strong> ${d.startDate || '-'}</p>
                            <p><strong>Comercial:</strong> ${d.commercialName || '-'}</p>
                            <hr>
                            <h4>Observações</h4>
                            <p>${d.notes || 'Nenhuma observação.'}</p>
                        </div>
                        <div>
                            <h4>Etapas e Tarefas Associadas</h4>
                            <div id="milestonesList"></div>
                            <form id="milestoneForm" style="margin-top: 1em; border-top: 1px solid var(--color-border); padding-top: 1em;">
                                <label>Adicionar Etapa e Tarefa (Opcional)</label>
                                <input type="text" id="newMilestoneDescription" placeholder="Descrição da nova etapa*" required>
                                <div class="row">
                                    <div class="col"><input type="text" id="newMilestoneOwner" placeholder="Responsável da tarefa"></div>
                                    <div class="col"><input type="date" id="newMilestoneDueDate"></div>
                                </div>
                                <button type="submit" class="btn-primary" style="width: 100%;">Adicionar Etapa</button>
                            </form>
                        </div>
                    </div>
                    <h4>Histórico de Interações do Contrato</h4>
                    <div id="contractInteractionHistory"></div>
                     <form id="contractInteractionForm">
                        <label>Adicionar Nova Interação</label>
                        <textarea id="newContractInteractionNote" rows="3" required></textarea>
                        <div class="modal-footer" style="margin-top: 1em; padding: 0;"><button type="submit" class="btn-primary">Adicionar</button></div>
                    </form>
                `;
                loadMilestones(id, 'milestonesList');
                loadInteractions('contratos', id, 'contractInteractionHistory');

                document.getElementById('milestoneForm').onsubmit = (e) => {
                    e.preventDefault();
                    handleMilestoneSubmit(id);
                };

                document.getElementById('contractInteractionForm').onsubmit = (e) => {
                    e.preventDefault();
                    const note = document.getElementById('newContractInteractionNote').value;
                    handleInteractionSubmit('contratos', id, note, 'contractInteractionHistory');
                    document.getElementById('newContractInteractionNote').value = '';
                };
            }
        }
    }

    function closeDetailsModal() { detailsModal.classList.remove('active'); }

    const confirmModal = document.getElementById('confirmModal');
    let confirmCallback = null;
    function showConfirmModal(message, callback) {
        document.getElementById('confirmModalText').textContent = message;
        confirmCallback = callback;
        confirmModal.classList.add('active');
    }
    document.getElementById('confirmModalYes').onclick = () => {
        if (confirmCallback) confirmCallback();
        confirmModal.classList.remove('active');
    };
    document.getElementById('confirmModalNo').onclick = () => { confirmModal.classList.remove('active'); };

    // --- DASHBOARD ---
    let creditChartInstance = null;
    async function loadDashboardData() {
        const today = new Date();
        document.getElementById('dashboard-update-time').textContent = `Última atualização: hoje às ${String(today.getHours()).padStart(2, '0')}:${String(today.getMinutes()).padStart(2, '0')}`;

        loadDocumentTrackingWidget();

        // KPIs
        const contractsSnapshot = await db.collection('contratos').where('fase', '==', 'Ativo').get();
        let creditVolume = 0;
        let closedInsurances = 0;
        let monthlyCreditData = new Array(6).fill(0);
        const sixMonthsAgo = new Date();
        sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 5);
        sixMonthsAgo.setDate(1);

        contractsSnapshot.forEach(doc => {
            const contract = doc.data();
            if (contract.type === 'Crédito' && contract.valorFinanciado) {
                creditVolume += parseFloat(contract.valorFinanciado);
                const contractDate = new Date(contract.startDate);
                if(contractDate >= sixMonthsAgo) {
                    const monthDiff = (today.getFullYear() - contractDate.getFullYear()) * 12 + (today.getMonth() - contractDate.getMonth());
                    if (monthDiff >= 0 && monthDiff < 6) {
                        monthlyCreditData[5 - monthDiff] += parseFloat(contract.valorFinanciado);
                    }
                }
            }
            if (contract.type === 'Seguro') {
                closedInsurances++;
            }
        });
        document.getElementById('kpi-credit-volume').textContent = `€${creditVolume.toLocaleString('pt-PT', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        document.getElementById('kpi-closed-insurances').textContent = closedInsurances;

        const tasksSnapshot = await db.collection('tarefas').where('status', '==', 'Pendente').get();
        document.getElementById('kpi-pending-tasks').textContent = tasksSnapshot.size;
        
        const allTasksSnapshot = await db.collection('tarefas').get();
        const completedTasksSnapshot = await db.collection('tarefas').where('status', '==', 'Concluído').get();
        const resolutionRate = allTasksSnapshot.size > 0 ? Math.round((completedTasksSnapshot.size / allTasksSnapshot.size) * 100) : 0;
        document.getElementById('kpi-resolution-rate').textContent = `${resolutionRate}%`;

        // Lista de Tarefas
        const dashboardTasksList = document.getElementById('dashboardTasksList');
        dashboardTasksList.innerHTML = '';
        const pendingTasksSnapshot = await db.collection('tarefas').where('status', '==', 'Pendente').get();
        
        let tasks = [];
        pendingTasksSnapshot.forEach(doc => {
            tasks.push({ id: doc.id, ...doc.data() });
        });

        // Ordenar tarefas por data de vencimento (no lado do cliente)
        tasks.sort((a, b) => {
            if (!a.dueDate) return 1;
            if (!b.dueDate) return -1;
            return new Date(a.dueDate) - new Date(b.dueDate);
        });

        const recentTasks = tasks.slice(0, 5); // Obter as 5 mais recentes

        if (recentTasks.length === 0) {
            dashboardTasksList.innerHTML = '<p>Nenhuma tarefa pendente.</p>';
        } else {
            recentTasks.forEach(task => {
                const item = document.createElement('div');
                item.className = 'task-item';
                item.onclick = () => showSection('tarefas');
                
                let urgencyIndicator = '';
                if (task.dueDate) {
                    const dueDate = new Date(task.dueDate);
                    const startOfToday = new Date();
                    startOfToday.setHours(0,0,0,0);
                    const diffTime = dueDate - startOfToday;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    if (diffDays <= 3 && diffDays >= 0) {
                        urgencyIndicator = `<i class="ph-fill ph-warning-circle urgency-indicator" title="Prazo termina em ${diffDays+1} dias!"></i>`;
                    }
                }

                item.innerHTML = `<div><div class="title">${task.title}</div><div class="deadline">Prazo: ${task.dueDate || 'N/D'}</div></div>${urgencyIndicator}`;
                dashboardTasksList.appendChild(item);
            });
        }
        
        // Gráfico Dinâmico
        const monthNames = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
        let labels = [];
        for (let i = 5; i >= 0; i--) {
            labels.push(monthNames[(today.getMonth() - i + 12) % 12]);
        }
        const ctx = document.getElementById('creditChart').getContext('2d');
        if(creditChartInstance) creditChartInstance.destroy();
        creditChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Volume de Crédito',
                    data: monthlyCreditData,
                    backgroundColor: 'rgba(200, 184, 156, 0.7)',
                    borderColor: 'rgba(200, 184, 156, 1)',
                    borderWidth: 1,
                    borderRadius: 5
                }]
            },
            options: { responsive: true, scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } }
        });
    }

    // --- PARCEIROS ---
    async function preloadPartnerData() {
        const partnerTypes = ['fornecedores', 'financeiras', 'seguradoras'];
        for (const type of partnerTypes) {
            partnersData[type] = {};
            const snapshot = await db.collection(type).get();
            snapshot.forEach(doc => {
                partnersData[type][doc.id] = doc.data().name;
            });
        }
    }

    function openPartnerTab(evt, tabName) {
        document.querySelectorAll('#parceiros-section .tab-content').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('#parceiros-section .tabs button').forEach(btn => btn.classList.remove('active'));
        document.getElementById(tabName).classList.add('active');
        evt.currentTarget.classList.add('active');
    }

    async function loadPartners() {
        loadPartnerData('fornecedores');
        loadPartnerData('financeiras');
        loadPartnerData('seguradoras');
        await preloadPartnerData(); // Recarregar cache se houver alterações
    }
    
    async function loadPartnerData(type) {
        const tableBody = document.getElementById(`${type}Table`).querySelector('tbody');
        tableBody.innerHTML = '';
        const snapshot = await db.collection(type).orderBy('name').get();
        snapshot.forEach(doc => {
            const d = doc.data();
            const row = tableBody.insertRow();
            let cells = '';
            if (type === 'fornecedores') {
                cells = `<td>${d.name}</td><td>${d.equipment}</td><td>${d.contactPerson}</td><td>${d.email}</td>`;
            } else if (type === 'financeiras') {
                cells = `<td>${d.name}</td><td>${d.commercialName}</td><td>${d.commercialContact}</td><td>${d.commercialEmail}</td><td>${d.commissionEmail}</td>`;
            } else if (type === 'seguradoras') {
                cells = `<td>${d.name}</td><td>${d.commercialName}</td><td>${d.commercialContact}</td><td>${d.commercialEmail}</td>`;
            }
            row.innerHTML = `${cells}<td class="actions-cell"><button onclick="openFormModal('${type.slice(0, -1)}', '${doc.id}')" title="Editar"><i class="ph ph-pencil-simple"></i></button><button class="btn-danger" onclick="deleteItem('${type}', '${doc.id}', '${d.name}', loadPartners)" title="Eliminar"><i class="ph ph-trash"></i></button></td>`;
        });
    }
    
    async function handlePartnerFormSubmit(type, id) {
        let data = {};
        if (type === 'fornecedores') {
            data = {
                name: document.getElementById('partnerName').value, nif: document.getElementById('partnerNif').value, iban: document.getElementById('partnerIban').value, address: document.getElementById('partnerAddress').value, postalCode: document.getElementById('partnerPostalCode').value, city: document.getElementById('partnerCity').value, phone: document.getElementById('partnerPhone').value, email: document.getElementById('partnerEmail').value, cae: document.getElementById('partnerCae').value, capital: document.getElementById('partnerCapital').value, contactPerson: document.getElementById('partnerContactPerson').value, equipment: document.getElementById('partnerEquipment').value
            };
        } else if (type === 'financeiras') {
            data = {
                name: document.getElementById('partnerName').value, address: document.getElementById('partnerAddress').value, nif: document.getElementById('partnerNif').value, commercialName: document.getElementById('partnerCommercialName').value, commercialDob: document.getElementById('partnerCommercialDob').value, commercialContact: document.getElementById('partnerCommercialContact').value, commercialEmail: document.getElementById('partnerCommercialEmail').value, commissionEmail: document.getElementById('partnerCommissionEmail').value
            };
        } else if (type === 'seguradoras') {
            data = {
                name: document.getElementById('partnerName').value, address: document.getElementById('partnerAddress').value, nif: document.getElementById('partnerNif').value, commercialName: document.getElementById('partnerCommercialName').value, commercialDob: document.getElementById('partnerCommercialDob').value, commercialContact: document.getElementById('partnerCommercialContact').value, commercialEmail: document.getElementById('partnerCommercialEmail').value
            };
        }
        
        const action = id ? db.collection(type).doc(id).update(data) : db.collection(type).add(data);
        await action;
        closeFormModal();
        loadPartners();
    }
    
    async function populatePartnerForm(type, id) {
        const doc = await db.collection(type).doc(id).get();
        if(!doc.exists) return;
        const d = doc.data();
        if (type === 'fornecedores') {
            document.getElementById('partnerName').value = d.name || ''; document.getElementById('partnerNif').value = d.nif || ''; document.getElementById('partnerIban').value = d.iban || ''; document.getElementById('partnerAddress').value = d.address || ''; document.getElementById('partnerPostalCode').value = d.postalCode || ''; document.getElementById('partnerCity').value = d.city || ''; document.getElementById('partnerPhone').value = d.phone || ''; document.getElementById('partnerEmail').value = d.email || ''; document.getElementById('partnerCae').value = d.cae || ''; document.getElementById('partnerCapital').value = d.capital || ''; document.getElementById('partnerContactPerson').value = d.contactPerson || ''; document.getElementById('partnerEquipment').value = d.equipment || '';
        } else if (type === 'financeiras') {
            document.getElementById('partnerName').value = d.name || ''; document.getElementById('partnerAddress').value = d.address || ''; document.getElementById('partnerNif').value = d.nif || ''; document.getElementById('partnerCommercialName').value = d.commercialName || ''; document.getElementById('partnerCommercialDob').value = d.commercialDob || ''; document.getElementById('partnerCommercialContact').value = d.commercialContact || ''; document.getElementById('partnerCommercialEmail').value = d.commercialEmail || ''; document.getElementById('partnerCommissionEmail').value = d.commissionEmail || '';
        } else if (type === 'seguradoras') {
            document.getElementById('partnerName').value = d.name || ''; document.getElementById('partnerAddress').value = d.address || ''; document.getElementById('partnerNif').value = d.nif || ''; document.getElementById('partnerCommercialName').value = d.commercialName || ''; document.getElementById('partnerCommercialDob').value = d.commercialDob || ''; document.getElementById('partnerCommercialContact').value = d.commercialContact || ''; document.getElementById('partnerCommercialEmail').value = d.commercialEmail || '';
        }
    }

    // --- TAREFAS ---
    async function loadTasks() {
        const tableBody = document.getElementById('tasksTable').querySelector('tbody');
        tableBody.innerHTML = '';
        const snapshot = await db.collection('tarefas').orderBy('dueDate').get();
        snapshot.forEach(doc => {
            const d = doc.data();
            const row = tableBody.insertRow();
            row.innerHTML = `
                <td>${d.title}</td>
                <td>${d.owner || '-'}</td>
                <td>${d.dueDate || '-'}</td>
                <td>${d.priority || '-'}</td>
                <td>${d.status || '-'}</td>
                <td class="actions-cell">
                    ${d.status !== 'Concluído' ? `<button onclick="completeTask('${doc.id}', '${d.title}')" title="Concluir Tarefa"><i class="ph ph-check-circle"></i></button>` : ''}
                    <button onclick="openFormModal('tarefa', '${doc.id}')" title="Editar"><i class="ph ph-pencil-simple"></i></button>
                    <button class="btn-danger" onclick="deleteItem('tarefas', '${doc.id}', '${d.title}', loadTasks)" title="Eliminar"><i class="ph ph-trash"></i></button>
                </td>
            `;
        });
    }
    
    async function completeTask(id, title) {
        const taskDocRef = db.collection('tarefas').doc(id);
        const taskDoc = await taskDocRef.get();
        if (!taskDoc.exists) return;
        const taskData = taskDoc.data();

        const today = new Date().toISOString().split('T')[0];
        await taskDocRef.update({
            status: 'Concluído',
            completionDate: today
        });
        
        const note = `Tarefa '${title}' foi concluída.`;
        
        if (taskData.clientId) { handleInteractionSubmit('clientes', taskData.clientId, note); }
        if (taskData.contractId) { 
            handleInteractionSubmit('contratos', taskData.contractId, note); 
            // Se for uma tarefa automática de documentos, adiciona nota específica
            if (taskData.autoTaskType === 'documentos_em_falta') {
                const docNote = `Pendente de documentos em falta foi resolvido.`;
                handleInteractionSubmit('contratos', taskData.contractId, docNote);
            }
        }
        
        loadTasks();
        loadDashboardData();
    }

    // --- Funções de ajuda e genéricas ---
    function getClientFormHTML() { return `<form id="clientForm"><div class="row"><div class="col"><label>Nome Completo</label><input type="text" id="clientName" required /></div><div class="col"><label>Email</label><input type="email" id="clientEmail" /></div></div><div class="row"><div class="col"><label>Telefone</label><input type="tel" id="clientPhone" /></div><div class="col"><label>NIF</label><input type="text" id="clientNif" maxlength="9" /></div></div><label>Morada</label><input type="text" id="clientAddress" /><div class="row"><div class="col"><label>Código Postal</label><input type="text" id="clientPostalCode" /></div><div class="col"><label>Localidade</label><input type="text" id="clientCity" /></div></div><div class="row"><div class="col"><label>Tipo de Serviço</label><select id="clientServiceType"><option value="">Selecionar</option><option value="Crédito">Crédito</option><option value="Seguro">Seguro</option><option value="Consultoria">Consultoria</option><option value="Legalização">Legalização</option></select></div><div class="col"><label>Comercial Responsável</label><select id="clientManager"></select></div></div><div class="row"><div class="col"><label>Data de Criação</label><input type="date" id="clientCreationDate" readonly /></div><div class="col"><label>RGPD Assinado?</label><select id="clientRgpd"><option value="Sim">Sim</option><option value="Não">Não</option></select></div></div><label>Observações Internas</label><textarea id="clientInternalNotes" rows="3"></textarea><div class="modal-footer"><button type="button" class="btn-secondary" onclick="closeFormModal()">Cancelar</button><button type="submit" class="btn-primary">Guardar</button></div></form>`; }
    async function handleClientFormSubmit(id) { const managerSelect = document.getElementById('clientManager'); const data = { name: document.getElementById('clientName').value.trim(), email: document.getElementById('clientEmail').value.trim(), phone: document.getElementById('clientPhone').value.trim(), nif: document.getElementById('clientNif').value.trim(), address: document.getElementById('clientAddress').value.trim(), postalCode: document.getElementById('clientPostalCode').value.trim(), city: document.getElementById('clientCity').value.trim(), serviceType: document.getElementById('clientServiceType').value, managerId: managerSelect.value, managerName: managerSelect.options[managerSelect.selectedIndex]?.text || '', rgpd: document.getElementById('clientRgpd').value, creationDate: document.getElementById('clientCreationDate').value, internalNotes: document.getElementById('clientInternalNotes').value.trim(), clientType: 'Particular' }; const action = id ? db.collection('clientes').doc(id).update(data) : db.collection('clientes').add(data); await action; closeFormModal(); loadClients(); loadDashboardData(); }
    async function populateClientForm(id) { await loadComerciaisForDropdown('clientManager'); const doc = await db.collection('clientes').doc(id).get(); if (doc.exists) { const d = doc.data(); document.getElementById('clientName').value = d.name || ''; document.getElementById('clientEmail').value = d.email || ''; document.getElementById('clientPhone').value = d.phone || ''; document.getElementById('clientNif').value = d.nif || ''; document.getElementById('clientAddress').value = d.address || ''; document.getElementById('clientPostalCode').value = d.postalCode || ''; document.getElementById('clientCity').value = d.city || ''; document.getElementById('clientServiceType').value = d.serviceType || ''; document.getElementById('clientManager').value = d.managerId || ''; document.getElementById('clientRgpd').value = d.rgpd || 'Não'; document.getElementById('clientCreationDate').value = d.creationDate || ''; document.getElementById('clientInternalNotes').value = d.internalNotes || ''; } }
    
    // --- CONTRATOS ---
    function getContractFormHTML() { 
        return `<form id="contractForm">
            <div class="row">
                <div class="col"><label>Cliente*</label><select id="contractClient" required></select></div>
                <div class="col"><label>Data do Contrato</label><input type="date" id="contractDate"></div>
                <div class="col"><label>Comercial*</label><select id="contractCommercial" required></select></div>
            </div>
            <div class="row">
                <div class="col"><label>Tipo de Serviço*</label>
                    <select id="contractType" onchange="handleContractTypeChange(this.value)" required>
                        <option value="">Selecione Tipo de Serviço</option>
                        <option value="Crédito">Crédito</option>
                        <option value="Seguro">Seguro</option>
                        <option value="Legalização Automóvel">Legalização Automóvel</option>
                        <option value="Consultoria Financeira">Consultoria Financeira</option>
                    </select>
                </div>
                 <div class="col"><label>Fase do Contrato</label>
                    <select id="contractFase">
                        <option value="Proposta">Proposta</option>
                        <option value="Ativo">Ativo</option>
                        <option value="Cancelado">Cancelado</option>
                    </select>
                </div>
            </div>

            <!-- Detalhes Crédito -->
            <div id="detailsCredito" class="service-details">
                <h4>Detalhes do Crédito</h4>
                 <div class="row">
                    <div class="col"><label>Nº Proposta</label><input type="text" id="creditoProposta"></div>
                    <div class="col"><label>Matrícula</label><input type="text" id="creditoMatricula"></div>
                </div>
                <div class="row">
                    <div class="col"><label>Fornecedor</label><select id="creditoFornecedor"></select></div>
                    <div class="col"><label>Financeira</label><select id="creditoFinanceira"></select></div>
                </div>
                <div class="row">
                    <div class="col"><label>Tipo de Crédito</label><input type="text" id="creditoTipo" placeholder="Ex: Pessoal, Automóvel"></div>
                    <div class="col"><label>Valor Financiado (€)</label><input type="number" id="creditoValorFinanciado" oninput="calculateComissaoPagar()"></div>
                </div>
                <div class="row">
                    <div class="col"><label>Comissão (%)</label><input type="number" id="creditoComissaoPercent" oninput="calculateComissaoPagar()"></div>
                    <div class="col"><label>Comissão a Pagar</label><input type="text" id="creditoComissaoPagar" readonly style="background-color: #eee;"></div>
                </div>
                <div class="row">
                    <div class="col"><label>Comissão Recebida (€)</label><input type="number" id="creditoComissaoRecebida"></div>
                </div>
                 <div class="row">
                    <div class="col"><label>Data entrega fornecedor</label><input type="date" id="creditoDataFornecedor"></div>
                    <div class="col"><label>Data entrega financeira</label><input type="date" id="creditoDataFinanceira"></div>
                </div>
                <label><input type="checkbox" id="creditoDocsFaltaCheck" onchange="document.getElementById('creditoDocsFaltaContainer').style.display = this.checked ? 'block' : 'none'"> Documentos em falta?</label>
                <div id="creditoDocsFaltaContainer" style="display:none;"><textarea id="creditoDocsFalta" rows="2" placeholder="Especificar documentos..."></textarea></div>
                <h4>Checklist Documentos</h4>
                <div class="checklist">
                    <label><input type="checkbox" name="creditoChecklist" value="Livrete"> Livrete</label>
                    <label><input type="checkbox" name="creditoChecklist" value="Contrato"> Contrato</label>
                    <label><input type="checkbox" name="creditoChecklist" value="DUA"> DUA</label>
                    <label><input type="checkbox" name="creditoChecklist" value="DAV"> DAV</label>
                    <label><input type="checkbox" name="creditoChecklist" value="MUA de compra"> MUA de compra</label>
                    <label><input type="checkbox" name="creditoChecklist" value="MUA de venda"> MUA de venda</label>
                    <label><input type="checkbox" name="creditoChecklist" value="Extinção de reserva"> Extinção de reserva</label>
                </div>
                <label style="margin-top: 1em;"><input type="checkbox" id="creditoRealizado"> Crédito realizado?</label>
            </div>

            <!-- Detalhes Seguro -->
            <div id="detailsSeguro" class="service-details">
                <h4>Detalhes do Seguro</h4>
                <div class="row">
                    <div class="col"><label>Tipo de Seguro</label><input type="text" id="seguroTipo"></div>
                    <div class="col"><label>Seguradora</label><select id="seguroSeguradora"></select></div>
                </div>
                <div class="row">
                    <div class="col"><label>Nº Apólice</label><input type="text" id="seguroApolice"></div>
                    <div class="col"><label>Matrícula</label><input type="text" id="seguroMatricula"></div>
                </div>
                <div class="row">
                    <div class="col"><label>Data Subscrição</label><input type="date" id="seguroDataSubscricao"></div>
                    <div class="col"><label>Comissão Recebida (€)</label><input type="number" id="seguroComissao"></div>
                </div>
                <label><input type="checkbox" id="seguroRenovacao"> Renovação automática?</label>
                <label><input type="checkbox" id="seguroIsFreelancer" onchange="document.getElementById('seguroFreelancerContainer').style.display = this.checked ? 'block' : 'none'"> Freelancer?</label>
                <div id="seguroFreelancerContainer" style="display:none;"><input type="text" id="seguroFreelancerName" placeholder="Nome do Freelancer"></div>
            </div>

            <!-- Detalhes Legalização Automóvel -->
            <div id="detailsLegalizacao" class="service-details">
                <h4>Detalhes da Legalização</h4>
                <div class="row">
                    <div class="col"><label>Nº Chassis</label><input type="text" id="legalizacaoChassis"></div>
                    <div class="col"><label>Matrícula Estrangeira</label><input type="text" id="legalizacaoMatricula"></div>
                </div>
                <div class="row">
                    <div class="col"><label>País de Importação</label><input type="text" id="legalizacaoPais"></div>
                    <div class="col"><label>Data Estimada de Conclusão</label><input type="date" id="legalizacaoDataConclusao"></div>
                </div>
            </div>

            <!-- Detalhes Consultoria Financeira -->
            <div id="detailsConsultoria" class="service-details">
                <h4>Detalhes da Consultoria</h4>
                <label>Diagnóstico Financeiro Feito?</label>
                <select id="consultoriaDiagnostico"><option value="Não">Não</option><option value="Sim">Sim</option></select>
                <label>Situação Atual (Rendimentos, despesas, dívidas)</label>
                <textarea id="consultoriaSituacao" rows="3"></textarea>
                <label>Data da Sessão</label>
                <input type="date" id="consultoriaDataSessao">
                <label>Ações a Implementar</label>
                <textarea id="consultoriaAcoes" rows="3"></textarea>
            </div>

            <div class="modal-footer"><button type="button" class="btn-secondary" onclick="closeFormModal()">Cancelar</button><button type="submit" class="btn-primary">Guardar Contrato</button></div>
        </form>`; 
    }

    async function handleContractTypeChange(serviceType) {
        document.querySelectorAll('.service-details').forEach(div => div.style.display = 'none');
        if (serviceType === 'Crédito') {
            document.getElementById('detailsCredito').style.display = 'block';
            await loadPartnersForDropdown('fornecedores', 'creditoFornecedor');
            await loadPartnersForDropdown('financeiras', 'creditoFinanceira');
        }
        if (serviceType === 'Seguro') {
            document.getElementById('detailsSeguro').style.display = 'block';
            await loadPartnersForDropdown('seguradoras', 'seguroSeguradora');
        }
        if (serviceType === 'Legalização Automóvel') document.getElementById('detailsLegalizacao').style.display = 'block';
        if (serviceType === 'Consultoria Financeira') document.getElementById('detailsConsultoria').style.display = 'block';
    }

    function calculateComissaoPagar() {
        const valorFinanciado = parseFloat(document.getElementById('creditoValorFinanciado').value) || 0;
        const comissaoPercent = parseFloat(document.getElementById('creditoComissaoPercent').value) || 0;
        const comissaoPagar = valorFinanciado * (comissaoPercent / 100);
        document.getElementById('creditoComissaoPagar').value = comissaoPagar.toLocaleString('pt-PT', { style: 'currency', currency: 'EUR' });
    }

    async function loadPartnersForDropdown(type, selectId) {
        const select = document.getElementById(selectId);
        if (!select) return;
        select.innerHTML = '<option value="">Selecione</option>';
        const snapshot = await db.collection(type).orderBy('name').get();
        snapshot.forEach(doc => {
            select.innerHTML += `<option value="${doc.id}">${doc.data().name}</option>`;
        });
    }

    async function handleContractFormSubmit(id) { 
        const clientSelect = document.getElementById('contractClient'); 
        const commercialSelect = document.getElementById('contractCommercial'); 
        const contractType = document.getElementById('contractType').value;

        // Base Data
        let data = { 
            clientId: clientSelect.value, 
            clientName: clientSelect.options[clientSelect.selectedIndex]?.text || '', 
            commercialId: commercialSelect.value, 
            commercialName: commercialSelect.options[commercialSelect.selectedIndex]?.text || '', 
            type: contractType, 
            fase: document.getElementById('contractFase').value,
            startDate: document.getElementById('contractDate').value, 
            commissionStatus: 'Não Paga' 
        }; 
        
        // Service-Specific Data
        switch(contractType) {
            case 'Crédito':
                const checklist = Array.from(document.querySelectorAll('input[name="creditoChecklist"]:checked')).map(cb => cb.value);
                const comissaoPagarValue = parseFloat(document.getElementById('creditoComissaoPagar').value.replace(/[^0-9,-]+/g,"").replace(",", ".")) || 0;
                Object.assign(data, {
                    numeroProposta: document.getElementById('creditoProposta').value,
                    fornecedorId: document.getElementById('creditoFornecedor').value,
                    financeiraId: document.getElementById('creditoFinanceira').value,
                    tipoCredito: document.getElementById('creditoTipo').value,
                    matricula: document.getElementById('creditoMatricula').value,
                    valorFinanciado: document.getElementById('creditoValorFinanciado').value,
                    comissaoPercent: document.getElementById('creditoComissaoPercent').value,
                    comissaoPagar: comissaoPagarValue,
                    comissaoRecebida: document.getElementById('creditoComissaoRecebida').value,
                    dataEntregaFornecedor: document.getElementById('creditoDataFornecedor').value,
                    dataEntregaFinanceira: document.getElementById('creditoDataFinanceira').value,
                    docsEmFalta: document.getElementById('creditoDocsFalta').value,
                    checklistDocs: checklist,
                    checklistDocsFornecedor: [], // Inicializar checklists para o dashboard
                    checklistDocsFinanceira: [],
                    creditoRealizado: document.getElementById('creditoRealizado').checked,
                });
                break;
            case 'Seguro':
                 Object.assign(data, {
                    tipoSeguro: document.getElementById('seguroTipo').value,
                    seguradoraId: document.getElementById('seguroSeguradora').value,
                    apolice: document.getElementById('seguroApolice').value,
                    matricula: document.getElementById('seguroMatricula').value,
                    dataSubscricao: document.getElementById('seguroDataSubscricao').value,
                    comissaoRecebida: document.getElementById('seguroComissao').value,
                    renovacaoAuto: document.getElementById('seguroRenovacao').checked,
                    isFreelancer: document.getElementById('seguroIsFreelancer').checked,
                    freelancerName: document.getElementById('seguroFreelancerName').value,
                 });
                break;
            case 'Legalização Automóvel':
                 Object.assign(data, {
                    chassis: document.getElementById('legalizacaoChassis').value,
                    matriculaEstrangeira: document.getElementById('legalizacaoMatricula').value,
                    paisImportacao: document.getElementById('legalizacaoPais').value,
                    dataConclusaoEstimada: document.getElementById('legalizacaoDataConclusao').value,
                 });
                break;
            case 'Consultoria Financeira':
                 Object.assign(data, {
                    diagnosticoFeito: document.getElementById('consultoriaDiagnostico').value,
                    situacaoAtual: document.getElementById('consultoriaSituacao').value,
                    dataSessao: document.getElementById('consultoriaDataSessao').value,
                    acoesImplementar: document.getElementById('consultoriaAcoes').value,
                 });
                break;
        }

        const docRef = id ? db.collection('contratos').doc(id) : db.collection('contratos').doc();
        const action = id ? docRef.update(data) : docRef.set(data);
        await action;
        const contractId = docRef.id;

        // CRIAR TAREFA AUTOMÁTICA PARA DOCUMENTOS EM FALTA
        if (contractType === 'Crédito' && document.getElementById('creditoDocsFaltaCheck').checked) {
            const docsFaltaTexto = document.getElementById('creditoDocsFalta').value.trim();
            if (docsFaltaTexto) {
                await db.collection('tarefas').add({
                    title: `Documentos em falta: ${data.clientName}`,
                    description: docsFaltaTexto,
                    owner: data.commercialName, // Atribui ao comercial do contrato
                    dueDate: '',
                    priority: 'Alta',
                    status: 'Pendente',
                    clientId: data.clientId,
                    contractId: contractId,
                    autoTaskType: 'documentos_em_falta' // Flag para identificar a tarefa
                });
            }
        }
        
        closeFormModal(); 
        loadContracts(); 
        loadDashboardData(); 
        loadFinanceiraModule(); 
        loadRelatoriosData(); 
    }

    async function populateContractForm(id) { 
        const doc = await db.collection('contratos').doc(id).get(); 
        if (doc.exists) { 
            const d = doc.data(); 
            document.getElementById('contractClient').value = d.clientId || ''; 
            document.getElementById('contractCommercial').value = d.commercialId || ''; 
            document.getElementById('contractType').value = d.type || ''; 
            document.getElementById('contractFase').value = d.fase || 'Proposta'; 
            document.getElementById('contractDate').value = d.startDate || ''; 

            await handleContractTypeChange(d.type); // Mostra a secção correta

            // Popula os campos específicos
            switch(d.type) {
                case 'Crédito':
                    document.getElementById('creditoProposta').value = d.numeroProposta || '';
                    document.getElementById('creditoFornecedor').value = d.fornecedorId || '';
                    document.getElementById('creditoFinanceira').value = d.financeiraId || '';
                    document.getElementById('creditoTipo').value = d.tipoCredito || '';
                    document.getElementById('creditoMatricula').value = d.matricula || '';
                    document.getElementById('creditoValorFinanciado').value = d.valorFinanciado || '';
                    document.getElementById('creditoComissaoPercent').value = d.comissaoPercent || '';
                    document.getElementById('creditoComissaoRecebida').value = d.comissaoRecebida || '';
                    document.getElementById('creditoDataFornecedor').value = d.dataEntregaFornecedor || '';
                    document.getElementById('creditoDataFinanceira').value = d.dataEntregaFinanceira || '';
                    if(d.docsEmFalta) {
                        document.getElementById('creditoDocsFaltaCheck').checked = true;
                        document.getElementById('creditoDocsFaltaContainer').style.display = 'block';
                        document.getElementById('creditoDocsFalta').value = d.docsEmFalta;
                    }
                    (d.checklistDocs || []).forEach(docName => {
                        const checkbox = document.querySelector(`input[name="creditoChecklist"][value="${docName}"]`);
                        if (checkbox) checkbox.checked = true;
                    });
                    document.getElementById('creditoRealizado').checked = d.creditoRealizado || false;
                    calculateComissaoPagar();
                    break;
                case 'Seguro':
                    document.getElementById('seguroTipo').value = d.tipoSeguro || '';
                    document.getElementById('seguroSeguradora').value = d.seguradoraId || '';
                    document.getElementById('seguroApolice').value = d.apolice || '';
                    document.getElementById('seguroMatricula').value = d.matricula || '';
                    document.getElementById('seguroDataSubscricao').value = d.dataSubscricao || '';
                    document.getElementById('seguroComissao').value = d.comissaoRecebida || '';
                    document.getElementById('seguroRenovacao').checked = d.renovacaoAuto || false;
                    if (d.isFreelancer) {
                        document.getElementById('seguroIsFreelancer').checked = true;
                        document.getElementById('seguroFreelancerContainer').style.display = 'block';
                        document.getElementById('seguroFreelancerName').value = d.freelancerName || '';
                    }
                    break;
                case 'Legalização Automóvel':
                    document.getElementById('legalizacaoChassis').value = d.chassis || '';
                    document.getElementById('legalizacaoMatricula').value = d.matriculaEstrangeira || '';
                    document.getElementById('legalizacaoPais').value = d.paisImportacao || '';
                    document.getElementById('legalizacaoDataConclusao').value = d.dataConclusaoEstimada || '';
                    break;
                case 'Consultoria Financeira':
                    document.getElementById('consultoriaDiagnostico').value = d.diagnosticoFeito || 'Não';
                    document.getElementById('consultoriaSituacao').value = d.situacaoAtual || '';
                    document.getElementById('consultoriaDataSessao').value = d.dataSessao || '';
                    document.getElementById('consultoriaAcoes').value = d.acoesImplementar || '';
                    break;
            }
        } 
    }
    
    async function loadContractDropdowns(callback) { await loadClientsForDropdown('contractClient'); await loadComerciaisForDropdown('contractCommercial'); if (callback) callback(); }
    async function loadAssociatedContracts(clientId) { const container = document.getElementById('associatedContracts'); container.innerHTML = ''; const snapshot = await db.collection('contratos').where('clientId', '==', clientId).get(); if (snapshot.empty) { container.innerHTML = '<p>Nenhum contrato associado.</p>'; return; } let html = '<ul style="list-style: none; padding: 0;">'; snapshot.forEach(doc => { const d = doc.data(); html += `<li style="margin-bottom: .5em;">${d.type} - Fase: ${d.fase} (Início: ${d.startDate})</li>`; }); html += '</ul>'; container.innerHTML = html; }
    function getTaskFormHTML() { return `<form id="taskForm"><label>Título da tarefa</label><input type="text" id="taskTitle" required /><label>Descrição</label><textarea id="taskDescription" rows="3"></textarea><div class="row"><div class="col"><label>Responsável</label><input type="text" id="taskOwner" /></div><div class="col"><label>Prazo</label><input type="date" id="taskDueDate" /></div></div><div class="row"><div class="col"><label>Prioridade</label><select id="taskPriority"><option value="Baixa">Baixa</option><option value="Média" selected>Média</option><option value="Alta">Alta</option></select></div><div class="col"><label>Estado</label><select id="taskStatus"><option value="Pendente">Pendente</option><option value="Em Andamento">Em Andamento</option><option value="Concluído">Concluído</option></select></div></div><div class="row"><div class="col"><label>Associar a Cliente (Opcional)</label><select id="taskClient"><option value="">Nenhum</option></select></div><div class="col"><label>Associar a Contrato (Opcional)</label><select id="taskContract"><option value="">Nenhum</option></select></div></div><div class="modal-footer"><button type="button" class="btn-secondary" onclick="closeFormModal()">Cancelar</button><button type="submit" class="btn-primary">Guardar</button></div></form>`; }
    async function handleTaskFormSubmit(id) { const data = { title: document.getElementById('taskTitle').value.trim(), description: document.getElementById('taskDescription').value.trim(), owner: document.getElementById('taskOwner').value.trim(), dueDate: document.getElementById('taskDueDate').value, priority: document.getElementById('taskPriority').value, status: document.getElementById('taskStatus').value, clientId: document.getElementById('taskClient').value, contractId: document.getElementById('taskContract').value, }; const action = id ? db.collection('tarefas').doc(id).update(data) : db.collection('tarefas').add(data); await action; const note = `Tarefa '${data.title}' foi ${id ? 'atualizada' : 'criada'} com estado '${data.status}'.`; if (data.clientId) { handleInteractionSubmit('clientes', data.clientId, note); } if (data.contractId) { handleInteractionSubmit('contratos', data.contractId, note); } closeFormModal(); loadTasks(); loadDashboardData(); }
    async function populateTaskForm(id) { const doc = await db.collection('tarefas').doc(id).get(); if (doc.exists) { const d = doc.data(); document.getElementById('taskTitle').value = d.title || ''; document.getElementById('taskDescription').value = d.description || ''; document.getElementById('taskOwner').value = d.owner || ''; document.getElementById('taskDueDate').value = d.dueDate || ''; document.getElementById('taskPriority').value = d.priority || 'Média'; document.getElementById('taskStatus').value = d.status || 'Pendente'; document.getElementById('taskClient').value = d.clientId || ''; document.getElementById('taskContract').value = d.contractId || ''; } }
    async function loadDropdownsForTaskForm(callback) { await loadClientsForDropdown('taskClient'); await loadContractsForDropdown('taskContract'); if(callback) callback(); }
    async function loadClientsForDropdown(selectId) { const select = document.getElementById(selectId); if (!select) return; select.innerHTML = '<option value="">Selecione</option>'; const snapshot = await db.collection('clientes').orderBy('name').get(); snapshot.forEach(doc => { select.innerHTML += `<option value="${doc.id}">${doc.data().name}</option>`; }); }
    async function loadContractsForDropdown(selectId) { const select = document.getElementById(selectId); if (!select) return; select.innerHTML = '<option value="">Selecione</option>'; const snapshot = await db.collection('contratos').orderBy('clientName').get(); snapshot.forEach(doc => { const d = doc.data(); select.innerHTML += `<option value="${doc.id}">${d.type} - ${d.clientName}</option>`; }); }
    function handleFileSelect(files) { const list = document.getElementById('documentList'); if (!list || files.length === 0) return; const file = files[0]; list.innerHTML += `<li><span>${file.name}</span><button class="btn-danger" style="padding: .2em .5em; font-size: .8em;">X</button></li>`; /* Lógica de upload real iria aqui */ }
    function deleteItem(collection, id, name, callback) { showConfirmModal(`Tem a certeza que quer eliminar "${name}"?`, async () => { await db.collection(collection).doc(id).delete(); callback(); loadDashboardData(); }); }
    function getFornecedorFormHTML() { return `<form id="partnerForm"><div class="row"><div class="col"><label>Nome</label><input id="partnerName" required></div><div class="col"><label>NIF</label><input id="partnerNif"></div><div class="col"><label>IBAN</label><input id="partnerIban"></div></div><div class="row"><div class="col"><label>Morada</label><input id="partnerAddress"></div><div class="col"><label>Código Postal</label><input id="partnerPostalCode"></div><div class="col"><label>Localidade</label><input id="partnerCity"></div></div><div class="row"><div class="col"><label>Telefone</label><input id="partnerPhone"></div><div class="col"><label>Email</label><input id="partnerEmail" type="email"></div><div class="col"><label>CAE</label><input id="partnerCae"></div></div><div class="row"><div class="col"><label>Capital Social</label><input id="partnerCapital" type="number"></div><div class="col"><label>Pessoa a Contactar</label><input id="partnerContactPerson"></div><div class="col"><label>Equipamento</label><select id="partnerEquipment"><option>AUTO</option></select></div></div><div class="modal-footer"><button type="button" class="btn-secondary" onclick="closeFormModal()">Cancelar</button><button type="submit" class="btn-primary">Guardar</button></div></form>`; }
    function getFinanceiraFormHTML() { return `<form id="partnerForm"><div class="row"><div class="col"><label>Nome da Financeira</label><input id="partnerName" required></div><div class="col"><label>Morada</label><input id="partnerAddress"></div></div><div class="row"><div class="col"><label>NIF</label><input id="partnerNif"></div><div class="col"><label>Nome do Comercial</label><input id="partnerCommercialName"></div></div><div class="row"><div class="col"><label>Data Nascimento Comercial</label><input id="partnerCommercialDob" type="date"></div><div class="col"><label>Contacto Comercial</label><input id="partnerCommercialContact"></div></div><div class="row"><div class="col"><label>Email Comercial</label><input id="partnerCommercialEmail" type="email"></div><div class="col"><label>Email Comissões</label><input id="partnerCommissionEmail" type="email"></div></div><div class="modal-footer"><button type="button" class="btn-secondary" onclick="closeFormModal()">Cancelar</button><button type="submit" class="btn-primary">Guardar</button></div></form>`; }
    function getSeguradoraFormHTML() { return `<form id="partnerForm"><div class="row"><div class="col"><label>Nome da Seguradora</label><input id="partnerName" required></div><div class="col"><label>Morada</label><input id="partnerAddress"></div></div><div class="row"><div class="col"><label>NIF</label><input id="partnerNif"></div><div class="col"><label>Nome do Comercial</label><input id="partnerCommercialName"></div></div><div class="row"><div class="col"><label>Data Nascimento Comercial</label><input id="partnerCommercialDob" type="date"></div><div class="col"><label>Contacto Comercial</label><input id="partnerCommercialContact"></div><div class="col"><label>Email Comercial</label><input id="partnerCommercialEmail" type="email"></div></div><div class="modal-footer"><button type="button" class="btn-secondary" onclick="closeFormModal()">Cancelar</button><button type="submit" class="btn-primary">Guardar</button></div></form>`; }
    async function handleInteractionSubmit(collection, docId, note, elementId) { if (!note.trim()) return; await db.collection(collection).doc(docId).collection('interactions').add({ note: note, timestamp: firebase.firestore.FieldValue.serverTimestamp() }); if(elementId) { loadInteractions(collection, docId, elementId); } }
    async function loadInteractions(collection, docId, elementId) { const container = document.getElementById(elementId); container.innerHTML = ''; const snapshot = await db.collection(collection).doc(docId).collection('interactions').orderBy('timestamp', 'desc').get(); if (snapshot.empty) { container.innerHTML = '<p>Nenhuma interação registada.</p>'; return; } snapshot.forEach(doc => { const d = doc.data(); const date = d.timestamp ? d.timestamp.toDate().toLocaleString('pt-PT') : 'Data inválida'; const item = document.createElement('div'); item.className = 'interaction-item'; item.innerHTML = `<div class="date">${date}</div><div>${d.note}</div>`; container.appendChild(item); }); }
    
    async function loadClients() {
        const tableBody = document.getElementById('clientTable').querySelector('tbody');
        tableBody.innerHTML = '';
        
        let query = db.collection('clientes');
        // APLICAR PERMISSÃO: Comercial só vê os seus clientes
        if (currentUserData && currentUserData.role === 'Comercial') {
            query = query.where('managerId', '==', currentUserData.id);
        }
        
        const snapshot = await query.orderBy('name').get();
        snapshot.forEach(doc => {
            const d = doc.data();
            const row = tableBody.insertRow();
            row.innerHTML = `
                <td>${doc.id.substring(0, 6)}...</td>
                <td>${d.name || '-'}</td>
                <td>${d.nif || '-'}</td>
                <td>${d.clientType || 'Particular'}</td>
                <td>${d.managerName || '-'}</td>
                <td>${d.rgpd || '-'}</td>
                <td class="actions-cell">
                    <button onclick="openDetailsModal('cliente', '${doc.id}')" title="Ver Detalhes"><i class="ph ph-eye"></i></button>
                    <button onclick="openFormModal('cliente', '${doc.id}')" title="Editar"><i class="ph ph-pencil-simple"></i></button>
                    <button class="btn-danger" onclick="deleteItem('clientes', '${doc.id}', '${d.name}', loadClients)" title="Eliminar"><i class="ph ph-trash"></i></button>
                </td>
            `;
        });
    }
    async function loadContracts() {
        const tableBody = document.getElementById('contractTable').querySelector('tbody');
        tableBody.innerHTML = '';

        let query = db.collection('contratos');
        // APLICAR PERMISSÃO: Comercial só vê os seus contratos
        if (currentUserData && currentUserData.role === 'Comercial') {
            query = query.where('commercialId', '==', currentUserData.id);
        }

        const snapshot = await query.orderBy('startDate', 'desc').get();
        snapshot.forEach(doc => {
            const d = doc.data();
            const row = tableBody.insertRow();
            row.innerHTML = `
                <td>${d.clientName || '-'}</td>
                <td>${d.type || '-'}</td>
                <td>€${parseFloat(d.valorFinanciado || d.value || 0).toLocaleString('pt-PT')}</td>
                <td>${d.fase || '-'}</td>
                <td>${d.startDate || '-'}</td>
                <td>${d.commercialName || '-'}</td>
                <td class="actions-cell">
                    <button onclick="openDetailsModal('contrato', '${doc.id}')" title="Ver Detalhes"><i class="ph ph-eye"></i></button>
                    <button onclick="openFormModal('contrato', '${doc.id}')" title="Editar"><i class="ph ph-pencil-simple"></i></button>
                    <button class="btn-danger" onclick="deleteItem('contratos', '${doc.id}', 'este contrato', loadContracts)" title="Eliminar"><i class="ph ph-trash"></i></button>
                </td>
            `;
        });
    }
    function getComercialFormHTML() { return `<form id="comercialForm"><div class="row"><div class="col"><label>Primeiro Nome</label><input id="comercialFirstName" required></div><div class="col"><label>Último Nome</label><input id="comercialLastName" required></div></div><div class="row"><div class="col"><label>Email</label><input id="comercialEmail" type="email" required></div><div class="col"><label>Função</label><select id="comercialRole"><option value="Comercial">Comercial</option><option value="Gestor de Equipa">Gestor de Equipa</option><option value="Administrador">Administrador</option></select></div></div><div class="row"><div class="col"><label>Telefone</label><input id="comercialPhone"></div><div class="col"><label>NIF</label><input id="comercialNif"></div></div><div class="row"><div class="col"><label>IBAN</label><input id="comercialIban"></div></div><div class="row"><div class="col"><label>Data de Início</label><input id="comercialStartDate" type="date"></div><div class="col"><label>Estado</label><select id="comercialStatus"><option value="Ativo">Ativo</option><option value="Inativo">Inativo</option></select></div></div><div class="modal-footer"><button type="button" class="btn-secondary" onclick="closeFormModal()">Cancelar</button><button type="submit" class="btn-primary">Guardar</button></div></form>`;}
    async function handleComercialFormSubmit(id) { 
        // Idealmente, aqui também se criaria/atualizaria o utilizador no Firebase Auth.
        // Por simplicidade, estamos a gerir apenas no Firestore.
        const data = { 
            firstName: document.getElementById('comercialFirstName').value, 
            lastName: document.getElementById('comercialLastName').value, 
            email: document.getElementById('comercialEmail').value, 
            role: document.getElementById('comercialRole').value, 
            phone: document.getElementById('comercialPhone').value, 
            nif: document.getElementById('comercialNif').value, 
            iban: document.getElementById('comercialIban').value, 
            startDate: document.getElementById('comercialStartDate').value, 
            status: document.getElementById('comercialStatus').value, 
        }; 
        const action = id ? db.collection('comerciais').doc(id).update(data) : db.collection('comerciais').add(data); 
        await action; 
        closeFormModal(); 
        loadComerciais();
    }
    async function populateComercialForm(id) { const doc = await db.collection('comerciais').doc(id).get(); if (doc.exists) { const d = doc.data(); document.getElementById('comercialFirstName').value = d.firstName || ''; document.getElementById('comercialLastName').value = d.lastName || ''; document.getElementById('comercialEmail').value = d.email || ''; document.getElementById('comercialRole').value = d.role || 'Comercial'; document.getElementById('comercialPhone').value = d.phone || ''; document.getElementById('comercialNif').value = d.nif || ''; document.getElementById('comercialIban').value = d.iban || ''; document.getElementById('comercialStartDate').value = d.startDate || ''; document.getElementById('comercialStatus').value = d.status || 'Ativo'; } }
    async function loadComerciais() {
        if (!currentUserData || currentUserData.role !== 'Administrador') return; // Apenas Admins podem ver
        const tableBody = document.getElementById('comerciaisTable').querySelector('tbody');
        tableBody.innerHTML = '';
        const snapshot = await db.collection('comerciais').orderBy('firstName').get();
        snapshot.forEach(doc => {
            const d = doc.data();
            const row = tableBody.insertRow();
            row.innerHTML = `
                <td>${d.firstName} ${d.lastName}</td>
                <td>${d.email || '-'}</td>
                <td>${d.phone || '-'}</td>
                <td>${d.role || 'N/D'}</td>
                <td><span style="color: ${d.status === 'Ativo' ? 'var(--color-success)' : 'var(--color-danger)'}">${d.status}</span></td>
                <td class="actions-cell">
                    <button onclick="toggleComercialStatus('${doc.id}', '${d.status}')" title="${d.status === 'Ativo' ? 'Desativar' : 'Ativar'}"><i class="ph ph-power"></i></button>
                    <button onclick="openFormModal('comercial', '${doc.id}')" title="Editar"><i class="ph ph-pencil-simple"></i></button>
                </td>
            `;
        });
    }
    async function toggleComercialStatus(id, currentStatus) {
        const newStatus = currentStatus === 'Ativo' ? 'Inativo' : 'Ativo';
        await db.collection('comerciais').doc(id).update({ status: newStatus });
        loadComerciais();
    }
    async function loadComerciaisForDropdown(selectId) {
        const select = document.getElementById(selectId);
        if (!select) return;
        select.innerHTML = '<option value="">Selecione</option>';
        const snapshot = await db.collection('comerciais').where('status', '==', 'Ativo').get();
        
        let comerciais = [];
        snapshot.forEach(doc => {
            comerciais.push({ id: doc.id, ...doc.data() });
        });

        // Ordenar por nome no lado do cliente
        comerciais.sort((a, b) => a.firstName.localeCompare(b.firstName));

        comerciais.forEach(d => {
            select.innerHTML += `<option value="${d.id}">${d.firstName} ${d.lastName}</option>`;
        });
    }

    // --- GESTÃO FINANCEIRA ---
    function openFinanceTab(evt, tabName) {
        document.querySelectorAll('#financeira-section .tab-content').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('#financeira-section .tabs button').forEach(btn => btn.classList.remove('active'));
        document.getElementById(tabName).classList.add('active');
        evt.currentTarget.classList.add('active');

        // Carregar dados do separador ativo
        if(tabName === 'financeira-dashboard') loadFinanceiraDashboard();
        if(tabName === 'financeira-despesas') loadDespesas();
        if(tabName === 'financeira-por-conciliar') loadPorConciliar();
        if(tabName === 'financeira-banco') loadBancos();
    }

    function loadFinanceiraModule() {
        // Por defeito, carrega o primeiro separador (Dashboard)
        loadFinanceiraDashboard();
        // Ativa o primeiro separador visualmente
        const financeTabs = document.querySelector('#finance-tabs');
        if (financeTabs) {
            financeTabs.querySelector('button').classList.add('active');
            document.getElementById('financeira-dashboard').classList.add('active');
        }
    }
    
    async function loadFinanceiraDashboard() {
        const contratosSnapshot = await db.collection('contratos').where('fase', '==', 'Ativo').get();
        const despesasSnapshot = await db.collection('despesas').get();
        
        let totalReceber = 0;
        let totalPagar = 0;
        let aReceberFinanceira = {};
        let aPagarFornecedor = {};
        const today = new Date();
        const currentMonth = today.getMonth();
        const currentYear = today.getFullYear();

        contratosSnapshot.forEach(doc => {
            const d = doc.data();
            if(d.type === 'Crédito') {
                totalReceber += parseFloat(d.comissaoRecebida || 0);
                totalPagar += parseFloat(d.comissaoPagar || 0);

                const contractDate = new Date(d.startDate);
                if (contractDate.getMonth() === currentMonth && contractDate.getFullYear() === currentYear) {
                    if(d.financeiraId) {
                        aReceberFinanceira[d.financeiraId] = (aReceberFinanceira[d.financeiraId] || 0) + parseFloat(d.comissaoRecebida || 0);
                    }
                    if(d.fornecedorId) {
                        aPagarFornecedor[d.fornecedorId] = (aPagarFornecedor[d.fornecedorId] || 0) + parseFloat(d.comissaoPagar || 0);
                    }
                }
            } else if (d.type === 'Seguro') {
                totalReceber += parseFloat(d.comissaoRecebida || 0);
            }
        });

        document.getElementById('kpi-comissoes-receber').textContent = `€${totalReceber.toLocaleString('pt-PT', {minimumFractionDigits: 2})}`;
        document.getElementById('kpi-comissoes-pagar').textContent = `€${(totalPagar * 1.23).toLocaleString('pt-PT', {minimumFractionDigits: 2})}`;
        
        let totalDespesas = 0;
        despesasSnapshot.forEach(doc => {
            totalDespesas += parseFloat(doc.data().value || 0);
        });
        document.getElementById('kpi-total-despesas').textContent = `€${totalDespesas.toLocaleString('pt-PT', {minimumFractionDigits: 2})}`;

        // Preencher tabelas
        const tableReceberBody = document.getElementById('financeirasReceberTable').querySelector('tbody');
        tableReceberBody.innerHTML = '';
        for(const id in aReceberFinanceira) {
            const name = partnersData.financeiras[id] || 'Desconhecida';
            tableReceberBody.innerHTML += `<tr><td>${name}</td><td>€${aReceberFinanceira[id].toLocaleString('pt-PT')}</td></tr>`;
        }
        if (tableReceberBody.innerHTML === '') tableReceberBody.innerHTML = '<tr><td colspan="2">Nenhum valor a receber este mês.</td></tr>';

        const tablePagarBody = document.getElementById('fornecedoresPagarTable').querySelector('tbody');
        tablePagarBody.innerHTML = '';
        for(const id in aPagarFornecedor) {
            const name = partnersData.fornecedores[id] || 'Desconhecido';
            tablePagarBody.innerHTML += `<tr><td>${name}</td><td>€${aPagarFornecedor[id].toLocaleString('pt-PT')}</td></tr>`;
        }
        if (tablePagarBody.innerHTML === '') tablePagarBody.innerHTML = '<tr><td colspan="2">Nenhum valor a pagar este mês.</td></tr>';
    }

    async function loadDespesas() {
        const tableBody = document.getElementById('despesasTable').querySelector('tbody');
        tableBody.innerHTML = '';
        const snapshot = await db.collection('despesas').orderBy('date', 'desc').get();
        snapshot.forEach(doc => {
            const d = doc.data();
            const row = tableBody.insertRow();
            row.innerHTML = `
                <td>${d.date}</td>
                <td>${d.description}</td>
                <td>${d.type}</td>
                <td>${d.bancoName || '-'}</td>
                <td>€${parseFloat(d.value || 0).toLocaleString('pt-PT')}</td>
                <td><input type="checkbox" ${d.isConciliada ? 'checked' : ''} disabled></td>
                <td class="actions-cell">
                    <button onclick="openFormModal('despesa', '${doc.id}')" title="Editar"><i class="ph ph-pencil-simple"></i></button>
                    <button class="btn-danger" onclick="deleteItem('despesas', '${doc.id}', 'esta despesa', loadDespesas)" title="Eliminar"><i class="ph ph-trash"></i></button>
                </td>
            `;
        });
    }
    
    function getDespesaFormHTML() {
        return `<form id="despesaForm">
            <div class="row">
                <div class="col"><label>Data</label><input type="date" id="despesaDate" required></div>
                <div class="col"><label>Valor</label><input type="number" id="despesaValue" step="0.01" required></div>
            </div>
            <label>Descrição</label><input type="text" id="despesaDescription" required>
            <div class="row">
                <div class="col"><label>Tipo de Despesa</label>
                    <select id="despesaType" required>
                        <option value="Renda">Renda</option>
                        <option value="Comunicações">Comunicações</option>
                        <option value="Material de Escritório">Material de Escritório</option>
                        <option value="Transporte">Transporte</option>
                        <option value="Outro">Outro</option>
                    </select>
                </div>
                <div class="col"><label>Banco</label><select id="despesaBanco"></select></div>
            </div>
            <label><input type="checkbox" id="despesaIsConciliada"> Marcar como já conciliada</label>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeFormModal()">Cancelar</button>
                <button type="submit" class="btn-primary">Guardar</button>
            </div>
        </form>`;
    }

    async function handleDespesaFormSubmit(id) {
        const bancoSelect = document.getElementById('despesaBanco');
        const data = {
            date: document.getElementById('despesaDate').value,
            value: document.getElementById('despesaValue').value,
            description: document.getElementById('despesaDescription').value,
            type: document.getElementById('despesaType').value,
            isConciliada: document.getElementById('despesaIsConciliada').checked,
            bancoId: bancoSelect.value,
            bancoName: bancoSelect.options[bancoSelect.selectedIndex]?.text || '',
        };
        const action = id ? db.collection('despesas').doc(id).update(data) : db.collection('despesas').add(data);
        await action;
        closeFormModal();
        loadDespesas();
        loadPorConciliar();
        loadFinanceiraDashboard();
    }

    async function populateDespesaForm(id) {
        await loadBancosForDropdown('despesaBanco');
        const doc = await db.collection('despesas').doc(id).get();
        if (doc.exists) {
            const d = doc.data();
            document.getElementById('despesaDate').value = d.date;
            document.getElementById('despesaValue').value = d.value;
            document.getElementById('despesaDescription').value = d.description;
            document.getElementById('despesaType').value = d.type;
            document.getElementById('despesaBanco').value = d.bancoId || '';
            document.getElementById('despesaIsConciliada').checked = d.isConciliada;
        }
    }

    async function loadPorConciliar() {
        const tableBody = document.getElementById('porConciliarTable').querySelector('tbody');
        tableBody.innerHTML = '';
        const snapshot = await db.collection('despesas').where('isConciliada', '==', false).get();
        
        if(snapshot.empty) {
            tableBody.innerHTML = '<tr><td colspan="5">Nenhuma despesa por conciliar.</td></tr>';
            return;
        }

        let despesas = [];
        snapshot.forEach(doc => {
            despesas.push({ id: doc.id, ...doc.data() });
        });

        despesas.sort((a, b) => new Date(b.date) - new Date(a.date));

        tableBody.innerHTML = '';
        despesas.forEach(d => {
            const row = tableBody.insertRow();
            row.innerHTML = `
                <td><input type="checkbox" class="conciliar-check" value="${d.id}"></td>
                <td>${d.date}</td>
                <td>${d.description}</td>
                <td>${d.type}</td>
                <td>€${parseFloat(d.value || 0).toLocaleString('pt-PT')}</td>
            `;
        });
    }
    
    function toggleAllConciliar(checked) {
        document.querySelectorAll('.conciliar-check').forEach(cb => cb.checked = checked);
    }
    
    const conciliarModal = document.getElementById('conciliarModal');
    async function openConciliarModal() {
        const selectedIds = Array.from(document.querySelectorAll('.conciliar-check:checked')).map(cb => cb.value);
        if (selectedIds.length === 0) {
            alert('Por favor, selecione pelo menos uma despesa para conciliar.');
            return;
        }
        document.getElementById('conciliarCount').textContent = selectedIds.length;
        await loadBancosForDropdown('conciliarBanco');
        document.getElementById('conciliarDate').value = new Date().toISOString().split('T')[0];
        conciliarModal.classList.add('active');
    }
    function closeConciliarModal() { conciliarModal.classList.remove('active'); }

    async function conciliarDespesasEmMassa() {
        const selectedIds = Array.from(document.querySelectorAll('.conciliar-check:checked')).map(cb => cb.value);
        const conciliarDate = document.getElementById('conciliarDate').value;
        const bancoSelect = document.getElementById('conciliarBanco');
        const bancoId = bancoSelect.value;
        const bancoName = bancoSelect.options[bancoSelect.selectedIndex]?.text || '';

        if (!conciliarDate || !bancoId) {
            alert('Por favor, preencha a data e o banco.');
            return;
        }

        const batch = db.batch();
        selectedIds.forEach(id => {
            const docRef = db.collection('despesas').doc(id);
            batch.update(docRef, { 
                isConciliada: true,
                dataConciliacao: conciliarDate,
                bancoId: bancoId,
                bancoName: bancoName
            });
        });
        await batch.commit();
        
        closeConciliarModal();
        loadPorConciliar();
        loadDespesas();
    }
    
    function exportarLancamento() {
        const selectedRows = Array.from(document.querySelectorAll('.conciliar-check:checked')).map(cb => cb.closest('tr'));
        if (selectedRows.length === 0) {
            alert('Por favor, selecione despesas para exportar.');
            return;
        }
        let total = 0;
        let content = `<h1>Folha de Lançamento</h1><p>Data: ${new Date().toLocaleDateString('pt-PT')}</p><table border="1" style="width:100%; border-collapse: collapse;"><thead><tr><th>Data</th><th>Descrição</th><th>Tipo</th><th>Valor</th></tr></thead><tbody>`;
        selectedRows.forEach(row => {
            const cells = row.cells;
            const value = parseFloat(cells[4].textContent.replace('€', '').replace('.', '').replace(',', '.'));
            total += value;
            content += `<tr><td>${cells[1].textContent}</td><td>${cells[2].textContent}</td><td>${cells[3].textContent}</td><td>${cells[4].textContent}</td></tr>`;
        });
        content += `</tbody><tfoot><tr><td colspan="3" style="text-align:right;"><strong>Total</strong></td><td><strong>€${total.toLocaleString('pt-PT', {minimumFractionDigits: 2})}</strong></td></tr></tfoot></table>`;
        
        const win = window.open('', 'Print', 'height=600,width=800');
        win.document.write('<html><head><title>Folha de Lançamento</title></head><body>');
        win.document.write(content);
        win.document.write('</body></html>');
        win.document.close();
        win.print();
    }

    async function loadBancos() {
        const tableBody = document.getElementById('bancosTable').querySelector('tbody');
        tableBody.innerHTML = '';
        const snapshot = await db.collection('bancos').orderBy('name').get();
        snapshot.forEach(doc => {
            const d = doc.data();
            const row = tableBody.insertRow();
            row.innerHTML = `
                <td>${d.name}</td>
                <td>${d.iban || '-'}</td>
                <td>€${parseFloat(d.balance || 0).toLocaleString('pt-PT')}</td>
                <td class="actions-cell">
                    <button onclick="openFormModal('banco', '${doc.id}')" title="Editar"><i class="ph ph-pencil-simple"></i></button>
                    <button class="btn-danger" onclick="deleteItem('bancos', '${doc.id}', d.name, loadBancos)" title="Eliminar"><i class="ph ph-trash"></i></button>
                </td>
            `;
        });
    }
    
    async function loadBancosForDropdown(selectId) {
        const select = document.getElementById(selectId);
        if (!select) return;
        select.innerHTML = '<option value="">Selecione um banco</option>';
        const snapshot = await db.collection('bancos').orderBy('name').get();
        snapshot.forEach(doc => {
            select.innerHTML += `<option value="${doc.id}">${doc.data().name}</option>`;
        });
    }

    function getBancoFormHTML() {
        return `<form id="bancoForm">
            <label>Nome do Banco</label><input type="text" id="bancoName" required>
            <label>IBAN</label><input type="text" id="bancoIban">
            <label>Saldo Inicial</label><input type="number" id="bancoBalance" step="0.01" required>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeFormModal()">Cancelar</button>
                <button type="submit" class="btn-primary">Guardar</button>
            </div>
        </form>`;
    }

    async function handleBancoFormSubmit(id) {
        const data = {
            name: document.getElementById('bancoName').value,
            iban: document.getElementById('bancoIban').value,
            balance: document.getElementById('bancoBalance').value,
        };
        const action = id ? db.collection('bancos').doc(id).update(data) : db.collection('bancos').add(data);
        await action;
        closeFormModal();
        loadBancos();
    }

    async function populateBancoForm(id) {
        const doc = await db.collection('bancos').doc(id).get();
        if (doc.exists) {
            const d = doc.data();
            document.getElementById('bancoName').value = d.name;
            document.getElementById('bancoIban').value = d.iban;
            document.getElementById('bancoBalance').value = d.balance;
        }
    }

    // --- RELATÓRIOS ---
    let contractTypeChartInstance = null;
    async function loadRelatoriosData() {
        const performanceTableBody = document.getElementById('comercialPerformanceTable').querySelector('tbody');
        performanceTableBody.innerHTML = '<tr><td colspan="3">A calcular...</td></tr>';

        const comerciaisSnapshot = await db.collection('comerciais').get();
        const contratosSnapshot = await db.collection('contratos').where('fase', '==', 'Ativo').get();

        const performanceData = {};
        comerciaisSnapshot.forEach(doc => {
            performanceData[doc.id] = {
                name: `${doc.data().firstName} ${doc.data().lastName}`,
                contractCount: 0,
                totalValue: 0
            };
        });

        contratosSnapshot.forEach(doc => {
            const contrato = doc.data();
            if (contrato.commercialId && performanceData[contrato.commercialId]) {
                performanceData[contrato.commercialId].contractCount++;
                performanceData[contrato.commercialId].totalValue += parseFloat(contrato.valorFinanciado || 0);
            }
        });

        performanceTableBody.innerHTML = '';
        for (const id in performanceData) {
            const data = performanceData[id];
            const row = performanceTableBody.insertRow();
            row.innerHTML = `
                <td>${data.name}</td>
                <td>${data.contractCount}</td>
                <td>€${data.totalValue.toLocaleString('pt-PT')}</td>
            `;
        }

        const contractTypes = {};
        const allContratosSnapshot = await db.collection('contratos').get();
        allContratosSnapshot.forEach(doc => {
            const type = doc.data().type || 'Indefinido';
            contractTypes[type] = (contractTypes[type] || 0) + 1;
        });

        const ctx = document.getElementById('contractTypeChart').getContext('2d');
        if (contractTypeChartInstance) contractTypeChartInstance.destroy();
        contractTypeChartInstance = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: Object.keys(contractTypes),
                datasets: [{
                    data: Object.values(contractTypes),
                    backgroundColor: ['#c8b89c', '#6c757d', '#a99a8b', '#d1ccc0', '#8a959d'],
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top',
                    }
                }
            }
        });
    }

    // --- MILESTONES (ETAPAS DO CONTRATO) ---
    async function loadMilestones(contractId, containerId) {
        const container = document.getElementById(containerId);
        container.innerHTML = 'A carregar etapas...';
        const snapshot = await db.collection('contratos').doc(contractId).collection('milestones').orderBy('createdAt').get();
        
        if (snapshot.empty) {
            container.innerHTML = '<p>Nenhuma etapa definida.</p>';
            return;
        }

        container.innerHTML = '';
        snapshot.forEach(doc => {
            const d = doc.data();
            const item = document.createElement('div');
            item.className = `milestone-item ${d.completed ? 'completed' : ''}`;
            item.innerHTML = `
                <input type="checkbox" id="milestone-${doc.id}" ${d.completed ? 'checked' : ''} onchange="toggleMilestone('${contractId}', '${doc.id}', this.checked)">
                <label for="milestone-${doc.id}">${d.description}</label>
            `;
            container.appendChild(item);
        });
    }

    async function handleMilestoneSubmit(contractId) {
        const descInput = document.getElementById('newMilestoneDescription');
        const ownerInput = document.getElementById('newMilestoneOwner');
        const dueDateInput = document.getElementById('newMilestoneDueDate');
        
        const description = descInput.value.trim();
        if (!description) return;

        // 1. Criar a etapa (milestone)
        await db.collection('contratos').doc(contractId).collection('milestones').add({
            description: description,
            completed: false,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        // 2. Se houver responsável ou prazo, criar a tarefa associada
        const owner = ownerInput.value.trim();
        const dueDate = dueDateInput.value;
        if (owner || dueDate) {
            const contractDoc = await db.collection('contratos').doc(contractId).get();
            const contractData = contractDoc.data();
            
            await db.collection('tarefas').add({
                title: description,
                owner: owner,
                dueDate: dueDate,
                priority: 'Média',
                status: 'Pendente',
                clientId: contractData.clientId || '',
                contractId: contractId,
            });
            // Atualizar a lista de tarefas em background
            loadTasks();
            loadDashboardData();
        }

        // Limpar os campos do formulário
        descInput.value = '';
        ownerInput.value = '';
        dueDateInput.value = '';
        
        // Recarregar a lista de etapas
        loadMilestones(contractId, 'milestonesList');
    }

    async function toggleMilestone(contractId, milestoneId, isCompleted) {
        await db.collection('contratos').doc(contractId).collection('milestones').doc(milestoneId).update({
            completed: isCompleted
        });
        loadMilestones(contractId, 'milestonesList');
    }

    // --- WIDGET DE CONTROLO DE DOCUMENTOS ---
    async function loadDocumentTrackingWidget() {
        const container = document.getElementById('documentTrackingList');
        container.innerHTML = '<p>A procurar propostas pendentes...</p>';

        const snapshot = await db.collection('contratos').where('type', '==', 'Crédito').get();
        
        const pendingContracts = [];
        snapshot.forEach(doc => {
            const data = doc.data();
            if (!data.dataEntregaFornecedor || !data.dataEntregaFinanceira) {
                pendingContracts.push({ id: doc.id, ...data });
            }
        });

        if (pendingContracts.length === 0) {
            container.innerHTML = '<p>Nenhuma entrega de documentos pendente.</p>';
            return;
        }

        container.innerHTML = '';
        const docList = ["Livrete", "Contrato", "DUA", "DAV", "MUA de compra", "MUA de venda", "Extinção de reserva"];
        
        pendingContracts.forEach(contract => {
            const fornecedorName = partnersData.fornecedores[contract.fornecedorId] || 'N/D';
            const financeiraName = partnersData.financeiras[contract.financeiraId] || 'N/D';

            let checklistFornecedorHTML = docList.map(doc => `
                <label><input type="checkbox" onchange="updateContractChecklistFromDashboard('${contract.id}', 'checklistDocsFornecedor', '${doc}', this.checked)" 
                ${(contract.checklistDocsFornecedor || []).includes(doc) ? 'checked' : ''}> ${doc}</label>
            `).join('');
            let checklistFinanceiraHTML = docList.map(doc => `
                <label><input type="checkbox" onchange="updateContractChecklistFromDashboard('${contract.id}', 'checklistDocsFinanceira', '${doc}', this.checked)"
                ${(contract.checklistDocsFinanceira || []).includes(doc) ? 'checked' : ''}> ${doc}</label>
            `).join('');

            const item = document.createElement('details');
            item.className = 'doc-tracking-item';
            item.innerHTML = `
                <summary>
                    <span>Proposta #${contract.numeroProposta || 'N/A'}</span>
                    <span>${fornecedorName} <i class="ph ph-arrow-right"></i> ${financeiraName}</span>
                </summary>
                <div class="doc-tracking-body">
                    <div>
                        <h5><i class="ph ph-download-simple"></i> Fornecedor -> THE WAY</h5>
                        <input type="date" value="${contract.dataEntregaFornecedor || ''}" onchange="updateContractFromDashboard('${contract.id}', 'dataEntregaFornecedor', this.value)">
                        <div class="checklist">${checklistFornecedorHTML}</div>
                    </div>
                    <div>
                        <h5><i class="ph ph-upload-simple"></i> THE WAY -> Financeira</h5>
                        <input type="date" value="${contract.dataEntregaFinanceira || ''}" onchange="updateContractFromDashboard('${contract.id}', 'dataEntregaFinanceira', this.value)">
                        <div class="checklist">${checklistFinanceiraHTML}</div>
                    </div>
                </div>
            `;
            container.appendChild(item);
        });
    }

    async function updateContractFromDashboard(contractId, field, value) {
        const updateData = {};
        updateData[field] = value;
        await db.collection('contratos').doc(contractId).update(updateData);
        
        const doc = await db.collection('contratos').doc(contractId).get();
        const data = doc.data();
        if (data.dataEntregaFornecedor && data.dataEntregaFinanceira) {
            loadDocumentTrackingWidget();
        }
    }

    async function updateContractChecklistFromDashboard(contractId, field, docName, isChecked) {
        const docRef = db.collection('contratos').doc(contractId);
        if (isChecked) {
            await docRef.update({
                [field]: firebase.firestore.FieldValue.arrayUnion(docName)
            });
        } else {
            await docRef.update({
                [field]: firebase.firestore.FieldValue.arrayRemove(docName)
            });
        }
    }

  </script>
</body>
</html>
