<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>THE WAY - Gestão</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', Arial, sans-serif; background: #f6f4f2; margin: 0; color: #222; }
    header { background: #fff3e0; padding: 18px 0; text-align: center; border-bottom: 2px solid #e1d3b7; }
    h1 { font-weight: 600; font-size: 1.5rem; color: #a4703a; letter-spacing: 2px; }
    .container { max-width: 1000px; margin: 26px auto; background: #fff; border-radius: 12px; box-shadow: 0 4px 18px #0001; padding: 22px 14px 32px 14px; }
    nav { margin-bottom: 18px; display: flex; gap: 10px; }
    nav button { border: none; background: #f6f4f2; color: #a4703a; font-weight: bold; padding: 9px 16px; border-radius: 7px; cursor: pointer; }
    nav button.active, nav button:hover { background: #a4703a; color: #fff; }
    .dashboard { display: flex; gap: 18px; margin-bottom: 16px; flex-wrap: wrap;}
    .card { background: #fffbf4; border: 1px solid #e1d3b7; border-radius: 10px; padding: 13px 17px; min-width: 120px; flex: 1; text-align: center; }
    .card h2 { font-size: 2rem; margin: 0 0 2px; color: #ba882c;}
    .card p { margin: 0; font-size: 0.95rem; color: #7d7056; }
    .actions { margin-bottom: 8px; text-align: right;}
    .actions button { background: #a4703a; color: #fff; border: none; padding: 9px 15px; border-radius: 7px; cursor: pointer; font-size: 0.96rem; margin-left: 7px; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; background: #fff; }
    th, td { border-bottom: 1px solid #e5ded6; padding: 9px 7px; text-align: left; font-size: 0.95rem; }
    th { background: #fff3e0; color: #a4703a; font-weight: 600; }
    tr:last-child td { border-bottom: none; }
    tr:hover { background: #f6f4f2; }
    .btn-sm { padding: 2px 8px; border-radius: 5px; border: none; background: #f6f4f2; color: #a4703a; cursor: pointer; font-size: 0.93rem; margin-right: 2px; }
    .btn-sm.edit { background: #f5e1b6;}
    .btn-sm.del { background: #f9cfc5; color: #be2418;}
    .modal-bg { display: none; position: fixed; top:0; left:0; width:100vw; height:100vh; background: #2227; align-items: center; justify-content: center; z-index: 100;}
    .modal { background: #fff; border-radius: 12px; box-shadow: 0 10px 30px #0004; padding: 30px 32px; max-width: 380px; width: 95vw; position: relative; }
    .modal-close { position: absolute; top: 11px; right: 14px; font-size: 1.3rem; background: none; border: none; cursor: pointer; color: #be2418;}
    .modal label { display: block; margin-top: 12px; color: #a4703a;}
    .modal input, .modal select, .modal textarea { width: 100%; margin-top: 4px; padding: 8px; font-size: 1rem; border-radius: 7px; border: 1px solid #e1d3b7; background: #fffbf4;}
    .modal button[type="submit"] { margin-top: 15px; background: #a4703a; color: #fff; border: none; border-radius: 7px; padding: 10px 18px; font-size: 1rem; cursor: pointer; width: 100%;}
    @media (max-width:700px) {
      .container { padding: 4px 1px; }
      .dashboard { flex-direction: column; gap: 10px;}
      .modal { max-width:95vw; padding: 12px 5px;}
    }
  </style>
</head>
<body>
  <header>
    <h1>THE WAY Gestão</h1>
  </header>
  <div class="container">
    <div class="dashboard" id="dashboard"></div>
    <nav>
      <button id="btnClientes" class="active">Clientes</button>
      <button id="btnContratos">Contratos</button>
      <button id="btnPendentes">Pendentes</button>
    </nav>
    <div class="actions" id="actions"></div>
    <div id="mainArea"></div>
  </div>
  <div class="modal-bg" id="modalBg">
    <form class="modal" id="modalForm">
      <button class="modal-close" id="closeModal" type="button">&times;</button>
      <div id="modalFields"></div>
      <button type="submit" id="modalSubmitBtn">Guardar</button>
    </form>
  </div>
  <script type="module">
    // FIREBASE SDK
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
    import { getFirestore, collection, getDocs, addDoc, updateDoc, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

    // ======= TROCA ISTO PELA TUA API KEY!!! =======
    const firebaseConfig = {
      apiKey: "AQUI_A_TUA_KEY",
      authDomain: "tw25-1dbb3.firebaseapp.com",
      projectId: "tw25-1dbb3",
      storageBucket: "tw25-1dbb3.firebasestorage.app",
      messagingSenderId: "995776920444",
      appId: "1:995776920444:web:7866264b9f4d74bedac2f9"
    };
    // ===============================================

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- Helpers básicos ---
    function el(id){ return document.getElementById(id); }
    function $(q){ return document.querySelector(q);}
    function setActiveTab(tab){
      btnClientes.classList.remove('active'); btnContratos.classList.remove('active'); btnPendentes.classList.remove('active');
      if(tab==="clientes") btnClientes.classList.add('active');
      if(tab==="contratos") btnContratos.classList.add('active');
      if(tab==="pendentes") btnPendentes.classList.add('active');
    }

    // =========== DASHBOARD ===========
    async function loadDashboard(){
      const cs = await getDocs(collection(db, "clientes"));
      const ks = await getDocs(collection(db, "contratos"));
      const ps = await getDocs(collection(db, "pendentes"));
      el("dashboard").innerHTML = `
        <div class="card"><h2>${cs.size}</h2><p>Clientes</p></div>
        <div class="card"><h2>${ks.size}</h2><p>Contratos</p></div>
        <div class="card"><h2>${ps.size}</h2><p>Pendentes</p></div>
      `;
    }

    // =========== CLIENTES ===========
    async function loadClientes(){
      setActiveTab("clientes");
      loadDashboard();
      el("actions").innerHTML = `<button onclick="openClienteModal()">+ Cliente</button>`;
      const snap = await getDocs(collection(db, "clientes"));
      let html = `<table><tr><th>Nome</th><th>NIF</th><th>Morada</th><th>Data Nasc.</th><th>Tel.</th><th>Email</th><th>Ações</th></tr>`;
      snap.forEach(docu=>{
        const d = docu.data();
        html += `<tr>
          <td>${d.nome||""}</td>
          <td>${d.nif||""}</td>
          <td>${d.morada||""}</td>
          <td>${d.dataNascimento||""}</td>
          <td><a href="tel:${d.telefone||""}">${d.telefone||""}</a></td>
          <td><a href="mailto:${d.email||""}">${d.email||""}</a></td>
          <td>
            <button class="btn-sm edit" onclick="openClienteModal('${docu.id}', true)">Editar</button>
            <button class="btn-sm del" onclick="delCliente('${docu.id}')">Apagar</button>
          </td>
        </tr>`;
      });
      html += `</table>`;
      el("mainArea").innerHTML = html;
    }

    // =========== CONTRATOS ===========
    async function loadContratos(){
      setActiveTab("contratos");
      loadDashboard();
      el("actions").innerHTML = `<button onclick="openContratoModal()">+ Contrato</button>`;
      const snap = await getDocs(collection(db, "contratos"));
      let html = `<table><tr><th>Cliente</th><th>Tipo</th><th>Valor</th><th>Data</th><th>Comercial</th><th>Pendente?</th><th>Ações</th></tr>`;
      snap.forEach(docu=>{
        const d = docu.data();
        html += `<tr>
          <td>${d.clienteNome||""}</td>
          <td>${d.tipo||""}</td>
          <td>${d.valor||""}</td>
          <td>${d.data||""}</td>
          <td>${d.comercial||"Andreia Costa"}</td>
          <td>${d.pendente?"Sim":"Não"}</td>
          <td>
            <button class="btn-sm edit" onclick="openContratoModal('${docu.id}', true)">Editar</button>
            <button class="btn-sm del" onclick="delContrato('${docu.id}')">Apagar</button>
          </td>
        </tr>`;
      });
      html += `</table>`;
      el("mainArea").innerHTML = html;
    }

    // =========== PENDENTES ===========
    async function loadPendentes(){
      setActiveTab("pendentes");
      loadDashboard();
      const snap = await getDocs(collection(db, "pendentes"));
      let html = `<table><tr><th>Contrato</th><th>Documento</th><th>Estado</th></tr>`;
      snap.forEach(docu=>{
        const d = docu.data();
        html += `<tr>
          <td>${d.contrato||""}</td>
          <td>${d.doc||""}</td>
          <td>${d.resolvido?"Resolvido":"Pendente"}</td>
        </tr>`;
      });
      html += `</table>`;
      el("actions").innerHTML = "";
      el("mainArea").innerHTML = html;
    }

    // =========== MODAIS ===========
    window.openClienteModal = async function(id, edit=false){
      el("modalBg").style.display = "flex";
      let d = {nome:"",nif:"",morada:"",dataNascimento:"",telefone:"",email:""};
      if(edit) {
        const snap = await getDocs(collection(db,"clientes"));
        snap.forEach(docu=>{ if(docu.id===id) d=docu.data(); });
      }
      el("modalFields").innerHTML = `
        <label>Nome<input value="${d.nome||""}" id="f_nome"></label>
        <label>NIF<input value="${d.nif||""}" id="f_nif"></label>
        <label>Morada<input value="${d.morada||""}" id="f_morada"></label>
        <label>Data Nasc.<input type="date" value="${d.dataNascimento||""}" id="f_dataNascimento"></label>
        <label>Telefone<input value="${d.telefone||""}" id="f_telefone"></label>
        <label>Email<input type="email" value="${d.email||""}" id="f_email"></label>
      `;
      el("modalSubmitBtn").onclick = async function(ev){
        ev.preventDefault();
        let novo = {
          nome: el("f_nome").value, nif: el("f_nif").value, morada: el("f_morada").value,
          dataNascimento: el("f_dataNascimento").value, telefone: el("f_telefone").value, email: el("f_email").value
        };
        if(edit) {
          // Atualizar
          const snap = await getDocs(collection(db,"clientes"));
          snap.forEach(async docu=>{ if(docu.id===id) await updateDoc(doc(db,"clientes",id), novo); });
        } else {
          // Novo
          await addDoc(collection(db,"clientes"), novo);
        }
        el("modalBg").style.display = "none";
        loadClientes();
      };
    };

    window.openContratoModal = async function(id, edit=false){
      el("modalBg").style.display = "flex";
      let d = {clienteNome:"",tipo:"",valor:"",data:"",comercial:"Andreia Costa",pendente:false};
      if(edit) {
        const snap = await getDocs(collection(db,"contratos"));
        snap.forEach(docu=>{ if(docu.id===id) d=docu.data(); });
      }
      el("modalFields").innerHTML = `
        <label>Cliente<input value="${d.clienteNome||""}" id="f_clienteNome"></label>
        <label>Tipo
          <select id="f_tipo">
            <option value="Crédito Habitação" ${d.tipo==="Crédito Habitação"?"selected":""}>Crédito Habitação</option>
            <option value="Crédito Automóvel" ${d.tipo==="Crédito Automóvel"?"selected":""}>Crédito Automóvel</option>
            <option value="Crédito ao Consumo" ${d.tipo==="Crédito ao Consumo"?"selected":""}>Crédito ao Consumo</option>
            <option value="Seguro Automóvel" ${d.tipo==="Seguro Automóvel"?"selected":""}>Seguro Automóvel</option>
            <option value="Seguro Vida" ${d.tipo==="Seguro Vida"?"selected":""}>Seguro Vida</option>
          </select>
        </label>
        <label>Valor<input value="${d.valor||""}" id="f_valor"></label>
        <label>Data<input type="date" value="${d.data||""}" id="f_data"></label>
        <label>Comercial<input value="${d.comercial||"Andreia Costa"}" id="f_comercial"></label>
        <label>Pendente
          <select id="f_pendente">
            <option value="false" ${d.pendente===false?"selected":""}>Não</option>
            <option value="true" ${d.pendente===true?"selected":""}>Sim</option>
          </select>
        </label>
      `;
      el("modalSubmitBtn").onclick = async function(ev){
        ev.preventDefault();
        let novo = {
          clienteNome: el("f_clienteNome").value, tipo: el("f_tipo").value, valor: el("f_valor").value,
          data: el("f_data").value, comercial: el("f_comercial").value, pendente: el("f_pendente").value==="true"
        };
        if(edit) {
          const snap = await getDocs(collection(db,"contratos"));
          snap.forEach(async docu=>{ if(docu.id===id) await updateDoc(doc(db,"contratos",id), novo); });
        } else {
          await addDoc(collection(db,"contratos"), novo);
        }
        el("modalBg").style.display = "none";
        loadContratos();
      };
    };

    window.delCliente = async function(id){
      if(confirm("Apagar cliente?")) {
        await deleteDoc(doc(db,"clientes",id));
        loadClientes();
      }
    };
    window.delContrato = async function(id){
      if(confirm("Apagar contrato?")) {
        await deleteDoc(doc(db,"contratos",id));
        loadContratos();
      }
    };

    // Fechar modal
    el("closeModal").onclick = ()=>el("modalBg").style.display="none";

    // NAVIGATION
    btnClientes.onclick = loadClientes;
    btnContratos.onclick = loadContratos;
    btnPendentes.onclick = loadPendentes;

    // Inicial
    loadClientes();

  </script>
</body>
</html>

